<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè­°è­°äº‹éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Enhanced</title>
    <!-- Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; 
            background: #f5f7fa; 
            min-height: 100vh;
            word-wrap: break-word;
            overflow-wrap: break-word;
            -webkit-text-size-adjust: 100%;
        }
        
        /* Header */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .user-info { text-align: right; font-size: 13px; }
        .logout-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        
        /* Breadcrumb */
        .breadcrumb { display: flex; gap: 10px; margin-bottom: 20px; font-size: 14px; color: #666; flex-wrap: wrap; }
        .breadcrumb-item { cursor: pointer; transition: color 0.3s; }
        .breadcrumb-item:hover { color: #667eea; }
        .breadcrumb-item.active { color: #333; font-weight: 600; }
        .breadcrumb-separator { color: #999; }
        
        /* Card */
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px; justify-content: space-between; }
        
        /* Organization Tree */
        .org-tree { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .org-item { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }
        .org-item:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); }
        .org-item-title { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        .org-item-count { 
            font-size: 13px; 
            opacity: 0.9;
            word-wrap: break-word;
        }
        
        /* Hierarchical Organization Tree */
        .org-hierarchy { display: flex; flex-direction: column; gap: 25px; }
        .org-level { margin-bottom: 15px; }
        .org-level-title { font-size: 14px; font-weight: 600; color: #667eea; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #667eea; text-transform: uppercase; letter-spacing: 0.5px; }
        .org-section { margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .org-section-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; padding-left: 10px; border-left: 4px solid #667eea; }
        .sub-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 15px; padding-left: 20px; }
        
        /* Meeting List */
        .meeting-list { display: flex; flex-direction: column; gap: 12px; }
        .meeting-item { background: #f8f9fa; padding: 18px; border-radius: 8px; cursor: pointer; transition: background 0.2s, transform 0.2s; border-left: 4px solid #667eea; }
        .meeting-item:hover { background: #e9ecef; transform: translateX(5px); }
        .meeting-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; }
        .meeting-meta { display: flex; gap: 20px; font-size: 13px; color: #666; flex-wrap: wrap; }
        
        /* Minutes Table */
        .minutes-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .minutes-table th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #dee2e6; }
        .minutes-table td { padding: 12px; border-bottom: 1px solid #e9ecef; }
        .minutes-table tr { cursor: pointer; transition: background 0.2s; }
        .minutes-table tbody tr:hover { background: #f8f9fa; }
        
        /* Status Badge */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-not-held { background: #fff3cd; color: #856404; }  /* ã‚ªãƒ¬ãƒ³ã‚¸ */
        .badge-completed-with-tasks { background: #f8d7da; color: #842029; }  /* èµ¤ */
        .badge-completed-no-tasks { background: #e3f2fd; color: #1565c0; }  /* é’ */
        /* æ—§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰ */
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-progress { background: #cfe2ff; color: #084298; }
        .badge-completed { background: #d1e7dd; color: #0f5132; }
        .badge-overdue { background: #f8d7da; color: #842029; }
        .badge-archived { background: #6c757d; color: white; }
        
        /* Inline Edit */
        .inline-edit:hover {
            background: #f0f8ff !important;
            outline: 1px solid #667eea;
        }
        .inline-edit:focus {
            background: #fff !important;
            outline: 2px solid #667eea;
        }
        .inline-edit[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #999;
        }
        .status-dropdown {
            transition: all 0.2s;
        }
        .status-dropdown:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        .save-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
            opacity: 0;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s; font-weight: 600; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px; }
        .action-btns { display: flex; gap: 10px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; animation: fadeIn 0.2s ease-in-out; }
        .modal-content { 
            background: white; 
            border-radius: 10px; 
            padding: 0;
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        .modal-header-sticky {
            position: sticky;
            top: 0;
            background: white;
            padding: 20px 30px 15px 30px;
            border-bottom: 2px solid #667eea;
            z-index: 10;
            border-radius: 10px 10px 0 0;
        }
        .modal-title { 
            font-size: 20px; 
            font-weight: 600; 
            margin-bottom: 15px; 
            color: #333;
        }
        .modal-actions-top {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        #minuteForm {
            padding: 20px 30px 30px 30px;
            flex: 1;
            overflow-y: auto;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #333;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 14px; 
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            outline: none; 
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Detail View */
        .detail-section { margin-bottom: 25px; }
        .detail-section-title { font-size: 14px; font-weight: 600; color: #667eea; margin-bottom: 10px; text-transform: uppercase; }
        .detail-content { background: #f8f9fa; padding: 15px; border-radius: 6px; line-height: 1.6; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .detail-item { display: flex; flex-direction: column; gap: 5px; }
        .detail-label { font-size: 12px; color: #666; font-weight: 600; }
        .detail-value { font-size: 14px; color: #333; }
        
        /* Login Page */
        .login-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
        .login-title { text-align: center; font-size: 24px; margin-bottom: 10px; color: #333; }
        .login-subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .login-btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        .login-btn:hover:not(:disabled) { background: #5568d3; }
        .login-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .alert { padding: 12px; border-radius: 5px; margin-bottom: 20px; font-size: 14px; }
        .alert-error { background: #fee; border: 1px solid #fcc; color: #c33; }
        .alert-success { background: #efe; border: 1px solid #cfc; color: #3c3; }
        .demo-info { text-align: center; margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; font-size: 13px; color: #666; }
        .demo-info code { background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 48px; margin-bottom: 15px; }
        
        /* Editable Table */
        .editable-table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        .editable-table th { background-color: #4A90E2; color: white; padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; }
        .editable-table td { padding: 8px; border: 1px solid #ddd; }
        .editable-cell { cursor: text; transition: background-color 0.2s; }
        .editable-cell:hover { background-color: #f0f8ff; }
        .editable-cell:focus { outline: 2px solid #4A90E2; outline-offset: -2px; background-color: #fff; }
        .editable-row:nth-child(even) { background-color: #f9f9f9; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        
        /* ============================================
           ğŸ“± ã‚¹ãƒãƒ›å¯¾å¿œ - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
           ============================================ */
        @media screen and (max-width: 768px) {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
            .header { 
                padding: 12px 15px; 
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            .header h1 { 
                font-size: 16px; 
                text-align: center;
                cursor: pointer;
            }
            .user-section { 
                justify-content: space-between;
                font-size: 12px;
            }
            .user-info { font-size: 11px; }
            .logout-btn { 
                padding: 6px 12px; 
                font-size: 12px;
            }
            
            /* ã‚³ãƒ³ãƒ†ãƒŠ - ä½™ç™½å‰Šæ¸› */
            .container { 
                padding: 15px 10px; 
            }
            
            /* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ */
            .breadcrumb { 
                font-size: 12px;
                gap: 5px;
            }
            
            /* ã‚«ãƒ¼ãƒ‰ */
            .card { 
                padding: 15px; 
                border-radius: 8px;
                margin-bottom: 15px;
            }
            .card-title { 
                font-size: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                word-break: keep-all;
                overflow-wrap: break-word;
                line-height: 1.5;
            }
            
            /* çµ„ç¹”ãƒ„ãƒªãƒ¼ - 1ã‚«ãƒ©ãƒ è¡¨ç¤º */
            .org-tree { 
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .org-item { 
                padding: 14px 16px;
                touch-action: manipulation;
                min-height: auto;
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 12px;
            }
            .org-item-title { 
                font-size: 15px;
                line-height: 1.4;
                word-break: keep-all;
                overflow-wrap: anywhere;
                flex: 1;
                max-height: 2.8em;
                overflow: hidden;
                text-overflow: ellipsis;
                display: block;
            }
            .org-item-count { 
                font-size: 12px;
                margin-top: 4px;
                opacity: 0.95;
                white-space: nowrap;
            }
            
            /* ã‚µãƒ–ã‚¢ã‚¤ãƒ†ãƒ  - 1ã‚«ãƒ©ãƒ  */
            .sub-items { 
                grid-template-columns: 1fr;
                padding-left: 10px;
                gap: 10px;
            }
            
            /* è­°äº‹éŒ²ãƒªã‚¹ãƒˆ */
            .meeting-list { gap: 10px; }
            .meeting-item { 
                padding: 15px;
                touch-action: manipulation;
            }
            .meeting-title { font-size: 15px; }
            .meeting-meta { 
                font-size: 12px;
                gap: 10px;
                flex-direction: column;
            }
            
            /* ãƒ†ãƒ¼ãƒ–ãƒ« â†’ ã‚«ãƒ¼ãƒ‰å½¢å¼ */
            .minutes-table { 
                border: 0;
                font-size: 13px;
            }
            .minutes-table thead { 
                display: none; 
            }
            .minutes-table tbody {
                display: block;
            }
            .minutes-table tr { 
                display: block;
                margin-bottom: 15px;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 12px;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                touch-action: manipulation;
            }
            .minutes-table td { 
                display: block;
                text-align: left;
                padding: 10px 0;
                border: none;
                border-bottom: 1px solid #f0f0f0;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.6;
            }
            .minutes-table td:last-child {
                border-bottom: none;
            }
            .minutes-table td::before { 
                content: attr(data-label);
                font-weight: 600;
                color: #667eea;
                display: block;
                margin-bottom: 6px;
                font-size: 12px;
                word-break: keep-all;
            }
            
            /* ç·¨é›†å¯èƒ½ãƒ†ãƒ¼ãƒ–ãƒ« - ã‚«ãƒ¼ãƒ‰å½¢å¼ */
            .editable-table thead {
                display: none;
            }
            .editable-table tbody {
                display: block;
            }
            .editable-table tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 12px;
                background: white;
            }
            .editable-table td {
                display: block;
                padding: 10px 0;
                border: none;
                border-bottom: 1px solid #f0f0f0;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.6;
            }
            .editable-table td:last-child {
                border-bottom: none;
            }
            .editable-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #4A90E2;
                display: block;
                margin-bottom: 6px;
                font-size: 12px;
                word-break: keep-all;
            }
            .editable-table .editable-cell {
                min-height: 40px;
                padding: 8px;
                background: #f8f9fa;
                border-radius: 4px;
                margin-top: 4px;
            }
            
            /* ãƒœã‚¿ãƒ³ - ã‚¿ãƒƒãƒå¯¾å¿œ */
            .btn { 
                padding: 12px 18px;
                font-size: 14px;
                min-height: 44px;
                touch-action: manipulation;
            }
            .btn-sm {
                padding: 8px 12px;
                min-height: 36px;
            }
            .action-btns { 
                flex-direction: column;
                gap: 8px;
            }
            .action-btns .btn {
                width: 100%;
            }
            
            /* ãƒ¢ãƒ¼ãƒ€ãƒ« - å…¨ç”»é¢è¡¨ç¤º */
            .modal { 
                padding: 0;
            }
            .modal-content { 
                max-width: 100%;
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                padding: 0;
            }
            .modal-header-sticky {
                padding: 16px;
                border-radius: 0;
            }
            .modal-title { 
                font-size: 17px;
                margin-bottom: 12px;
            }
            .modal-actions-top {
                flex-direction: row;
                gap: 8px;
            }
            .modal-actions-top .btn {
                flex: 1;
                min-height: 44px;
                font-size: 14px;
            }
            #minuteForm {
                padding: 16px;
            }
            .modal-actions {
                display: none !important;
            }
            
            /* ãƒ•ã‚©ãƒ¼ãƒ  */
            .form-group { 
                margin-bottom: 18px; 
            }
            .form-group label { 
                font-size: 14px;
                font-weight: 600;
                color: #333;
                margin-bottom: 8px;
            }
            .form-group input, 
            .form-group textarea, 
            .form-group select { 
                padding: 13px 12px;
                font-size: 16px; /* iOS zoomé˜²æ­¢ */
                min-height: 48px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                transition: border-color 0.2s;
            }
            .form-group input:focus,
            .form-group textarea:focus,
            .form-group select:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            .form-group textarea {
                min-height: 120px;
                line-height: 1.5;
            }
            .form-group small {
                font-size: 12px;
                color: #666;
                margin-top: 6px;
                display: block;
            }
            
            /* è©³ç´°ã‚°ãƒªãƒƒãƒ‰ - 1ã‚«ãƒ©ãƒ  */
            .detail-grid { 
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .detail-section { 
                margin-bottom: 20px; 
            }
            .detail-content { 
                padding: 12px;
                font-size: 14px;
            }
            
            /* ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ */
            .login-box { 
                padding: 30px 20px;
                margin: 0;
                max-width: 100%;
                border-radius: 0;
            }
            .login-title { 
                font-size: 20px; 
            }
            .login-subtitle { 
                font-size: 13px; 
            }
            .demo-info { 
                font-size: 12px;
                padding: 12px;
            }
            
            /* Empty State */
            .empty-state { 
                padding: 40px 20px; 
            }
            .empty-state-icon { 
                font-size: 36px; 
            }
            
            /* çµ„ç¹”éšå±¤ */
            .org-section { 
                padding: 15px;
                margin-bottom: 20px;
            }
            .org-section-title { 
                font-size: 15px;
                margin-bottom: 12px;
            }
            .org-level-title { 
                font-size: 13px;
                margin-bottom: 12px;
            }
            
            /* ãƒãƒƒã‚¸ */
            .badge { 
                padding: 5px 10px;
                font-size: 11px;
            }
            
            /* ã‚¿ãƒƒãƒæ“ä½œã®æ”¹å–„ */
            * {
                -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
            }
            
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€é©åŒ– */
            body {
                -webkit-overflow-scrolling: touch;
            }
            
            /* AIè§£æç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
            #minutesText {
                min-height: 200px;
                font-size: 16px;
            }
            
            /* ä¼šè­°ãƒªã‚¹ãƒˆ - ãƒ˜ãƒƒãƒ€ãƒ¼éè¡¨ç¤ºã€ã‚«ãƒ¼ãƒ‰å½¢å¼ */
            .meeting-list-header {
                display: none !important;
            }
            
            .meeting-list-row {
                display: block !important;
                padding: 14px !important;
                margin-bottom: 12px !important;
                border-radius: 8px !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.08) !important;
            }
            
            .meeting-list-row > div {
                display: block !important;
                padding: 6px 0 !important;
                border-bottom: 1px solid #f0f0f0;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .meeting-list-row > div:last-child {
                border-bottom: none;
                padding-top: 12px !important;
            }
            
            .meeting-list-row > div:nth-child(1)::before {
                content: "ä¼šè­°æ—¥: ";
                font-weight: 600;
                color: #667eea;
                display: inline;
                margin-right: 6px;
            }
            
            .meeting-list-row > div:nth-child(2)::before {
                content: "ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«: ";
                font-weight: 600;
                color: #667eea;
                display: block;
                margin-bottom: 4px;
            }
            
            .meeting-list-row > div:nth-child(3)::before {
                content: "å‚åŠ è€…: ";
                font-weight: 600;
                color: #667eea;
                display: block;
                margin-bottom: 4px;
            }
            
            .meeting-list-row > div:nth-child(4)::before {
                content: "ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼: ";
                font-weight: 600;
                color: #667eea;
                display: block;
                margin-bottom: 4px;
            }
            
            .meeting-list-row > div:nth-child(5)::before {
                content: "å‚™è€ƒ: ";
                font-weight: 600;
                color: #667eea;
                display: block;
                margin-bottom: 4px;
            }
            
            .meeting-list-row > div:nth-child(6)::before {
                content: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ";
                font-weight: 600;
                color: #667eea;
                display: block;
                margin-bottom: 4px;
            }
            
            .meeting-list-row > div:last-child {
                display: flex !important;
                flex-direction: column;
                gap: 8px;
            }
            
            .meeting-list-row > div:last-child::before {
                content: "æ“ä½œ";
                font-weight: 600;
                color: #667eea;
                display: block;
                margin-bottom: 6px;
            }
            
            .meeting-list-row button {
                width: 100% !important;
                padding: 10px !important;
                font-size: 14px !important;
            }
            
            /* çµ„ç¹”ã‚¢ã‚¤ãƒ†ãƒ ã®gridãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸Šæ›¸ãï¼ˆé‡è¦ï¼ï¼‰ */
            .org-item[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 10px !important;
                padding: 14px !important;
                align-items: flex-start !important;
            }
            
            /* çµ„ç¹”ã‚¢ã‚¤ãƒ†ãƒ ã®å†…éƒ¨è¦ç´ ã‚‚æ¨ªä¸¦ã³ã« */
            .org-item > div {
                width: 100%;
            }
            
            /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¨ªä¸¦ã³ã« */
            .org-item > div:first-child {
                display: inline-block;
                width: auto;
                margin-right: 10px;
            }
            
            /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç¸¦ä¸¦ã³ã« */
            .org-item > div:last-child {
                display: flex;
                flex-direction: column;
                gap: 6px;
                width: 100%;
            }
            
            .org-item > div:last-child button {
                width: 100%;
                text-align: center;
            }
            
            /* éƒ¨é–€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚åŒæ§˜ã« */
            div[style*="grid-template-columns: 40px 1fr"] {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
                padding: 12px !important;
            }
        }
        
        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ (768px - 1024px) */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .org-tree { 
                grid-template-columns: repeat(2, 1fr);
            }
            .sub-items { 
                grid-template-columns: repeat(2, 1fr);
            }
            .detail-grid { 
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <!-- Initial Setup Page -->
    <div id="setupPage" class="login-container" style="display: none;">
        <div class="login-box" style="max-width: 500px;">
            <h1 class="login-title">ğŸ‰ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h1>
            <p class="login-subtitle">ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
            <div id="setupAlert"></div>
            <form id="setupForm">
                <div class="form-group">
                    <label for="setupEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                    <input type="email" id="setupEmail" placeholder="admin@ielove-partners.jp" required>
                    <small style="color: #666; font-size: 12px;">â€» @ielove-partners.jp ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ä½¿ç”¨å¯èƒ½</small>
                </div>
                <div class="form-group">
                    <label for="setupName">ãŠåå‰ *</label>
                    <input type="text" id="setupName" placeholder="å±±ç”° å¤ªéƒ" required>
                </div>
                <div class="form-group">
                    <label for="setupPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                    <input type="password" id="setupPassword" required>
                    <small style="color: #666; font-size: 12px;">â€» 8æ–‡å­—ä»¥ä¸Šã€å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ã‚’å«ã‚€</small>
                </div>
                <div class="form-group">
                    <label for="setupPasswordConfirm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª *</label>
                    <input type="password" id="setupPasswordConfirm" required>
                </div>
                <button type="submit" class="login-btn" id="setupBtn">ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
            </form>
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                <p style="margin: 0; font-size: 13px; color: #856404;">
                    âš ï¸ ã“ã®ç”»é¢ã¯æœ€åˆã®1å›ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå¾Œã¯äºŒåº¦ã¨è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚
                </p>
            </div>
        </div>
    </div>

    <!-- Email Verification Page -->
    <div id="verificationPage" class="login-container" style="display: none;">
        <div class="login-box">
            <h1 class="login-title">âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ç¢ºèª</h1>
            <p class="login-subtitle">ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <div id="verificationAlert"></div>
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: center;">
                <p style="margin: 0 0 5px 0; font-size: 13px; color: #1565c0;">ğŸ“§ ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ</p>
                <p style="margin: 0; font-size: 14px; font-weight: 600; color: #0d47a1;" id="verificationEmail"></p>
            </div>
            <form id="verificationForm">
                <div class="form-group">
                    <label for="verificationCode">ç¢ºèªã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰*</label>
                    <input type="text" id="verificationCode" maxlength="6" pattern="[0-9]{6}" placeholder="000000" required 
                           style="text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: 600;">
                </div>
                <button type="submit" class="login-btn" id="verifyBtn">ç¢ºèª</button>
                <button type="button" class="login-btn" onclick="app.resendVerificationCode()" 
                        style="margin-top: 10px; background: #6c757d;">
                    ğŸ“© ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡
                </button>
            </form>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="app.showSetupPage()" style="background: none; border: none; color: #667eea; cursor: pointer; text-decoration: underline;">â† æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1 class="login-title">ä¼šè­°è­°äº‹éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="login-subtitle">å…¨ç¤¾ãƒŠãƒ¬ãƒƒã‚¸å…±æœ‰ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="email" placeholder="your-email@ielove-partners.jp" required>
                </div>
                <div class="form-group">
                    <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            <div style="margin-top: 20px; text-align: center;">
                <a href="#" onclick="app.showRegistrationPage(); return false;" style="color: #667eea; text-decoration: none; font-size: 14px;">âœï¸ æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</a>
            </div>
        </div>
    </div>

    <!-- Registration Page -->
    <div id="registrationPage" class="login-container" style="display: none;">
        <div class="login-box" style="max-width: 500px;">
            <h1 class="login-title">âœï¸ æ–°è¦ç™»éŒ²</h1>
            <p class="login-subtitle">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
            <div id="registrationAlert"></div>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="regEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                    <input type="email" id="regEmail" placeholder="your-name@ielove-partners.jp" required>
                    <small style="color: #666; font-size: 12px;">â€» @ielove-partners.jp ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ä½¿ç”¨å¯èƒ½</small>
                </div>
                <div class="form-group">
                    <label for="regName">ãŠåå‰ *</label>
                    <input type="text" id="regName" placeholder="å±±ç”° å¤ªéƒ" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                    <input type="password" id="regPassword" required>
                    <small style="color: #666; font-size: 12px;">â€» 8æ–‡å­—ä»¥ä¸Šã€å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ã‚’å«ã‚€</small>
                </div>
                <div class="form-group">
                    <label for="regPasswordConfirm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª *</label>
                    <input type="password" id="regPasswordConfirm" required>
                </div>
                <button type="submit" class="login-btn" id="regBtn">ç™»éŒ²ç”³è«‹</button>
            </form>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="app.showLoginPage()" style="background: none; border: none; color: #667eea; cursor: pointer; text-decoration: underline;">â† ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</button>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px;">
                <p style="margin: 0; font-size: 13px; color: #1565c0;">
                    â„¹ï¸ ç™»éŒ²å¾Œã€ç®¡ç†è€…ã®æ‰¿èªãŒå¿…è¦ã§ã™ã€‚æ‰¿èªã•ã‚Œã‚‹ã¾ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã€‚
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <h1 id="headerLogo" style="cursor: pointer; transition: opacity 0.3s;">ğŸ“‹ ä¼šè­°è­°äº‹éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="user-section">
                <div class="user-info">
                    <div id="headerUserName"></div>
                    <div id="headerUserDept"></div>
                </div>
                <button id="adminMenuBtn" class="btn" onclick="app.showUserManagement()" style="margin-right: 10px; padding: 8px 16px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
                <button class="btn" onclick="showApiKeySettings()" style="margin-right: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">âš™ï¸ è¨­å®š</button>
                <button class="btn btn-warning" onclick="app.resetAllData()" style="margin-right: 10px; padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="logout-btn" onclick="app.logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <div class="container">
            <div class="breadcrumb" id="breadcrumb"></div>
            <div id="contentArea"></div>
        </div>
    </div>

    <!-- Edit/Add Minute Modal -->
    <div id="minuteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-sticky">
                <h2 class="modal-title" id="modalTitle">è­°äº‹éŒ²ã‚’è¿½åŠ </h2>
                <div class="modal-actions-top">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="app.submitMinuteForm()">ä¿å­˜</button>
                </div>
            </div>
            <form id="minuteForm">
                <div class="form-group">
                    <label for="minuteMeetingName">ä¼šè­°å *</label>
                    <input type="text" id="minuteMeetingName" required>
                </div>
                <div class="form-group">
                    <label for="minuteSubtitle">ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="minuteSubtitle">
                </div>
                <div class="form-group">
                    <label for="minuteMeetingDate">ä¼šè­°é–‹å‚¬æ—¥ *</label>
                    <input type="date" id="minuteMeetingDate" required>
                </div>
                <div class="form-group">
                    <label for="minuteParticipants">ä¼šè­°å‚åŠ è€… *</label>
                    <textarea id="minuteParticipants" required placeholder="å‚åŠ è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§30åï¼‰" rows="4"></textarea>
                    <small style="color: #666;">â€»æ”¹è¡Œã¾ãŸã¯ã€ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                </div>
                <div class="form-group">
                    <label for="minuteFacilitator">ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ *</label>
                    <input type="text" id="minuteFacilitator" required>
                </div>
                <div class="form-group">
                    <label for="minuteNotes">å‚™è€ƒ</label>
                    <textarea id="minuteNotes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="minuteStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                    <select id="minuteStatus" required>
                        <option value="not-held">ä¼šè­°æœªå®Ÿæ–½</option>
                        <option value="completed-with-tasks">ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼‰</option>
                        <option value="completed-no-tasks">ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ãªã—ï¼‰</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div id="aiAnalysisModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2 class="modal-title">ğŸ¤– AIè­°äº‹éŒ²è§£æ</h2>
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">è­°äº‹éŒ²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚AIãŒè‡ªå‹•çš„ã«è§£æã—ã¦ã€è­°é¡Œãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»æ‹…å½“è€…ç­‰ã‚’æŠ½å‡ºã—ã¾ã™ã€‚</p>
                
                <!-- File Upload -->
                <div style="margin-bottom: 15px;">
                    <label for="aiAnalysisFileUpload" class="btn btn-info" style="display: inline-block; cursor: pointer; margin: 0;">
                        ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (.txt, .docx)
                    </label>
                    <input type="file" id="aiAnalysisFileUpload" accept=".txt,.docx" style="display: none;" onchange="app.handleAIAnalysisFile(event)">
                    <span id="aiAnalysisFileName" style="margin-left: 10px; color: #666;"></span>
                </div>
                
                <!-- Text Input -->
                <div class="form-group">
                    <label for="aiAnalysisText">ã¾ãŸã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥å…¥åŠ›ï¼š</label>
                    <textarea id="aiAnalysisText" rows="12" placeholder="è­°äº‹éŒ²ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„..." style="font-family: monospace; font-size: 13px;"></textarea>
                </div>
                
                <!-- Progress -->
                <div id="aiAnalysisProgress" style="display: none; margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 4px; border-left: 4px solid #007bff;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;"></div>
                        <span id="aiAnalysisProgressText">AIè§£æä¸­...</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="app.closeAIAnalysisModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="app.startAIAnalysis()">ğŸ¤– AIè§£æé–‹å§‹</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>

    <!-- Mammoth.js for Word document reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        console.log('=== Script Loading Started ===');
        
        // Supabaseè¨­å®šã¨åˆæœŸåŒ–
        const SUPABASE_URL = 'https://kxgdolplxtnnozvzewzo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4Z2RvbHBseHRubm96dnpld3pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MTQyMjUsImV4cCI6MjA4NDI5MDIyNX0.7ViGgLtEWCeJbzGRg5PmELsaF_OGja1YopCQM6UbIXU';
        
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('âœ… Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†');
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
        let currentUser = null;
        
        // Supabaseèªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰
        (async function checkAuth() {
            try {
                console.log('ğŸ” Supabaseèªè¨¼ãƒã‚§ãƒƒã‚¯é–‹å§‹');
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    window.location.href = 'supabase-login.html';
                    return;
                }
                
                // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
                if (!session) {
                    console.log('âŒ æœªèªè¨¼ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                    window.location.href = 'supabase-login.html';
                    return;
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
                currentUser = session.user;
                console.log('âœ… èªè¨¼æ¸ˆã¿:', currentUser.email);
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                const userNameEl = document.getElementById('headerUserName');
                const userDeptEl = document.getElementById('headerUserDept');
                if (userNameEl) userNameEl.textContent = currentUser.email;
                if (userDeptEl) userDeptEl.textContent = 'Supabaseèªè¨¼æ¸ˆã¿';
                
                // Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
                await testSupabaseConnection();
                
            } catch (error) {
                console.error('âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                alert('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                window.location.href = 'supabase-login.html';
            }
        })();
        
        // Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testSupabaseConnection() {
            try {
                console.log('ğŸ”Œ Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
                
                // boardsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã¿ã‚‹
                const { data, error } = await supabase
                    .from('boards')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    console.error('âŒ Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
                
                console.log('âœ… Supabaseæ¥ç¶šæˆåŠŸï¼');
                console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª:', data);
                return true;
                
            } catch (error) {
                console.error('âŒ Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
                return false;
            }
        }
        
        const API_BASE_URL = 'https://3000-iyibqicmi9poa0s21x8jw-c81df28e.sandbox.novita.ai/api';
        
        // UUID v4 ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, 
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        const app = {
            currentUser: null,
            currentUserRole: null, // ğŸ” ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™
            currentView: 'organization',
            currentBoard: null,
            currentDepartment: null,
            currentTeam: null,
            currentMeeting: null,
            currentMinute: null,
            editingMinuteId: null,
            demoData: null,
            meetingsData: {}, // Store meetings data by entityId
            minutesData: {}, // Store minutes data by meetingId
            archivedMinutes: [], // Store archived minutes
            
            // ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ç”¨ãƒ‡ãƒ¼ã‚¿
            users: [], // ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
            pendingVerification: null, // ãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
            verificationCode: null, // ç¢ºèªã‚³ãƒ¼ãƒ‰
            accessLogs: [], // ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å®šæ•°
            USER_STATUS: {
                PENDING: 'pending',      // æ‰¿èªå¾…ã¡
                ACTIVE: 'active',        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ï¼‰
                SUSPENDED: 'suspended',  // åœæ­¢ä¸­ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸å¯ï¼‰
                REJECTED: 'rejected'     // æ‰¿èªæ‹’å¦
            },
            
            // å½¹å‰²å®šæ•°
            USER_ROLE: {
                ADMIN: 'admin',          // ç®¡ç†è€…
                USER: 'user',            // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
                VIEWER: 'viewer'         // é–²è¦§è€…
            },
            
            // è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³
            ALLOWED_DOMAIN: 'ielove-partners.jp',
            
            async init() {
                // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆçµ„ç¹”æ§‹é€ ï¼‰ã¯å¸¸ã«èª­ã¿è¾¼ã‚€
                this.loadDemoData();
                
                // ğŸ” ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’å–å¾—
                await this.loadCurrentUserRole();
                
                // ğŸ” æ¨©é™ã«å¿œã˜ã¦UIã‚’æ›´æ–°
                this.updateUIForRole();
                
                // Supabase + localStorageã‹ã‚‰ä¼šè­°ãƒ»è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                // âš ï¸ await ã§å¾…æ©Ÿã—ã¦ã‹ã‚‰UIã‚’è¡¨ç¤ºã™ã‚‹
                await this.loadAllData();
                
                // ğŸ” èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                this.loadAuthData();
                
                // èªè¨¼ãƒã‚§ãƒƒã‚¯
                this.checkAuth();
                this.setupEventListeners();
                this.setupInlineEditListeners();
            },
            
            navigateHome() {
                console.log('ğŸ  ========== navigateHome CALLED ==========');
                console.log('   Current view:', this.currentView);
                console.log('   Current board:', this.currentBoard);
                console.log('   Current department:', this.currentDepartment);
                console.log('   Current team:', this.currentTeam);
                
                // Reset navigation state
                this.currentView = 'organization';
                this.currentBoard = null;
                this.currentDepartment = null;
                this.currentTeam = null;
                this.currentMeeting = null;
                this.currentMinute = null;
                
                console.log('âœ… Navigation state reset');
                console.log('   Calling showOrganizationView()...');
                
                // Show organization view
                this.showOrganizationView();
                
                console.log('âœ… navigateHome COMPLETED');
                console.log('==========================================');
            },
            
            loadFromLocalStorage() {
                const savedMeetings = localStorage.getItem('meetingsData');
                const savedMinutes = localStorage.getItem('minutesData');
                
                if (savedMeetings) {
                    this.meetingsData = JSON.parse(savedMeetings);
                    console.log('Loaded meetings from localStorage:', this.meetingsData);
                }
                
                if (savedMinutes) {
                    this.minutesData = JSON.parse(savedMinutes);
                    console.log('Loaded minutes from localStorage:', this.minutesData);
                }
            },
            
            // ğŸš€ Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            async loadMeetingsFromSupabase() {
                console.log('ğŸ“¥ Supabaseã‹ã‚‰ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                
                try {
                    const { data, error } = await supabase
                        .from('meetings')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('âŒ ä¼šè­°ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                        return [];
                    }
                    
                    console.log('âœ… ä¼šè­°ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data.length, 'ä»¶');
                    return data;
                    
                } catch (error) {
                    console.error('âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', error);
                    return [];
                }
            },
            
            async loadMinutesFromSupabase() {
                console.log('ğŸ“¥ Supabaseã‹ã‚‰è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                
                try {
                    const { data, error } = await supabase
                        .from('meeting_minutes')
                        .select(`
                            *,
                            participants (*),
                            agenda_items (*),
                            tasks (*)
                        `)
                        .order('created_at', { ascending: false});
                    
                    if (error) {
                        console.error('âŒ è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                        return [];
                    }
                    
                    console.log('âœ… è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data.length, 'ä»¶');
                    return data;
                    
                } catch (error) {
                    console.error('âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', error);
                    return [];
                }
            },
            
            // ğŸ”„ çµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆSupabase + localStorageï¼‰
            async loadAllData() {
                console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆSupabaseå„ªå…ˆï¼‰...');
                
                try {
                    // Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const supabaseMeetings = await this.loadMeetingsFromSupabase();
                    const supabaseMinutes = await this.loadMinutesFromSupabase();
                    
                    // localStorageã‹ã‚‰ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»äº’æ›æ€§ã®ãŸã‚ï¼‰
                    const savedMeetings = localStorage.getItem('meetingsData');
                    const savedMinutes = localStorage.getItem('minutesData');
                    
                    const localMeetings = savedMeetings ? JSON.parse(savedMeetings) : {};
                    const localMinutes = savedMinutes ? JSON.parse(savedMinutes) : {};
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ï¼ˆSupabaseã‚’å„ªå…ˆï¼‰
                    if (supabaseMeetings.length > 0) {
                        // Supabaseãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        this.meetingsData = {};
                        supabaseMeetings.forEach(meeting => {
                            // entity_id ã‚’ä½¿ç”¨ï¼ˆ'board-1', 'dept-1', 'team-1-1' ãªã©ï¼‰
                            const entityId = meeting.entity_id;
                            
                            // entity_id ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                            if (!entityId) {
                                console.warn('âš ï¸ entity_id ãŒã‚ã‚Šã¾ã›ã‚“:', meeting);
                                return;
                            }
                            
                            if (!this.meetingsData[entityId]) {
                                this.meetingsData[entityId] = [];
                            }
                            this.meetingsData[entityId].push({
                                id: meeting.id,
                                entityId: meeting.entity_id,
                                meetingName: meeting.meeting_name || meeting.title,
                                name: meeting.meeting_name || meeting.title,
                                organization: meeting.organization,
                                division: meeting.division,
                                department: meeting.department,
                                date: meeting.meeting_date,
                                createdBy: meeting.created_by,
                                createdAt: meeting.created_at
                            });
                        });
                        console.log('âœ… Supabaseã‹ã‚‰ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', Object.keys(this.meetingsData));
                    } else {
                        // localStorageã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        this.meetingsData = localMeetings;
                        console.log('âœ… localStorageã‹ã‚‰ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    }
                    
                    if (supabaseMinutes.length > 0) {
                        // Supabaseãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        this.minutesData = {};
                        supabaseMinutes.forEach(minute => {
                            const meetingId = minute.meeting_id;
                            if (!this.minutesData[meetingId]) {
                                this.minutesData[meetingId] = [];
                            }
                            this.minutesData[meetingId].push({
                                id: minute.id,
                                meetingId: minute.meeting_id,
                                date: minute.date,
                                location: minute.location,
                                status: minute.status,
                                participants: minute.participants || [],
                                agendaItems: minute.agenda_items || [],
                                tasks: minute.tasks || [],
                                createdBy: minute.created_by,
                                createdAt: minute.created_at,
                                updatedAt: minute.updated_at
                            });
                        });
                        console.log('âœ… Supabaseã‹ã‚‰è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    } else {
                        // localStorageã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        this.minutesData = localMinutes;
                        console.log('âœ… localStorageã‹ã‚‰è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    }
                    
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
                    console.log('  - ä¼šè­°:', Object.keys(this.meetingsData).length, 'ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£');
                    console.log('  - è­°äº‹éŒ²:', Object.keys(this.minutesData).length, 'ä¼šè­°');
                    
                } catch (error) {
                    console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
                    this.loadFromLocalStorage();
                }
            },
            
            saveToLocalStorage() {
                localStorage.setItem('meetingsData', JSON.stringify(this.meetingsData));
                localStorage.setItem('minutesData', JSON.stringify(this.minutesData));
                console.log('Saved to localStorage');
            },
            
            // ğŸ” ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’å–å¾—
            async loadCurrentUserRole() {
                console.log('ğŸ” ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’å–å¾—ä¸­...');
                
                try {
                    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                    const { data: { user }, error: authError } = await supabase.auth.getUser();
                    
                    if (authError || !user) {
                        console.warn('âš ï¸ èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        this.currentUserRole = null;
                        return null;
                    }
                    
                    console.log('ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.email);
                    
                    // users ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ¨©é™æƒ…å ±ã‚’å–å¾—
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (userError) {
                        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', userError);
                        this.currentUserRole = 'viewer'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–²è¦§ã®ã¿
                        return 'viewer';
                    }
                    
                    if (userData) {
                        this.currentUserRole = userData.role;
                        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™:', userData.role);
                        console.log('ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', userData);
                        return userData.role;
                    } else {
                        console.warn('âš ï¸ users ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        this.currentUserRole = 'viewer'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–²è¦§ã®ã¿
                        return 'viewer';
                    }
                    
                } catch (error) {
                    console.error('âŒ æ¨©é™å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    this.currentUserRole = 'viewer'; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    return 'viewer';
                }
            },
            
            // ğŸ” æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
            canInsert() {
                // viewer ä»¥å¤–ã¯è¿½åŠ å¯èƒ½
                return this.currentUserRole && ['admin', 'editor_a', 'editor_b'].includes(this.currentUserRole);
            },
            
            canUpdate() {
                // viewer ä»¥å¤–ã¯ç·¨é›†å¯èƒ½
                return this.currentUserRole && ['admin', 'editor_a', 'editor_b'].includes(this.currentUserRole);
            },
            
            canDelete() {
                // admin ã¨ editor_a ã®ã¿å‰Šé™¤å¯èƒ½
                return this.currentUserRole && ['admin', 'editor_a'].includes(this.currentUserRole);
            },
            
            canResetData() {
                // admin ã®ã¿ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå¯èƒ½
                return this.currentUserRole === 'admin';
            },
            
            canManageUsers() {
                // admin ã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†å¯èƒ½
                return this.currentUserRole === 'admin';
            },
            
            // ğŸ¨ æ¨©é™ã«å¿œã˜ã¦UIã‚’æ›´æ–°
            updateUIForRole() {
                console.log('ğŸ¨ æ¨©é™ã«å¿œã˜ã¦UIã‚’æ›´æ–°:', this.currentUserRole);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
                const adminMenuBtn = document.getElementById('adminMenuBtn');
                if (adminMenuBtn) {
                    if (this.canManageUsers()) {
                        adminMenuBtn.style.display = 'inline-block';
                    } else {
                        adminMenuBtn.style.display = 'none';
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºï¼ˆadmin ã®ã¿ï¼‰
                const resetBtns = document.querySelectorAll('[onclick="app.resetAllData()"]');
                resetBtns.forEach(btn => {
                    if (this.canResetData()) {
                        btn.style.display = 'inline-block';
                    } else {
                        btn.style.display = 'none';
                    }
                });
            },
            
            // ğŸ’¾ Supabaseã¸ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            async saveMeetingToSupabase(meetingData) {
                console.log('ğŸ’¾ Supabaseã«ä¼šè­°ã‚’ä¿å­˜ä¸­...', meetingData);
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    
                    const { data, error } = await supabase
                        .from('meetings')
                        .insert([
                            {
                                id: meetingData.id,  // UUID ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
                                entity_id: meetingData.entityId,
                                entity_type: meetingData.entityId.startsWith('board') ? 'board' : 
                                            meetingData.entityId.startsWith('dept') ? 'department' : 'team',
                                organization: meetingData.organization,
                                division: meetingData.division,
                                department: meetingData.department,
                                meeting_name: meetingData.meetingName || meetingData.name,
                                meeting_date: meetingData.date,
                                created_by: user?.id || null,
                                created_at: new Date().toISOString()
                            }
                        ])
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('âœ… ä¼šè­°ä¿å­˜æˆåŠŸ:', data[0]);
                    return data[0];
                    
                } catch (error) {
                    console.error('âŒ ä¼šè­°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            },
            
            async saveMinuteToSupabase(minuteData) {
                console.log('ğŸ’¾ Supabaseã«è­°äº‹éŒ²ã‚’ä¿å­˜ä¸­...', minuteData);
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    
                    // 1. è­°äº‹éŒ²æœ¬ä½“ã‚’ä¿å­˜
                    const { data: minute, error: minuteError } = await supabase
                        .from('meeting_minutes')
                        .insert([
                            {
                                meeting_id: minuteData.meetingId,
                                date: minuteData.date,
                                location: minuteData.location,
                                status: minuteData.status,
                                created_by: user.id,
                                created_at: new Date().toISOString()
                            }
                        ])
                        .select();
                    
                    if (minuteError) throw minuteError;
                    
                    const minuteId = minute[0].id;
                    
                    // 2. å‚åŠ è€…ã‚’ä¿å­˜
                    if (minuteData.participants?.length > 0) {
                        const { error: participantError } = await supabase
                            .from('participants')
                            .insert(
                                minuteData.participants.map(p => ({
                                    minute_id: minuteId,
                                    name: p.name,
                                    role: p.role
                                }))
                            );
                        
                        if (participantError) throw participantError;
                    }
                    
                    // 3. è­°é¡Œã‚’ä¿å­˜
                    if (minuteData.agendaItems?.length > 0) {
                        const { error: agendaError } = await supabase
                            .from('agenda_items')
                            .insert(
                                minuteData.agendaItems.map((item, index) => ({
                                    minute_id: minuteId,
                                    title: item.title,
                                    content: item.content,
                                    order_index: index
                                }))
                            );
                        
                        if (agendaError) throw agendaError;
                    }
                    
                    // 4. ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜
                    if (minuteData.tasks?.length > 0) {
                        const { error: taskError } = await supabase
                            .from('tasks')
                            .insert(
                                minuteData.tasks.map(task => ({
                                    minute_id: minuteId,
                                    title: task.title,
                                    assignee: task.assignee,
                                    due_date: task.dueDate,
                                    status: task.status || 'pending'
                                }))
                            );
                        
                        if (taskError) throw taskError;
                    }
                    
                    console.log('âœ… è­°äº‹éŒ²ä¿å­˜æˆåŠŸ:', minute[0]);
                    return minute[0];
                    
                } catch (error) {
                    console.error('âŒ è­°äº‹éŒ²ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            },
            
            // ğŸ” èªè¨¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
            saveAuthData() {
                localStorage.setItem('users', JSON.stringify(this.users));
                localStorage.setItem('accessLogs', JSON.stringify(this.accessLogs));
                console.log('ğŸ” Saved auth data to localStorage');
            },
            
            loadAuthData() {
                const savedUsers = localStorage.getItem('users');
                const savedLogs = localStorage.getItem('accessLogs');
                
                if (savedUsers) {
                    this.users = JSON.parse(savedUsers);
                    console.log('ğŸ” Loaded users from localStorage:', this.users.length, 'users');
                }
                
                if (savedLogs) {
                    this.accessLogs = JSON.parse(savedLogs);
                    console.log('ğŸ” Loaded access logs from localStorage:', this.accessLogs.length, 'logs');
                }
            },
            
            resetAllData() {
                if (confirm('ã™ã¹ã¦ã®ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nâ€»çµ„ç¹”éšå±¤ï¼ˆéƒ¨é–€ãƒ»ãƒãƒ¼ãƒ ï¼‰ã¯æ®‹ã‚Šã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    // ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã¨è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                    this.meetingsData = {};
                    this.minutesData = {};
                    this.archivedMinutes = [];
                    
                    // LocalStorageã‹ã‚‰ä¼šè­°ãƒ»è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤
                    localStorage.removeItem('meetingsData');
                    localStorage.removeItem('minutesData');
                    localStorage.removeItem('archivedMinutes');
                    
                    console.log('âœ… ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                    alert('âœ… ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ\nçµ„ç¹”éšå±¤ã¯ä¿æŒã•ã‚Œã¦ã„ã¾ã™ã€‚');
                    
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                    location.reload();
                }
            },
            
            setupEventListeners() {
                console.log('=== setupEventListeners called ===');
                
                // Header logo click listener - Navigate to home
                const headerLogo = document.getElementById('headerLogo');
                if (headerLogo) {
                    headerLogo.addEventListener('click', () => {
                        console.log('ğŸ  Header logo clicked!');
                        this.navigateHome();
                    });
                    headerLogo.addEventListener('mouseover', () => {
                        headerLogo.style.opacity = '0.8';
                    });
                    headerLogo.addEventListener('mouseout', () => {
                        headerLogo.style.opacity = '1';
                    });
                    console.log('âœ… Header logo listener added');
                } else {
                    console.warn('âš ï¸ headerLogo not found');
                }
                
                // Minute form listener
                const minuteForm = document.getElementById('minuteForm');
                if (minuteForm) {
                    minuteForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveMinute();
                    });
                    console.log('âœ… minuteForm listener added');
                } else {
                    console.error('âŒ minuteForm not found');
                }
                
                // Content area listener
                const contentArea = document.getElementById('contentArea');
                if (!contentArea) {
                    console.error('âŒ contentArea not found!');
                    return;
                }
                
                console.log('âœ… contentArea found, adding click listener...');
                
                // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²: contentAreaå†…ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ç›£è¦–
                // â˜… ã‚¢ãƒ­ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦thisã‚’ãƒã‚¤ãƒ³ãƒ‰
                contentArea.addEventListener('click', (e) => {
                    console.log('contentArea clicked!', e.target);
                    
                    // ä¼šè­°ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯
                    const meetingItem = e.target.closest('.meeting-item');
                    if (meetingItem) {
                        console.log('Meeting item found:', meetingItem);
                        console.log('Meeting ID:', meetingItem.dataset.meetingId);
                        
                        if (meetingItem.dataset.meetingId) {
                            console.log('âœ… Calling showMeetingView with:', meetingItem.dataset.meetingId);
                            console.log('this:', this);
                            console.log('this.showMeetingView:', this.showMeetingView);
                            
                            try {
                                this.showMeetingView(meetingItem.dataset.meetingId);
                            } catch (error) {
                                console.error('âŒ Error calling showMeetingView:', error);
                            }
                            return;
                        } else {
                            console.error('âŒ No meeting ID found on meeting item');
                        }
                    }
                    
                    // çµ„ç¹”ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¯ãƒªãƒƒã‚¯ï¼ˆéƒ¨é–€åï¼‰
                    const sectionTitle = e.target.closest('.org-section-title');
                    if (sectionTitle && sectionTitle.dataset.deptId) {
                        console.log('Department section clicked via event delegation:', sectionTitle.dataset.deptId);
                        this.showDepartmentView(sectionTitle.dataset.deptId);
                        return;
                    }
                    
                    // çµ„ç¹”ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯
                    const orgItem = e.target.closest('.org-item');
                    if (orgItem) {
                        if (orgItem.dataset.boardId) {
                            console.log('Board clicked via event delegation');
                            this.showBoardView();
                        } else if (orgItem.dataset.deptId) {
                            console.log('Department clicked via event delegation:', orgItem.dataset.deptId);
                            this.showDepartmentView(orgItem.dataset.deptId);
                        } else if (orgItem.dataset.teamId) {
                            console.log('Team clicked via event delegation:', orgItem.dataset.teamId);
                            this.showTeamView(orgItem.dataset.teamId);
                        }
                        return;
                    }
                    
                    console.log('No matching element found for click');
                });
                
                console.log('âœ… contentArea click listener added successfully');
            },
            
            loadDemoData() {
                this.demoData = {
                    // çµŒå–¶ï¼ˆãƒœãƒ¼ãƒ‰ï¼‰ãƒ¬ãƒ™ãƒ« - é…åˆ—ã«å¤‰æ›´
                    boards: [
                        {
                            id: 'board-1',
                            name: 'çµŒå–¶ï¼ˆãƒœãƒ¼ãƒ‰ï¼‰'
                        }
                    ],
                    
                    departments: [
                        {
                            id: 'dept-1',
                            name: 'å–¶æ¥­éƒ¨ï¼ˆå–¶æ¥­å‚µæ¨©ç®¡ç†éƒ¨ï¼‰',
                            teams: [
                                { id: 'team-1-1', name: 'æ±æ—¥æœ¬' },
                                { id: 'team-1-2', name: 'è¥¿æ—¥æœ¬' }
                            ]
                        },
                        {
                            id: 'dept-2',
                            name: 'å‚µæ¨©ç®¡ç†éƒ¨',
                            teams: [
                                { id: 'team-2-1', name: 'ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ã‚¹ã‚¯' },
                                { id: 'team-2-2', name: 'ã‚¨ãƒªã‚¢æ‹…å½“æ±â‘ ' },
                                { id: 'team-2-3', name: 'ã‚¨ãƒªã‚¢æ‹…å½“æ±â‘¡' },
                                { id: 'team-2-4', name: 'ã‚¨ãƒªã‚¢æ‹…å½“è¥¿â‘ ' },
                                { id: 'team-2-5', name: 'ã‚¨ãƒªã‚¢æ‹…å½“è¥¿â‘¡' },
                                { id: 'team-2-6', name: 'æ³•å‹™' },
                                { id: 'team-2-7', name: 'æ±‚å„Ÿ' },
                                { id: 'team-2-8', name: 'ã‚µãƒãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯é€šå¸¸äº‹å‹™ãƒãƒ¼ãƒ ' },
                                { id: 'team-2-9', name: 'ã‚µãƒãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯ä¿è¨¼å®Ÿè¡Œãƒãƒ¼ãƒ ' }
                            ]
                        },
                        {
                            id: 'dept-3',
                            name: 'å¯©æŸ»å¥‘ç´„ç®¡ç†éƒ¨',
                            teams: [
                                { id: 'team-3-1', name: 'å¯©æŸ»' },
                                { id: 'team-3-2', name: 'å¥‘ç´„ç®¡ç†' },
                                { id: 'team-3-3', name: 'å›½éš›ãƒãƒ¼ãƒ ' }
                            ]
                        },
                        {
                            id: 'dept-4',
                            name: 'ã‚·ã‚¹ãƒ†ãƒ éƒ¨',
                            teams: [
                                { id: 'team-4-1', name: 'ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ' },
                                { id: 'team-4-2', name: 'é–‹ç™ºãƒãƒ¼ãƒ ' }
                            ]
                        },
                        {
                            id: 'dept-5',
                            name: 'äººäº‹ç®¡ç†éƒ¨',
                            teams: [
                                { id: 'team-5-1', name: 'çµŒç†' },
                                { id: 'team-5-2', name: 'äººäº‹' },
                                { id: 'team-5-3', name: 'ç®¡ç†' }
                            ]
                        }
                    ],
                    
                    generateMeetings(entityId) {
                        // LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
                        if (window.app && window.app.meetingsData && window.app.meetingsData[entityId]) {
                            return window.app.meetingsData[entityId].sort((a, b) => new Date(b.date) - new Date(a.date));
                        }
                        
                        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™
                        return [];
                    },
                    
                    generateMinutes(meetingId) {
                        // LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
                        if (window.app && window.app.minutesData && window.app.minutesData[meetingId]) {
                            return window.app.minutesData[meetingId].filter(m => !m.archived);
                        }
                        
                        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™
                        return [];
                    }
                };
            },
            
            // ä¼šè­°æ•°ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            getMeetingCount(entityId) {
                if (this.meetingsData && this.meetingsData[entityId]) {
                    return this.meetingsData[entityId].length;
                }
                return 0;
            },
            
            async checkAuth() {
                // ğŸ” åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
                console.log('ğŸ” checkAuth called');
                console.log('ğŸ” Total users:', this.users.length);
                console.log('ğŸ” Users data:', this.users);
                
                const adminUsers = this.users.filter(u => u.role === this.USER_ROLE.ADMIN);
                console.log('ğŸ” Admin users:', adminUsers.length);
                
                if (adminUsers.length === 0) {
                    // ç®¡ç†è€…ãŒ1äººã‚‚ã„ãªã„å ´åˆã¯åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤º
                    console.log('ğŸ” No admin users found - showing setup page');
                    this.showSetupPage();
                    return;
                }
                
                console.log('ğŸ” Admin exists - checking login status');
                
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
                const token = localStorage.getItem('accessToken');
                if (token) {
                    // Use stored user info instead of API call
                    const userInfo = localStorage.getItem('userInfo');
                    if (userInfo) {
                        try {
                            const user = JSON.parse(userInfo);
                            
                            // ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
                            const currentUser = this.users.find(u => u.email === user.email);
                            if (!currentUser) {
                                console.warn('User not found in database');
                                this.logout();
                                return;
                            }
                            
                            if (currentUser.status !== this.USER_STATUS.ACTIVE) {
                                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                                let message = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚';
                                if (currentUser.status === this.USER_STATUS.SUSPENDED) {
                                    message = 'â›” ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒåœæ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚\nç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
                                } else if (currentUser.status === this.USER_STATUS.PENDING) {
                                    message = 'â³ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ‰¿èªå¾…ã¡ã§ã™ã€‚\nç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚';
                                } else if (currentUser.status === this.USER_STATUS.REJECTED) {
                                    message = 'âŒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\nè©³ç´°ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
                                }
                                alert(message);
                                this.logout();
                                return;
                            }
                            
                            // ãƒ­ã‚°è¨˜éŒ²
                            this.logAccess(currentUser.email, 'login_check', 'success');
                            
                            this.currentUser = currentUser;
                            this.showMainApp();
                            return;
                        } catch (error) {
                            console.error('Failed to parse user info:', error);
                        }
                    }
                }
                this.showLoginPage();
            },
            
            showLoginPage() {
                // ã™ã¹ã¦ã®ç”»é¢ã‚’éè¡¨ç¤º
                document.getElementById('setupPage').style.display = 'none';
                document.getElementById('verificationPage').style.display = 'none';
                document.getElementById('registrationPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                
                // ğŸ” ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
                const rememberedEmail = localStorage.getItem('rememberedEmail');
                const rememberedPassword = localStorage.getItem('rememberedPassword');
                
                if (rememberedEmail && rememberedPassword) {
                    const emailInput = document.getElementById('email');
                    const passwordInput = document.getElementById('password');
                    
                    if (emailInput) emailInput.value = rememberedEmail;
                    if (passwordInput) passwordInput.value = rememberedPassword;
                    
                    console.log('ğŸ” Remembered credentials loaded');
                }
            },
            
            showSetupPage() {
                // ã™ã¹ã¦ã®ç”»é¢ã‚’éè¡¨ç¤º
                document.getElementById('setupPage').style.display = 'flex';
                document.getElementById('verificationPage').style.display = 'none';
                document.getElementById('registrationPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'none';
            },
            
            showVerificationPage(email) {
                document.getElementById('setupPage').style.display = 'none';
                document.getElementById('verificationPage').style.display = 'flex';
                document.getElementById('registrationPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('verificationEmail').textContent = email;
            },
            
            showRegistrationPage() {
                document.getElementById('setupPage').style.display = 'none';
                document.getElementById('verificationPage').style.display = 'none';
                document.getElementById('registrationPage').style.display = 'flex';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'none';
            },
            
            showMainApp() {
                document.getElementById('setupPage').style.display = 'none';
                document.getElementById('verificationPage').style.display = 'none';
                document.getElementById('registrationPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('headerUserName').textContent = this.currentUser.name;
                
                // ğŸ” ç®¡ç†è€…ã®å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const adminMenuBtn = document.getElementById('adminMenuBtn');
                if (adminMenuBtn) {
                    if (this.currentUser.role === this.USER_ROLE.ADMIN) {
                        adminMenuBtn.style.display = 'inline-block';
                    } else {
                        adminMenuBtn.style.display = 'none';
                    }
                }
                
                // â˜… çµ„ç¹”ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆã“ã‚ŒãŒãªã„ã¨ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„ï¼ï¼‰
                this.showOrganizationView();
                document.getElementById('headerUserDept').textContent = 
                    `${this.currentUser.department.name} / ${this.currentUser.team.name}`;
                this.showOrganizationView();
            },
            
            showAlert(message, type = 'error') {
                const alertDiv = document.getElementById('loginAlert');
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => alertDiv.innerHTML = '', 3000);
            },
            
            showSetupAlert(message, type = 'error') {
                const alertDiv = document.getElementById('setupAlert');
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => alertDiv.innerHTML = '', 5000);
            },
            
            showVerificationAlert(message, type = 'error') {
                const alertDiv = document.getElementById('verificationAlert');
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => alertDiv.innerHTML = '', 5000);
            },
            
            showRegistrationAlert(message, type = 'error') {
                const alertDiv = document.getElementById('registrationAlert');
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => alertDiv.innerHTML = '', 5000);
            },
            
            // ğŸ” èªè¨¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
            validateEmail(email) {
                // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åŸºæœ¬ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    return { valid: false, message: 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
                }
                
                // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
                const domain = email.split('@')[1];
                if (domain !== this.ALLOWED_DOMAIN) {
                    return { valid: false, message: `@${this.ALLOWED_DOMAIN} ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ä½¿ç”¨ã§ãã¾ã™` };
                }
                
                // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯
                const existingUser = this.users.find(u => u.email === email);
                if (existingUser) {
                    return { valid: false, message: 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™' };
                }
                
                return { valid: true };
            },
            
            validatePassword(password) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯
                if (password.length < 8) {
                    return { valid: false, message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šå¿…è¦ã§ã™' };
                }
                
                // å¤§æ–‡å­—ãƒã‚§ãƒƒã‚¯
                if (!/[A-Z]/.test(password)) {
                    return { valid: false, message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å¤§æ–‡å­—ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™' };
                }
                
                // å°æ–‡å­—ãƒã‚§ãƒƒã‚¯
                if (!/[a-z]/.test(password)) {
                    return { valid: false, message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å°æ–‡å­—ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™' };
                }
                
                // æ•°å­—ãƒã‚§ãƒƒã‚¯
                if (!/[0-9]/.test(password)) {
                    return { valid: false, message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯æ•°å­—ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™' };
                }
                
                return { valid: true };
            },
            
            generateVerificationCode() {
                // 6æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
                return Math.floor(100000 + Math.random() * 900000).toString();
            },
            
            sendVerificationEmail(email, code) {
                // å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ä»£ã‚ã‚Šã«ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                console.log('ğŸ“§ ====================================');
                console.log('ğŸ“§ ç¢ºèªã‚³ãƒ¼ãƒ‰é€ä¿¡ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰');
                console.log('ğŸ“§ ====================================');
                console.log(`ğŸ“§ å®›å…ˆ: ${email}`);
                console.log(`ğŸ“§ ç¢ºèªã‚³ãƒ¼ãƒ‰: ${code}`);
                console.log('ğŸ“§ ====================================');
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆã§ã‚‚è¡¨ç¤ºï¼ˆé–‹ç™ºç”¨ï¼‰
                alert(`ğŸ“§ ç¢ºèªã‚³ãƒ¼ãƒ‰é€ä¿¡ï¼ˆé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼‰\n\nå®›å…ˆ: ${email}\nç¢ºèªã‚³ãƒ¼ãƒ‰: ${code}\n\nâ€»æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™`);
                
                return true;
            },
            
            logAccess(email, action, status, details = '') {
                const log = {
                    timestamp: new Date().toISOString(),
                    email: email,
                    action: action, // 'login', 'login_check', 'register', 'approve', 'suspend', 'reject'
                    status: status, // 'success', 'failed', 'blocked'
                    details: details,
                    userAgent: navigator.userAgent
                };
                
                this.accessLogs.push(log);
                this.saveAuthData();
                console.log('ğŸ“ Access log:', log);
            },
            
            updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                let html = '<span class="breadcrumb-item" onclick="app.showOrganizationView()">ğŸ¢ å…¨çµ„ç¹”</span>';
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã®å ´åˆ
                if (this.currentView === 'user-management') {
                    html += '<span class="breadcrumb-separator">â€º</span>';
                    html += `<span class="breadcrumb-item active">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</span>`;
                    breadcrumb.innerHTML = html;
                    return;
                }
                
                if (this.currentBoard) {
                    html += '<span class="breadcrumb-separator">â€º</span>';
                    html += `<span class="breadcrumb-item" onclick="app.showBoardView()">${this.currentBoard.name}</span>`;
                }
                
                if (this.currentDepartment) {
                    html += '<span class="breadcrumb-separator">â€º</span>';
                    html += `<span class="breadcrumb-item" onclick="app.showDepartmentView('${this.currentDepartment.id}')">${this.currentDepartment.name}</span>`;
                }
                
                if (this.currentTeam) {
                    html += '<span class="breadcrumb-separator">â€º</span>';
                    html += `<span class="breadcrumb-item" onclick="app.showTeamView('${this.currentTeam.id}')">${this.currentTeam.name}</span>`;
                }
                
                if (this.currentMeeting) {
                    html += '<span class="breadcrumb-separator">â€º</span>';
                    html += `<span class="breadcrumb-item" onclick="app.showMeetingView('${this.currentMeeting.id}')">${this.currentMeeting.name}</span>`;
                }
                
                if (this.currentMinute) {
                    html += '<span class="breadcrumb-separator">â€º</span>';
                    html += `<span class="breadcrumb-item active">${this.currentMinute.topic}</span>`;
                }
                
                breadcrumb.innerHTML = html;
            },
            
            // ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢
            showUserManagement() {
                if (this.currentUser.role !== this.USER_ROLE.ADMIN) {
                    alert('âŒ ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™');
                    return;
                }
                
                this.currentView = 'userManagement';
                this.updateBreadcrumb();
                
                const content = document.getElementById('contentArea');
                let html = '<div class="card">';
                html += '<div class="card-title">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</div>';
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
                html += '<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">';
                html += '<button class="btn btn-sm" onclick="app.filterUsers(\'all\')" style="background: #667eea; color: white;">ã™ã¹ã¦</button>';
                html += '<button class="btn btn-sm" onclick="app.filterUsers(\'pending\')" style="background: #f39c12; color: white;">æ‰¿èªå¾…ã¡</button>';
                html += '<button class="btn btn-sm" onclick="app.filterUsers(\'active\')" style="background: #27ae60; color: white;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</button>';
                html += '<button class="btn btn-sm" onclick="app.filterUsers(\'suspended\')" style="background: #e74c3c; color: white;">åœæ­¢ä¸­</button>';
                html += '</div>';
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
                html += '<div style="overflow-x: auto;">';
                html += '<table class="minutes-table" style="font-size: 13px;">';
                html += '<thead><tr>';
                html += '<th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>';
                html += '<th>åå‰</th>';
                html += '<th>å½¹å‰²</th>';
                html += '<th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>';
                html += '<th>ç™»éŒ²æ—¥</th>';
                html += '<th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>';
                html += '</tr></thead>';
                html += '<tbody id="userTableBody">';
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
                const sortedUsers = [...this.users].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                sortedUsers.forEach(user => {
                    const statusBadge = this.getUserStatusBadge(user.status);
                    const roleBadge = this.getUserRoleBadge(user.role);
                    
                    html += '<tr>';
                    html += `<td>${user.email}</td>`;
                    html += `<td>${user.name}</td>`;
                    html += `<td>${roleBadge}</td>`;
                    html += `<td>${statusBadge}</td>`;
                    html += `<td>${new Date(user.createdAt).toLocaleDateString('ja-JP')}</td>`;
                    html += `<td style="white-space: nowrap;">`;
                    
                    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
                    if (user.status === this.USER_STATUS.PENDING) {
                        html += `<button class="btn btn-sm" onclick="app.approveUser('${user.id}')" style="background: #27ae60; color: white; margin-right: 5px;">âœ“ æ‰¿èª</button>`;
                        html += `<button class="btn btn-sm" onclick="app.rejectUser('${user.id}')" style="background: #e74c3c; color: white;">âœ— æ‹’å¦</button>`;
                    } else if (user.status === this.USER_STATUS.ACTIVE) {
                        html += `<button class="btn btn-sm" onclick="app.suspendUser('${user.id}')" style="background: #f39c12; color: white; margin-right: 5px;">â¸ åœæ­¢</button>`;
                        html += `<button class="btn btn-sm" onclick="app.deleteUser('${user.id}')" style="background: #e74c3c; color: white;">ğŸ—‘ï¸ å‰Šé™¤</button>`;
                    } else if (user.status === this.USER_STATUS.SUSPENDED) {
                        html += `<button class="btn btn-sm" onclick="app.activateUser('${user.id}')" style="background: #27ae60; color: white; margin-right: 5px;">â–¶ æœ‰åŠ¹åŒ–</button>`;
                        html += `<button class="btn btn-sm" onclick="app.deleteUser('${user.id}')" style="background: #e74c3c; color: white;">ğŸ—‘ï¸ å‰Šé™¤</button>`;
                    } else if (user.status === this.USER_STATUS.REJECTED) {
                        html += `<button class="btn btn-sm" onclick="app.deleteUser('${user.id}')" style="background: #e74c3c; color: white;">ğŸ—‘ï¸ å‰Šé™¤</button>`;
                    }
                    
                    html += '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += '</div>';
                html += '</div>';
                
                content.innerHTML = html;
            },
            
            getUserStatusBadge(status) {
                const statusMap = {
                    [this.USER_STATUS.PENDING]: { text: 'æ‰¿èªå¾…ã¡', color: '#f39c12', bg: '#fff3cd' },
                    [this.USER_STATUS.ACTIVE]: { text: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', color: '#27ae60', bg: '#d1e7dd' },
                    [this.USER_STATUS.SUSPENDED]: { text: 'åœæ­¢ä¸­', color: '#e74c3c', bg: '#f8d7da' },
                    [this.USER_STATUS.REJECTED]: { text: 'æ‹’å¦æ¸ˆã¿', color: '#6c757d', bg: '#e9ecef' }
                };
                const config = statusMap[status] || statusMap[this.USER_STATUS.PENDING];
                return `<span class="badge" style="background: ${config.bg}; color: ${config.color};">${config.text}</span>`;
            },
            
            getUserRoleBadge(role) {
                const roleMap = {
                    [this.USER_ROLE.ADMIN]: { text: 'ç®¡ç†è€…', color: '#9c27b0', bg: '#f3e5f5' },
                    [this.USER_ROLE.USER]: { text: 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼', color: '#2196f3', bg: '#e3f2fd' },
                    [this.USER_ROLE.VIEWER]: { text: 'é–²è¦§è€…', color: '#607d8b', bg: '#eceff1' }
                };
                const config = roleMap[role] || roleMap[this.USER_ROLE.USER];
                return `<span class="badge" style="background: ${config.bg}; color: ${config.color};">${config.text}</span>`;
            },
            
            filterUsers(filter) {
                const users = filter === 'all' 
                    ? this.users 
                    : this.users.filter(u => u.status === filter);
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç¾åœ¨ã¯å…¨ç”»é¢å†æç”»ï¼‰
                this.showUserManagement();
            },
            
            approveUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;
                
                if (confirm(`${user.name} (${user.email}) ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ`)) {
                    user.status = this.USER_STATUS.ACTIVE;
                    user.approvedAt = new Date().toISOString();
                    user.approvedBy = this.currentUser.email;
                    
                    this.saveAuthData();
                    this.logAccess(user.email, 'approve', 'success', `Approved by ${this.currentUser.email}`);
                    alert('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èªã—ã¾ã—ãŸ');
                    this.showUserManagement();
                }
            },
            
            rejectUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;
                
                if (confirm(`${user.name} (${user.email}) ã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚`)) {
                    user.status = this.USER_STATUS.REJECTED;
                    
                    this.saveAuthData();
                    this.logAccess(user.email, 'reject', 'success', `Rejected by ${this.currentUser.email}`);
                    alert('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‹’å¦ã—ã¾ã—ãŸ');
                    this.showUserManagement();
                }
            },
            
            suspendUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;
                
                if (confirm(`${user.name} (${user.email}) ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚`)) {
                    user.status = this.USER_STATUS.SUSPENDED;
                    
                    this.saveAuthData();
                    this.logAccess(user.email, 'suspend', 'success', `Suspended by ${this.currentUser.email}`);
                    alert('â¸ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                    this.showUserManagement();
                }
            },
            
            activateUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;
                
                if (confirm(`${user.name} (${user.email}) ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    user.status = this.USER_STATUS.ACTIVE;
                    
                    this.saveAuthData();
                    this.logAccess(user.email, 'activate', 'success', `Activated by ${this.currentUser.email}`);
                    alert('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
                    this.showUserManagement();
                }
            },
            
            deleteUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;
                
                if (confirm(`${user.name} (${user.email}) ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                    this.users = this.users.filter(u => u.id !== userId);
                    
                    this.saveAuthData();
                    this.logAccess(user.email, 'delete', 'success', `Deleted by ${this.currentUser.email}`);
                    alert('ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    this.showUserManagement();
                }
            },
            
            showOrganizationView() {
                this.currentView = 'organization';
                this.currentBoard = null;
                this.currentDepartment = null;
                this.currentTeam = null;
                this.currentMeeting = null;
                this.currentMinute = null;
                
                this.updateBreadcrumb();
                
                const content = document.getElementById('contentArea');
                let html = '<div class="card">';
                html += '<div class="card-title">ğŸ¢ çµ„ç¹”éšå±¤ä¸€è¦§ - å…¨ç¤¾ã®ä¼šè­°ãƒ»è­°äº‹éŒ²ã‚’ç®¡ç†</div>';
                html += '<div class="org-hierarchy">';
                
                // Board level - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªãƒ†ãƒ¼ãƒ–ãƒ«é¢¨ãƒ‡ã‚¶ã‚¤ãƒ³
                html += '<div class="org-level" style="margin-bottom: 20px;">';
                html += `<div class="org-level-header" style="background: #2c3e50; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #3498db; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px;">
                        <span style="font-size: 18px;">ğŸ›ï¸</span>
                        <div>
                            <span style="color: white; font-size: 15px; font-weight: 700; display: block;">çµŒå–¶å±¤ï¼ˆãƒœãƒ¼ãƒ‰ï¼‰</span>
                            <span style="color: #95a5a6; font-size: 11px;">ä¼šç¤¾å…¨ä½“ã®çµŒå–¶ä¼šè­°</span>
                        </div>
                    </div>
                    <button class="btn btn-sm" onclick="app.addBoard()" style="padding: 6px 14px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 3px; font-weight: 600; white-space: nowrap;">+ è¿½åŠ </button>
                </div>`;
                
                // ãƒœãƒ¼ãƒ‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œé¢¨ã«è¡¨ç¤º
                html += '<div style="background: white; border: 1px solid #ddd; border-top: none;">';
                
                this.demoData.boards.forEach((board, index) => {
                    const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                    html += `
                        <div class="org-item org-item-responsive" data-board-id="${board.id}" onclick="app.showBoardView('${board.id}')" style="
                            background: ${bgColor};
                            border-bottom: 1px solid #e9ecef;
                            cursor: pointer;
                            transition: background 0.2s;
                            padding: 12px 16px;
                        " onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='${bgColor}'">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <div style="font-size: 24px;">ğŸ‘”</div>
                                <div style="flex: 1; min-width: 150px;">
                                    <div style="font-size: 14px; font-weight: 700; color: #2c3e50; margin-bottom: 2px;">${board.name}</div>
                                    <div style="font-size: 11px; color: #7f8c8d;">çµŒå–¶å±¤ãƒ»å…¨ç¤¾ä¼šè­°</div>
                                </div>
                                <div style="margin: 4px 0;">
                                    <span style="display: inline-block; background: #3498db; color: white; padding: 4px 12px; border-radius: 3px; font-size: 12px; font-weight: 600;">
                                        ğŸ“Š ${this.getMeetingCount(board.id)}ä»¶ã®ä¼šè­°
                                    </span>
                                </div>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button onclick="event.stopPropagation(); app.editBoard('${board.id}')" style="padding: 5px 10px; font-size: 11px; background: white; color: #7f8c8d; border: 1px solid #ddd; border-radius: 3px; cursor: pointer;">ç·¨é›†</button>
                                    <button onclick="event.stopPropagation(); app.deleteBoard('${board.id}')" style="padding: 5px 10px; font-size: 11px; background: white; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                
                // Department and Team levels - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªãƒ†ãƒ¼ãƒ–ãƒ«é¢¨
                html += '<div style="margin-top: 30px;">';
                html += `<div class="org-level-header" style="background: #27ae60; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #2ecc71; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px;">
                        <span style="font-size: 18px;">ğŸ¢</span>
                        <div>
                            <span style="color: white; font-size: 15px; font-weight: 700; display: block;">éƒ¨é–€ãƒ»ãƒãƒ¼ãƒ ä¸€è¦§</span>
                            <span style="color: #a8e6cf; font-size: 11px;">å„éƒ¨é–€ã¨ãƒãƒ¼ãƒ ã®ä¼šè­°</span>
                        </div>
                    </div>
                    <button class="btn btn-sm" onclick="app.addDepartment()" style="padding: 6px 14px; font-size: 12px; background: #2ecc71; color: white; border: none; border-radius: 3px; font-weight: 600; white-space: nowrap;">+ è¿½åŠ </button>
                </div>`;
                
                html += '<div style="background: white; border: 1px solid #ddd; border-top: none;">';
                
                this.demoData.departments.forEach((dept, deptIndex) => {
                    const totalMeetings = dept.teams.reduce((sum, team) => sum + this.getMeetingCount(team.id), 0);
                    const deptBg = '#34495e';
                    
                    // éƒ¨é–€ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                    html += `
                        <div class="org-item-responsive" style="padding: 10px 16px; background: ${deptBg}; border-bottom: 1px solid #2c3e50; cursor: pointer;" onclick="app.showDepartmentView('${dept.id}')">
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <div style="font-size: 20px;">ğŸ“</div>
                                <div style="flex: 1; min-width: 120px;">
                                    <span style="font-size: 14px; font-weight: 700; color: white;">${dept.name}</span>
                                </div>
                                <div style="margin: 4px 0;">
                                    <span style="background: #7f8c8d; color: white; padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: 600;">
                                        ${dept.teams.length}ãƒãƒ¼ãƒ ãƒ»${totalMeetings}ä»¶
                                    </span>
                                </div>
                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                    <button onclick="event.stopPropagation(); app.addTeam('${dept.id}')" style="padding: 4px 10px; font-size: 11px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">+ãƒãƒ¼ãƒ </button>
                                    <button onclick="event.stopPropagation(); app.editDepartment('${dept.id}')" style="padding: 4px 8px; font-size: 11px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">ç·¨é›†</button>
                                    <button onclick="event.stopPropagation(); app.deleteDepartment('${dept.id}')" style="padding: 4px 8px; font-size: 11px; background: rgba(231,76,60,0.8); color: white; border: none; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ãƒãƒ¼ãƒ è¡Œï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä»˜ãï¼‰
                    dept.teams.forEach((team, teamIndex) => {
                        const teamBg = teamIndex % 2 === 0 ? '#ecf0f1' : '#ffffff';
                        html += `
                            <div class="org-item org-item-responsive" data-team-id="${team.id}" onclick="app.showTeamView('${team.id}')" style="
                                padding: 10px 16px 10px 30px;
                                background: ${teamBg};
                                border-bottom: 1px solid #dee2e6;
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#d1f2eb'" onmouseout="this.style.background='${teamBg}'">
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <div style="font-size: 18px;">ğŸ‘¥</div>
                                    <div style="flex: 1; min-width: 120px;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">${team.name}</div>
                                        <div style="font-size: 10px; color: #95a5a6; margin-top: 1px;">${dept.name}</div>
                                    </div>
                                    <div style="margin: 4px 0;">
                                        <span style="background: #27ae60; color: white; padding: 3px 10px; border-radius: 3px; font-size: 11px; font-weight: 600;">
                                            ğŸ“‹ ${this.getMeetingCount(team.id)}ä»¶
                                        </span>
                                    </div>
                                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                        <button onclick="event.stopPropagation(); app.editTeam('${team.id}')" style="padding: 4px 10px; font-size: 10px; background: white; color: #7f8c8d; border: 1px solid #ddd; border-radius: 3px; cursor: pointer;">ç·¨é›†</button>
                                        <button onclick="event.stopPropagation(); app.deleteTeam('${team.id}')" style="padding: 4px 10px; font-size: 10px; background: white; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });
                
                html += '</div></div>';
                content.innerHTML = html;
            },
            
            showBoardView() {
                this.currentView = 'board';
                this.currentBoard = this.demoData.boards[0]; // æœ€åˆã®ãƒœãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼ˆå¾Œã§æ”¹å–„å¯èƒ½ï¼‰
                this.currentDepartment = null;
                this.currentTeam = null;
                this.currentMeeting = null;
                this.currentMinute = null;
                
                this.updateBreadcrumb();
                
                const meetings = this.demoData.generateMeetings('board-1');
                
                const content = document.getElementById('contentArea');
                
                // TOPã¨åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«é¢¨UI
                let html = '<button class="btn btn-secondary back-btn" onclick="app.showOrganizationView()" style="margin-bottom: 15px; padding: 8px 16px; font-size: 13px; background: #95a5a6; color: white; border: none; border-radius: 3px;">â† æˆ»ã‚‹</button>';
                
                html += `<div style="background: #2c3e50; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #3498db;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 18px;">ğŸ“…</span>
                        <span style="color: white; font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">${this.currentBoard.name} ã®ä¼šè­°ä¸€è¦§</span>
                    </div>
                    ${this.canInsert() ? `<button class="btn btn-sm" onclick="app.openAddMeetingModal('board-1')" style="padding: 6px 14px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 3px; font-weight: 600;">+ ä¼šè­°è¿½åŠ </button>` : ''}
                </div>`;
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œé¢¨ã«è¡¨ç¤º
                html += '<div style="background: white; border: 1px solid #ddd; border-top: none;">';
                
                if (meetings.length === 0) {
                    html += '<div style="padding: 40px 20px; text-align: center; color: #7f8c8d; font-size: 14px;">ä¼šè­°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œ+ ä¼šè­°è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
                } else {
                    meetings.forEach((meeting, index) => {
                        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                        html += `
                            <div style="
                                display: grid;
                                grid-template-columns: 50px 1fr 280px;
                                align-items: center;
                                padding: 10px 20px;
                                background: ${bgColor};
                                border-bottom: 1px solid #e9ecef;
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='${bgColor}'">
                                <div style="font-size: 24px; text-align: center;">ğŸ“‹</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 700; color: #2c3e50;">${meeting.name}</div>
                                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 2px;">${this.currentBoard.name}</div>
                                </div>
                                <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                    <button class="detail-btn" data-meeting-id="${meeting.id}" style="padding: 6px 16px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">è©³ç´°</button>
                                    ${this.canUpdate() ? `<button class="edit-meeting-btn" data-meeting-id="${meeting.id}" style="padding: 6px 12px; font-size: 11px; background: white; color: #7f8c8d; border: 1px solid #ddd; border-radius: 3px; cursor: pointer;">ç·¨é›†</button>` : ''}
                                    ${this.canDelete() ? `<button class="delete-meeting-btn" data-meeting-id="${meeting.id}" style="padding: 6px 12px; font-size: 11px; background: white; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                content.innerHTML = html;
                
                // â˜… DOMã«è¿½åŠ ã•ã‚ŒãŸå¾Œã€ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
                setTimeout(() => {
                    // è©³ç´°ãƒœã‚¿ãƒ³
                    const detailButtons = content.querySelectorAll('.detail-btn');
                    console.log(`ğŸ” Found ${detailButtons.length} detail buttons`);
                    console.log('ğŸ” Detail buttons:', detailButtons);
                    
                    detailButtons.forEach((button, index) => {
                        const meetingId = button.getAttribute('data-meeting-id');
                        console.log(`ğŸ” Button ${index}: meetingId =`, meetingId);
                        
                        button.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ğŸ”˜ Detail button clicked:', meetingId);
                            console.log('ğŸ”˜ Meeting data:', this.meetingsData);
                            this.showMeetingView(meetingId);
                        });
                    });
                    
                    // ç·¨é›†ãƒœã‚¿ãƒ³
                    const editButtons = content.querySelectorAll('.edit-meeting-btn');
                    console.log(`ğŸ” Found ${editButtons.length} edit buttons`);
                    editButtons.forEach((button, index) => {
                        const meetingId = button.getAttribute('data-meeting-id');
                        console.log(`ğŸ” Edit button ${index}: meetingId =`, meetingId);
                        
                        button.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('âœï¸ Edit button clicked:', meetingId);
                            this.openEditMeetingModal(meetingId);
                        });
                    });
                    
                    // å‰Šé™¤ãƒœã‚¿ãƒ³
                    const deleteButtons = content.querySelectorAll('.delete-meeting-btn');
                    console.log(`ğŸ” Found ${deleteButtons.length} delete buttons`);
                    deleteButtons.forEach((button, index) => {
                        const meetingId = button.getAttribute('data-meeting-id');
                        console.log(`ğŸ” Delete button ${index}: meetingId =`, meetingId);
                        
                        button.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ğŸ—‘ï¸ Delete button clicked:', meetingId);
                            this.deleteMeeting(meetingId);
                        });
                    });
                    
                    console.log('âœ… All button handlers attached');
                }, 100);
            },
            
            showDepartmentView(deptId) {
                const dept = this.demoData.departments.find(d => d.id === deptId);
                if (!dept) return;
                
                this.currentView = 'department';
                this.currentBoard = null;
                this.currentDepartment = dept;
                this.currentTeam = null;
                this.currentMeeting = null;
                this.currentMinute = null;
                
                this.updateBreadcrumb();
                
                const content = document.getElementById('contentArea');
                
                // TOPã¨åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«é¢¨UI
                let html = '<button class="btn btn-secondary back-btn" onclick="app.showOrganizationView()" style="margin-bottom: 15px; padding: 8px 16px; font-size: 13px; background: #95a5a6; color: white; border: none; border-radius: 3px;">â† æˆ»ã‚‹</button>';
                
                html += `<div style="background: #27ae60; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #2ecc71;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 18px;">ğŸ‘¥</span>
                        <span style="color: white; font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">${dept.name} ã®ãƒãƒ¼ãƒ ä¸€è¦§</span>
                    </div>
                    <button class="btn btn-sm" onclick="app.addTeam('${dept.id}')" style="padding: 6px 14px; font-size: 12px; background: #2ecc71; color: white; border: none; border-radius: 3px; font-weight: 600;">+ ãƒãƒ¼ãƒ è¿½åŠ </button>
                </div>`;
                
                html += '<div style="background: white; border: 1px solid #ddd; border-top: none;">';
                
                if (dept.teams.length === 0) {
                    html += '<div style="padding: 40px 20px; text-align: center; color: #7f8c8d; font-size: 14px;">ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œ+ ãƒãƒ¼ãƒ è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
                } else {
                    dept.teams.forEach((team, index) => {
                        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                        html += `
                            <div onclick="app.showTeamView('${team.id}')" style="
                                display: grid;
                                grid-template-columns: 50px 1fr 180px;
                                align-items: center;
                                padding: 10px 20px;
                                background: ${bgColor};
                                border-bottom: 1px solid #e9ecef;
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#d1f2eb'" onmouseout="this.style.background='${bgColor}'">
                                <div style="font-size: 24px; text-align: center;">ğŸ‘¥</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 700; color: #2c3e50;">${team.name}</div>
                                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 2px;">${dept.name}</div>
                                </div>
                                <div style="text-align: center;">
                                    <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 3px; font-size: 12px; font-weight: 600;">
                                        ğŸ“‹ ${this.getMeetingCount(team.id)}ä»¶ã®ä¼šè­°
                                    </span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                content.innerHTML = html;
            },
            
            showTeamView(teamId) {
                let team = null;
                for (const dept of this.demoData.departments) {
                    team = dept.teams.find(t => t.id === teamId);
                    if (team) {
                        this.currentDepartment = dept;
                        break;
                    }
                }
                if (!team) return;
                
                this.currentView = 'team';
                this.currentBoard = null;
                this.currentTeam = team;
                this.currentMeeting = null;
                this.currentMinute = null;
                
                this.updateBreadcrumb();
                
                const meetings = this.demoData.generateMeetings(teamId);
                
                const content = document.getElementById('contentArea');
                
                // TOPã¨åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«é¢¨UI
                let html = `<button class="btn btn-secondary back-btn" onclick="app.showDepartmentView('${this.currentDepartment.id}')" style="margin-bottom: 15px; padding: 8px 16px; font-size: 13px; background: #95a5a6; color: white; border: none; border-radius: 3px;">â† æˆ»ã‚‹</button>`;
                
                html += `<div style="background: #27ae60; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #2ecc71;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 18px;">ğŸ“…</span>
                        <span style="color: white; font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">${team.name} ã®ä¼šè­°ä¸€è¦§</span>
                        <span style="color: #a8e6cf; font-size: 12px; margin-left: 8px;">${this.currentDepartment.name}</span>
                    </div>
                    ${this.canInsert() ? `<button class="btn btn-sm" onclick="app.openAddMeetingModal('${teamId}')" style="padding: 6px 14px; font-size: 12px; background: #2ecc71; color: white; border: none; border-radius: 3px; font-weight: 600;">+ ä¼šè­°è¿½åŠ </button>` : ''}
                </div>`;
                
                html += '<div style="background: white; border: 1px solid #ddd; border-top: none;">';
                
                if (meetings.length === 0) {
                    html += '<div style="padding: 40px 20px; text-align: center; color: #7f8c8d; font-size: 14px;">ä¼šè­°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œ+ ä¼šè­°è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
                } else {
                    meetings.forEach((meeting, index) => {
                        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                        html += `
                            <div style="
                                display: grid;
                                grid-template-columns: 50px 1fr 280px;
                                align-items: center;
                                padding: 10px 20px;
                                background: ${bgColor};
                                border-bottom: 1px solid #e9ecef;
                                cursor: pointer;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#d1f2eb'" onmouseout="this.style.background='${bgColor}'">
                                <div style="font-size: 24px; text-align: center;">ğŸ“‹</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 700; color: #2c3e50;">${meeting.name}</div>
                                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 2px;">${team.name} - ${this.currentDepartment.name}</div>
                                </div>
                                <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                    <button class="detail-btn" data-meeting-id="${meeting.id}" style="padding: 6px 16px; font-size: 12px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">è©³ç´°</button>
                                    ${this.canUpdate() ? `<button class="edit-meeting-btn" data-meeting-id="${meeting.id}" style="padding: 6px 12px; font-size: 11px; background: white; color: #7f8c8d; border: 1px solid #ddd; border-radius: 3px; cursor: pointer;">ç·¨é›†</button>` : ''}
                                    ${this.canDelete() ? `<button class="delete-meeting-btn" data-meeting-id="${meeting.id}" style="padding: 6px 12px; font-size: 11px; background: white; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                content.innerHTML = html;
                
                // â˜… DOMã«è¿½åŠ ã•ã‚ŒãŸå¾Œã€ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
                if (meetings.length > 0) {
                    setTimeout(() => {
                        // è©³ç´°ãƒœã‚¿ãƒ³
                        const detailButtons = content.querySelectorAll('.detail-btn');
                        console.log(`Found ${detailButtons.length} detail buttons in team view`);
                        
                        detailButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const meetingId = button.getAttribute('data-meeting-id');
                                console.log('Detail button clicked:', meetingId);
                                this.showMeetingView(meetingId);
                            });
                        });
                        
                        // ç·¨é›†ãƒœã‚¿ãƒ³
                        const editButtons = content.querySelectorAll('.edit-meeting-btn');
                        editButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const meetingId = button.getAttribute('data-meeting-id');
                                this.openEditMeetingModal(meetingId);
                            });
                        });
                        
                        // å‰Šé™¤ãƒœã‚¿ãƒ³
                        const deleteButtons = content.querySelectorAll('.delete-meeting-btn');
                        deleteButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const meetingId = button.getAttribute('data-meeting-id');
                                this.deleteMeeting(meetingId);
                            });
                        });
                        
                        console.log('âœ… All button handlers attached in team view');
                    }, 100);
                }
            },
            
            async showMeetingView(meetingId) {
                console.log('showMeetingView called with:', meetingId);
                
                // Find meeting from Supabase first, then fallback to local data
                let meeting = null;
                
                // ğŸ”„ Try loading from Supabase
                console.log('ğŸ” Searching for meeting in Supabase...');
                try {
                    const { data, error } = await supabase
                        .from('meetings')
                        .select('*')
                        .eq('id', meetingId)
                        .single();
                    
                    if (data && !error) {
                        meeting = {
                            id: data.id,
                            name: data.meeting_name || data.title,
                            meetingName: data.meeting_name || data.title,
                            date: data.meeting_date || data.created_at?.split('T')[0],
                            entityId: data.entity_id,
                            entityType: data.entity_type,
                            organization: data.organization,
                            division: data.division,
                            department: data.department,
                            participants: data.participants || 0,
                            minutesCount: 0
                        };
                        console.log('âœ… Meeting found in Supabase:', meeting);
                    }
                } catch (error) {
                    console.warn('âš ï¸ Supabase query error:', error);
                }
                
                // ğŸ“¦ Fallback: Check localStorage and demoData
                if (!meeting) {
                    console.log('ğŸ” Fallback: Searching in localStorage and demoData...');
                    
                    // Check if it's a board meeting (format: meeting-board-1-0)
                    if (meetingId.includes('board')) {
                        console.log('Detected board meeting');
                        const meetings = this.demoData.generateMeetings('board-1');
                        meeting = meetings.find(m => m.id === meetingId);
                        
                        if (meeting) {
                            this.currentBoard = this.demoData.boards[0]; // æœ€åˆã®ãƒœãƒ¼ãƒ‰ã‚’ä½¿ç”¨
                            this.currentDepartment = null;
                            this.currentTeam = null;
                        }
                    } else {
                        // Find team from meetingId
                        console.log('Searching for team meeting');
                        let foundTeam = null;
                        for (const dept of this.demoData.departments) {
                            const team = dept.teams.find(t => meetingId.includes(t.id));
                            if (team) {
                                foundTeam = team;
                                this.currentTeam = team;
                                this.currentDepartment = dept;
                                this.currentBoard = null;
                                break;
                            }
                        }
                        
                        if (foundTeam) {
                            const meetings = this.demoData.generateMeetings(foundTeam.id);
                            meeting = meetings.find(m => m.id === meetingId);
                        }
                    }
                }
                
                if (!meeting) {
                    console.error('âŒ Meeting not found:', meetingId);
                    alert('ä¼šè­°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + meetingId);
                    return;
                }
                
                console.log('Meeting found:', meeting);
                
                this.currentView = 'meeting';
                this.currentMeeting = meeting;
                this.currentMinute = null;
                
                this.updateBreadcrumb();
                
                const minutes = this.demoData.generateMinutes(meetingId);
                
                const content = document.getElementById('contentArea');
                
                // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆthisã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è€ƒæ…®ï¼‰
                let backAction;
                if (this.currentBoard) {
                    backAction = 'app.showBoardView()';
                } else if (this.currentTeam && this.currentTeam.id) {
                    backAction = `app.showTeamView('${this.currentTeam.id}')`;
                } else {
                    backAction = 'app.showOrganizationView()';
                }
                
                // TOPã¨åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«é¢¨UI
                let html = `<button class="btn btn-secondary back-btn" onclick="${backAction}" style="margin-bottom: 15px; padding: 8px 16px; font-size: 13px; background: #95a5a6; color: white; border: none; border-radius: 3px;">â† æˆ»ã‚‹</button>`;
                
                const headerColor = this.currentBoard ? '#2c3e50' : '#27ae60';
                const borderColor = this.currentBoard ? '#3498db' : '#2ecc71';
                
                html += `<div style="background: ${headerColor}; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid ${borderColor};">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 18px;">ğŸ“</span>
                        <span style="color: white; font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">${meeting.name} ã®è­°äº‹éŒ²ä¸€è¦§</span>
                        <span style="color: rgba(255,255,255,0.7); font-size: 12px; margin-left: 8px;">é–‹å‚¬æ—¥: ${meeting.date}</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        ${this.canInsert() ? `
                            <button id="btn-start-recording" onclick="window.transcriptionSystem.startRecording()" style="padding: 6px 14px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-weight: 600; cursor: pointer;">ğŸ™ï¸ éŒ²éŸ³é–‹å§‹</button>
                            <button id="btn-stop-recording" onclick="window.transcriptionSystem.stopRecording('${meetingId}')" style="padding: 6px 14px; font-size: 12px; background: #c0392b; color: white; border: none; border-radius: 3px; font-weight: 600; cursor: pointer; display: none;">â¹ï¸ éŒ²éŸ³åœæ­¢</button>
                            <div id="transcription-status" style="color: white; font-size: 12px; display: none; padding: 6px 14px; background: rgba(0,0,0,0.3); border-radius: 3px;"></div>
                            <button onclick="app.showTranscriptions('${meetingId}')" style="padding: 6px 14px; font-size: 12px; background: #9b59b6; color: white; border: none; border-radius: 3px; font-weight: 600; cursor: pointer;">ğŸ“ æ–‡å­—èµ·ã“ã—ä¸€è¦§</button>
                            <button class="btn btn-sm" onclick="app.openAddMinuteModal('${meetingId}')" style="padding: 6px 14px; font-size: 12px; background: ${borderColor}; color: white; border: none; border-radius: 3px; font-weight: 600;">+ è­°äº‹éŒ²è¿½åŠ </button>
                        ` : ''}
                    </div>
                </div>`;
                
                html += '<div style="background: white; border: 1px solid #ddd; border-top: none;">';
                
                if (minutes.length === 0) {
                    html += '<div style="padding: 40px 20px; text-align: center; color: #7f8c8d; font-size: 14px;">è­°äº‹éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œ+ è­°äº‹éŒ²è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
                } else {
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¿½åŠ 
                    html += `
                        <div class="meeting-list-header" style="
                            display: grid;
                            grid-template-columns: 110px 250px 220px 140px 200px 100px 1fr;
                            align-items: center;
                            padding: 12px 20px 12px 20px;
                            background: #34495e;
                            border-bottom: 2px solid #2c3e50;
                            font-weight: 700;
                            color: white;
                            font-size: 13px;
                        ">
                            <div>ä¼šè­°æ—¥</div>
                            <div>ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«</div>
                            <div>ä¼šè­°å‚åŠ è€…</div>
                            <div>ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼</div>
                            <div>å‚™è€ƒ</div>
                            <div style="text-align: center;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                            <div style="text-align: right; padding-right: 0;">æ“ä½œ</div>
                        </div>
                    `;
                    
                    // è­°äº‹éŒ²ã‚’é™é †ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„ã‚‚ã®ãŒä¸Šï¼‰
                    const sortedMinutes = [...minutes].sort((a, b) => {
                        const dateA = new Date(a.meetingDate || a.created || 0);
                        const dateB = new Date(b.meetingDate || b.created || 0);
                        return dateB - dateA; // é™é †
                    });
                    
                    const statusMap = {
                        'not-held': { color: '#f39c12', text: 'ä¼šè­°æœªå®Ÿæ–½', badge: 'badge-not-held' },  // ã‚ªãƒ¬ãƒ³ã‚¸
                        'completed-with-tasks': { color: '#e74c3c', text: 'ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼‰', badge: 'badge-completed-with-tasks' },  // èµ¤
                        'completed-no-tasks': { color: '#3498db', text: 'ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ãªã—ï¼‰', badge: 'badge-completed-no-tasks' },  // é’
                        // æ—§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆäº’æ›æ€§ï¼‰
                        'pending': { color: '#f39c12', text: 'æœªç€æ‰‹', badge: 'badge-pending' },
                        'progress': { color: '#3498db', text: 'é€²è¡Œä¸­', badge: 'badge-progress' },
                        'completed': { color: '#27ae60', text: 'å®Œäº†', badge: 'badge-completed' },
                        'overdue': { color: '#e74c3c', text: 'æœŸé™è¶…é', badge: 'badge-overdue' }
                    };
                    
                    sortedMinutes.forEach((minute, index) => {
                        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                        const status = statusMap[minute.status] || statusMap['not-held'];
                        
                        // å‚åŠ è€…ã®è¡¨ç¤ºï¼ˆé…åˆ—ã¾ãŸã¯æ–‡å­—åˆ—å¯¾å¿œï¼‰
                        let participantsList = '';
                        if (Array.isArray(minute.participants)) {
                            // é…åˆ—ã®å ´åˆ: ãã®ã¾ã¾çµåˆ
                            participantsList = minute.participants.map(p => typeof p === 'string' ? p.trim() : (p.name || '')).filter(p => p).join(', ');
                        } else if (typeof minute.participants === 'string') {
                            // æ–‡å­—åˆ—ã®å ´åˆ: æ”¹è¡Œã¾ãŸã¯ã‚«ãƒ³ãƒã§åˆ†å‰²
                            participantsList = minute.participants.split(/[\n,]/).map(p => p.trim()).filter(p => p).join(', ');
                        }
                        const participantsDisplay = participantsList.length > 60 ? participantsList.substring(0, 60) + '...' : participantsList || '-';
                        
                        // å‚™è€ƒã®è¡¨ç¤º
                        const notesDisplay = (minute.notes || '-').substring(0, 60);
                        const notesShort = notesDisplay.length >= 60 ? notesDisplay + '...' : notesDisplay;
                        
                        html += `
                            <div class="meeting-list-row inline-editable-row" data-minute-id="${minute.id}" style="
                                display: grid;
                                grid-template-columns: 110px 250px 220px 140px 200px 100px 1fr;
                                align-items: center;
                                padding: 10px 20px 10px 20px;
                                background: ${bgColor};
                                border-bottom: 1px solid #e9ecef;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#e8f5e9'" onmouseout="this.style.background='${bgColor}'">
                                <div style="display: flex; align-items: center; gap: 6px; position: relative;">
                                    <span style="font-size: 16px; ${this.canUpdate() ? 'cursor: pointer;' : 'cursor: not-allowed; opacity: 0.5;'} user-select: none;" ${this.canUpdate() ? `onclick="app.showDatePicker('${minute.id}')"` : ''} title="${this.canUpdate() ? 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠ' : 'ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'}">ğŸ“…</span>
                                    <div class="inline-edit" data-field="meetingDate" style="font-size: 13px; color: #2c3e50; font-weight: 600; ${this.canUpdate() ? 'cursor: text;' : 'cursor: not-allowed;'} padding: 4px; border-radius: 3px; flex: 1;" contenteditable="${this.canUpdate()}">${minute.meetingDate || '-'}</div>
                                    <input type="date" id="datePicker-${minute.id}" style="position: absolute; left: 0; top: 0; opacity: 0; width: 1px; height: 1px; pointer-events: none;" onchange="app.updateMeetingDate('${minute.id}', this.value)">
                                </div>
                                <div class="inline-edit" data-field="subtitle" style="font-size: 14px; font-weight: 700; color: #2c3e50; ${this.canUpdate() ? 'cursor: text;' : 'cursor: not-allowed;'} padding: 4px; border-radius: 3px;" contenteditable="${this.canUpdate()}">${minute.subtitle || minute.meetingName || 'è­°äº‹éŒ²'}</div>
                                <div class="inline-edit" data-field="participants" style="font-size: 12px; color: #7f8c8d; ${this.canUpdate() ? 'cursor: text;' : 'cursor: not-allowed;'} padding: 4px; border-radius: 3px;" contenteditable="${this.canUpdate()}" title="${minute.participants || ''}">${participantsDisplay}</div>
                                <div class="inline-edit" data-field="facilitator" style="font-size: 12px; color: #7f8c8d; ${this.canUpdate() ? 'cursor: text;' : 'cursor: not-allowed;'} padding: 4px; border-radius: 3px;" contenteditable="${this.canUpdate()}">${minute.facilitator || '-'}</div>
                                <div class="inline-edit" data-field="notes" style="font-size: 11px; color: #95a5a6; ${this.canUpdate() ? 'cursor: text;' : 'cursor: not-allowed;'} padding: 4px; border-radius: 3px;" contenteditable="${this.canUpdate()}" title="${minute.notes || ''}">${minute.notes || '-'}</div>
                                <div style="text-align: center;">
                                    <select class="status-dropdown" data-field="status" ${this.canUpdate() ? '' : 'disabled'}
                                        style="background: ${status.color}; color: white; padding: 6px 24px 6px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; border: none; ${this.canUpdate() ? 'cursor: pointer;' : 'cursor: not-allowed; opacity: 0.6;'} appearance: none; 
                                        background-image: url('data:image/svg+xml;utf8,<svg fill=\"white\" height=\"20\" viewBox=\"0 0 24 24\" width=\"20\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M7 10l5 5 5-5z\"/></svg>'); 
                                        background-repeat: no-repeat; 
                                        background-position: right 4px center; 
                                        background-size: 16px; 
                                        transition: all 0.2s ease;"
                                        ${this.canUpdate() ? `onmouseover="this.style.transform = 'scale(1.05)'; this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';" onmouseout="this.style.transform = 'scale(1)'; this.style.boxShadow = 'none';"` : ''}>
                                        <option value="not-held" ${minute.status === 'not-held' ? 'selected' : ''}>ä¼šè­°æœªå®Ÿæ–½</option>
                                        <option value="completed-with-tasks" ${minute.status === 'completed-with-tasks' ? 'selected' : ''}>ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼‰</option>
                                        <option value="completed-no-tasks" ${minute.status === 'completed-no-tasks' ? 'selected' : ''}>ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ãªã—ï¼‰</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 6px; justify-content: flex-end; padding-right: 0;">
                                    <button class="detail-minute-btn" data-minute-id="${minute.id}" style="padding: 6px 16px; font-size: 12px; background: ${headerColor}; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">è©³ç´°</button>
                                    ${this.canDelete() ? `<button class="delete-minute-btn" data-minute-id="${minute.id}" style="padding: 6px 12px; font-size: 11px; background: white; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 3px; cursor: pointer;">å‰Šé™¤</button>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                content.innerHTML = html;
                
                // â˜… DOMã«è¿½åŠ ã•ã‚ŒãŸå¾Œã€ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
                if (minutes.length > 0) {
                    setTimeout(() => {
                        // è©³ç´°ãƒœã‚¿ãƒ³
                        const detailButtons = content.querySelectorAll('.detail-minute-btn');
                        detailButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const minuteId = button.getAttribute('data-minute-id');
                                this.showMinuteDetailTable(minuteId);
                            });
                        });
                        
                        // ç·¨é›†ãƒœã‚¿ãƒ³
                        const editButtons = content.querySelectorAll('.edit-minute-btn');
                        editButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const minuteId = button.getAttribute('data-minute-id');
                                this.openEditMinuteModal(minuteId);
                            });
                        });
                        
                        // å‰Šé™¤ãƒœã‚¿ãƒ³
                        const deleteButtons = content.querySelectorAll('.delete-minute-btn');
                        deleteButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const minuteId = button.getAttribute('data-minute-id');
                                this.archiveMinute(minuteId);
                            });
                        });
                        
                        console.log('âœ… All minute button handlers attached');
                    }, 100);
                }
            },
            
            openAddMeetingModal(entityId) {
                const meetingName = prompt('æ–°ã—ã„ä¼šè­°åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
                if (!meetingName || meetingName.trim() === '') {
                    return;
                }
                
                // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£IDã‹ã‚‰çµ„ç¹”æƒ…å ±ã‚’å–å¾—
                let organization = '', division = '', department = '';
                if (entityId.startsWith('board')) {
                    organization = 'ãƒœãƒ¼ãƒ‰';
                } else if (entityId.startsWith('dept')) {
                    const dept = this.demoData.departments.find(d => d.id === entityId);
                    if (dept) {
                        division = dept.name;
                    }
                } else if (entityId.startsWith('team')) {
                    const dept = this.demoData.departments.find(d => 
                        d.teams.some(t => t.id === entityId)
                    );
                    if (dept) {
                        division = dept.name;
                        const team = dept.teams.find(t => t.id === entityId);
                        if (team) {
                            department = team.name;
                        }
                    }
                }
                
                // æ–°ã—ã„ä¼šè­°ã‚’ä½œæˆ
                const newMeeting = {
                    id: generateUUID(),
                    entityId: entityId,
                    name: meetingName.trim(),
                    meetingName: meetingName.trim(),
                    organization: organization,
                    division: division,
                    department: department,
                    date: new Date().toISOString().split('T')[0],
                    minutesCount: 0,
                    participants: 0
                };
                
                // Supabaseã«ä¿å­˜ï¼ˆéåŒæœŸï¼‰
                (async () => {
                    try {
                        const savedMeeting = await this.saveMeetingToSupabase(newMeeting);
                        console.log('âœ… ä¼šè­°ã‚’Supabaseã«ä¿å­˜ã—ã¾ã—ãŸ:', savedMeeting);
                        
                        // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                        newMeeting.id = savedMeeting.id;
                        newMeeting.createdBy = savedMeeting.created_by;
                        newMeeting.createdAt = savedMeeting.created_at;
                        
                        // LocalStorageã«ã‚‚ä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
                        if (!this.meetingsData[entityId]) {
                            this.meetingsData[entityId] = [];
                        }
                        this.meetingsData[entityId].push(newMeeting);
                        this.saveToLocalStorage();
                        
                        alert(`âœ… ä¼šè­°ã€Œ${meetingName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                        
                        // ç”»é¢ã‚’å†è¡¨ç¤º
                        if (entityId === 'board-1') {
                            this.showBoardView();
                        } else {
                            this.showTeamView(entityId);
                        }
                        
                    } catch (error) {
                        console.error('âŒ ä¼šè­°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        alert(`âŒ ä¼šè­°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\n\nãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                        
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚localStorageã«ã¯ä¿å­˜
                        if (!this.meetingsData[entityId]) {
                            this.meetingsData[entityId] = [];
                        }
                        this.meetingsData[entityId].push(newMeeting);
                        this.saveToLocalStorage();
                        
                        // ç”»é¢ã‚’å†è¡¨ç¤º
                        if (entityId === 'board-1') {
                            this.showBoardView();
                        } else {
                            this.showTeamView(entityId);
                        }
                    }
                })();
            },
            
            async openEditMeetingModal(meetingId) {
                console.log('âœï¸ ä¼šè­°ç·¨é›†é–‹å§‹:', meetingId);
                
                // ä¼šè­°ã‚’æ¤œç´¢
                let meeting = null;
                let entityId = null;
                
                for (const [key, meetings] of Object.entries(this.meetingsData)) {
                    meeting = meetings.find(m => m.id === meetingId);
                    if (meeting) {
                        entityId = key;
                        break;
                    }
                }
                
                if (!meeting) {
                    alert('âŒ ä¼šè­°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const newName = prompt('ä¼šè­°åç§°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ï¼š', meeting.name || meeting.meetingName);
                if (!newName || newName.trim() === '') {
                    return;
                }
                
                try {
                    // 1. Supabase ã‚’æ›´æ–°
                    console.log('ğŸ“¥ Supabase ã‚’æ›´æ–°ä¸­...', meetingId);
                    const { error } = await supabase
                        .from('meetings')
                        .update({ 
                            meeting_name: newName.trim(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', meetingId);
                    
                    if (error) {
                        console.error('âŒ Supabaseæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                        throw error;
                    }
                    
                    console.log('âœ… Supabase æ›´æ–°å®Œäº†');
                    
                    // 2. localStorage ã‚’æ›´æ–°
                    meeting.name = newName.trim();
                    meeting.meetingName = newName.trim();
                    this.saveToLocalStorage();
                    
                    alert(`âœ… ä¼šè­°åç§°ã‚’ã€Œ${newName}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
                    
                    // 3. ç”»é¢ã‚’å†è¡¨ç¤º
                    if (this.currentBoard) {
                        this.showBoardView();
                    } else if (this.currentTeam) {
                        this.showTeamView(this.currentTeam.id);
                    }
                    
                } catch (error) {
                    console.error('âŒ ä¼šè­°ç·¨é›†ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`âŒ ä¼šè­°åç§°ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            },
            
            async deleteMeeting(meetingId) {
                console.log('ğŸ—‘ï¸ ä¼šè­°å‰Šé™¤é–‹å§‹:', meetingId);
                
                // è­°äº‹éŒ²ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (this.minutesData[meetingId]) {
                    const minutes = this.minutesData[meetingId].filter(m => !m.archived);
                    if (minutes.length > 0) {
                        alert(`âŒ ã“ã®ä¼šè­°ã«ã¯${minutes.length}ä»¶ã®è­°äº‹éŒ²ãŒã‚ã‚‹ãŸã‚ã€å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚\nå…ˆã«è­°äº‹éŒ²ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`);
                        return;
                    }
                }
                
                // ä¼šè­°ã‚’æ¤œç´¢
                let meeting = null;
                let entityId = null;
                
                for (const [key, meetings] of Object.entries(this.meetingsData)) {
                    const index = meetings.findIndex(m => m.id === meetingId);
                    if (index !== -1) {
                        meeting = meetings[index];
                        entityId = key;
                        break;
                    }
                }
                
                if (!meeting) {
                    alert('âŒ ä¼šè­°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                if (!confirm(`ä¼šè­°ã€Œ${meeting.name || meeting.meetingName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                
                try {
                    // 1. Supabase ã‹ã‚‰å‰Šé™¤
                    console.log('ğŸ“¥ Supabase ã‹ã‚‰å‰Šé™¤ä¸­...', meetingId);
                    const { error } = await supabase
                        .from('meetings')
                        .delete()
                        .eq('id', meetingId);
                    
                    if (error) {
                        console.error('âŒ Supabaseå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        throw error;
                    }
                    
                    console.log('âœ… Supabase ã‹ã‚‰å‰Šé™¤å®Œäº†');
                    
                    // 2. localStorage ã‹ã‚‰å‰Šé™¤
                    for (const [key, meetings] of Object.entries(this.meetingsData)) {
                        const index = meetings.findIndex(m => m.id === meetingId);
                        if (index !== -1) {
                            meetings.splice(index, 1);
                            break;
                        }
                    }
                    this.saveToLocalStorage();
                    
                    alert(`âœ… ä¼šè­°ã€Œ${meeting.name || meeting.meetingName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    
                    // 3. ç”»é¢ã‚’å†è¡¨ç¤º
                    if (this.currentBoard) {
                        this.showBoardView();
                    } else if (this.currentTeam) {
                        this.showTeamView(this.currentTeam.id);
                    }
                    
                } catch (error) {
                    console.error('âŒ ä¼šè­°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`âŒ ä¼šè­°ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            },
            
            // ========== Board Management ==========
            addBoard() {
                const name = prompt('æ–°ã—ã„ãƒœãƒ¼ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
                if (name && name.trim()) {
                    const newBoard = {
                        id: `board-${Date.now()}`,
                        name: name.trim()
                    };
                    this.demoData.boards.push(newBoard);
                    alert('âœ… ãƒœãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    this.showOrganizationView();
                }
            },
            
            editBoard(boardId) {
                const board = this.demoData.boards.find(b => b.id === boardId);
                if (!board) {
                    alert('âŒ ãƒœãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const newName = prompt('ãƒœãƒ¼ãƒ‰åã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼š', board.name);
                if (newName && newName.trim()) {
                    board.name = newName.trim();
                    alert('âœ… ãƒœãƒ¼ãƒ‰åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                    this.showOrganizationView();
                }
            },
            
            deleteBoard(boardId) {
                // ä¼šè­°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
                const hasMeetings = this.getMeetingCount(boardId) > 0;
                if (hasMeetings) {
                    alert('âŒ ã“ã®ãƒœãƒ¼ãƒ‰ã«ã¯ä¼šè­°ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“');
                    return;
                }
                
                if (confirm('ã“ã®ãƒœãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    const index = this.demoData.boards.findIndex(b => b.id === boardId);
                    if (index !== -1) {
                        this.demoData.boards.splice(index, 1);
                        alert('âœ… ãƒœãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                        this.showOrganizationView();
                    }
                }
            },
            
            // ========== Department Management ==========
            addDepartment() {
                const name = prompt('æ–°ã—ã„éƒ¨é–€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
                if (name && name.trim()) {
                    const newDept = {
                        id: `dept-${Date.now()}`,
                        name: name.trim(),
                        teams: []
                    };
                    this.demoData.departments.push(newDept);
                    alert('âœ… éƒ¨é–€ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    this.showOrganizationView();
                }
            },
            
            editDepartment(deptId) {
                const dept = this.demoData.departments.find(d => d.id === deptId);
                if (!dept) {
                    alert('âŒ éƒ¨é–€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const newName = prompt('éƒ¨é–€åã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼š', dept.name);
                if (newName && newName.trim()) {
                    dept.name = newName.trim();
                    alert('âœ… éƒ¨é–€åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                    this.showOrganizationView();
                }
            },
            
            deleteDepartment(deptId) {
                const dept = this.demoData.departments.find(d => d.id === deptId);
                if (!dept) {
                    alert('âŒ éƒ¨é–€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                if (dept.teams.length > 0) {
                    alert('âŒ ãƒãƒ¼ãƒ ãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚å…ˆã«ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                if (confirm(`éƒ¨é–€ã€Œ${dept.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    const index = this.demoData.departments.findIndex(d => d.id === deptId);
                    this.demoData.departments.splice(index, 1);
                    alert('âœ… éƒ¨é–€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    this.showOrganizationView();
                }
            },
            
            // ========== Team Management ==========
            addTeam(deptId) {
                const dept = this.demoData.departments.find(d => d.id === deptId);
                if (!dept) {
                    alert('âŒ éƒ¨é–€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const name = prompt('æ–°ã—ã„ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
                if (name && name.trim()) {
                    const newTeam = {
                        id: `team-${Date.now()}`,
                        name: name.trim(),
                        departmentId: deptId,
                        meetingCount: 0
                    };
                    dept.teams.push(newTeam);
                    alert('âœ… ãƒãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    this.showOrganizationView();
                }
            },
            
            editTeam(teamId) {
                let team = null;
                let dept = null;
                
                for (const d of this.demoData.departments) {
                    const t = d.teams.find(tm => tm.id === teamId);
                    if (t) {
                        team = t;
                        dept = d;
                        break;
                    }
                }
                
                if (!team) {
                    alert('âŒ ãƒãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const newName = prompt('ãƒãƒ¼ãƒ åã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼š', team.name);
                if (newName && newName.trim()) {
                    team.name = newName.trim();
                    alert('âœ… ãƒãƒ¼ãƒ åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                    this.showOrganizationView();
                }
            },
            
            deleteTeam(teamId) {
                let team = null;
                let dept = null;
                
                for (const d of this.demoData.departments) {
                    const t = d.teams.find(tm => tm.id === teamId);
                    if (t) {
                        team = t;
                        dept = d;
                        break;
                    }
                }
                
                if (!team) {
                    alert('âŒ ãƒãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // Check if team has meetings
                const teamMeetings = this.meetingsData[teamId];
                if (teamMeetings && teamMeetings.length > 0) {
                    alert('âŒ ä¼šè­°ãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚å…ˆã«ä¼šè­°ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                if (confirm(`ãƒãƒ¼ãƒ ã€Œ${team.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    const index = dept.teams.findIndex(t => t.id === teamId);
                    dept.teams.splice(index, 1);
                    alert('âœ… ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    this.showOrganizationView();
                }
            },
            
            showMinuteDetail(minuteId) {
                // Find minute
                let minute = null;
                for (const meetingId in this.minutesData) {
                    minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) break;
                }
                
                if (!minute) return;
                
                this.currentView = 'minute';
                this.currentMinute = minute;
                
                this.updateBreadcrumb();
                
                const statusMap = {
                    'not-held': { class: 'badge-not-held', text: 'ä¼šè­°æœªå®Ÿæ–½' },
                    'completed-with-tasks': { class: 'badge-completed-with-tasks', text: 'ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼‰' },
                    'completed-no-tasks': { class: 'badge-completed-no-tasks', text: 'ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ãªã—ï¼‰' },
                    // æ—§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆäº’æ›æ€§ï¼‰
                    'pending': { class: 'badge-pending', text: 'æœªç€æ‰‹' },
                    'progress': { class: 'badge-progress', text: 'é€²è¡Œä¸­' },
                    'completed': { class: 'badge-completed', text: 'å®Œäº†' },
                    'overdue': { class: 'badge-overdue', text: 'æœŸé™è¶…é' }
                };
                const status = statusMap[minute.status] || statusMap['not-held'];
                
                const content = document.getElementById('contentArea');
                let html = `<button class="btn btn-secondary back-btn" onclick="app.showMeetingView('${this.currentMeeting.id}')">â† æˆ»ã‚‹</button>`;
                html += '<div class="card">';
                html += `<div class="card-title">
                    <span>ğŸ“„ è­°äº‹éŒ²è©³ç´°</span>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="app.openEditMinuteModal('${minute.id}')">ç·¨é›†</button>
                        <button class="btn btn-danger" onclick="app.archiveMinute('${minute.id}')">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
                    </div>
                </div>`;
                
                html += '<div class="detail-section">';
                html += '<div class="detail-section-title">åŸºæœ¬æƒ…å ±</div>';
                html += '<div class="detail-grid">';
                html += `<div class="detail-item"><div class="detail-label">è­°é¡Œ</div><div class="detail-value">${minute.topic}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">æ‹…å½“è€…</div><div class="detail-value">${minute.assignee}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">æœŸæ—¥</div><div class="detail-value">${minute.dueDate}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div><div class="detail-value"><span class="badge ${status.class}">${status.text}</span></div></div>`;
                html += '</div></div>';
                
                html += '<div class="detail-section">';
                html += '<div class="detail-section-title">æ±ºå®šäº‹é …</div>';
                html += `<div class="detail-content">${minute.decision}</div>`;
                html += '</div>';
                
                html += '<div class="detail-section">';
                html += '<div class="detail-section-title">èª²é¡Œ</div>';
                html += `<div class="detail-content">${minute.issue}</div>`;
                html += '</div>';
                
                html += '<div class="detail-section">';
                html += '<div class="detail-section-title">å®Ÿè¡Œå†…å®¹</div>';
                html += `<div class="detail-content">${minute.action}</div>`;
                html += '</div>';
                
                html += '<div class="detail-section">';
                html += '<div class="detail-section-title">ç†ç”±ãƒ»èƒŒæ™¯</div>';
                html += `<div class="detail-content">${minute.reason}</div>`;
                html += '</div>';
                
                html += '</div>';
                content.innerHTML = html;
            },
            
            showMinuteDetailTable(minuteId) {
                // Find minute
                let minute = null;
                for (const meetingId in this.minutesData) {
                    minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) break;
                }
                
                if (!minute) return;
                
                // Ensure attachedFiles array exists
                if (!minute.attachedFiles) {
                    minute.attachedFiles = [];
                }
                
                console.log('showMinuteDetailTable - minute with files:', minute);
                console.log('Attached files:', minute.attachedFiles);
                
                this.currentView = 'minute';
                this.currentMinute = minute;
                
                this.updateBreadcrumb();
                
                const content = document.getElementById('contentArea');
                
                // TOPã¨åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«é¢¨UI - æˆ»ã‚‹ãƒœã‚¿ãƒ³
                let html = `<button class="btn btn-secondary back-btn" onclick="app.showMeetingView('${this.currentMeeting.id}')" style="margin-bottom: 15px; padding: 8px 16px; font-size: 13px; background: #95a5a6; color: white; border: none; border-radius: 3px;">â† æˆ»ã‚‹</button>`;
                
                // TOPã¨åŒã˜ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³
                const headerColor = this.currentBoard ? '#2c3e50' : '#27ae60';
                const borderColor = this.currentBoard ? '#3498db' : '#2ecc71';
                
                html += `<div style="background: ${headerColor}; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid ${borderColor}; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 18px;">ğŸ“Š</span>
                        <span style="color: white; font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">${minute.meetingName || 'ä¼šè­°å'} ã®è­°äº‹éŒ²è©³ç´°</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm" id="deleteSelectedBtn" onclick="app.deleteSelectedRows()" style="padding: 6px 14px; font-size: 12px; background: #c0392b; color: white; border: none; border-radius: 3px; font-weight: 600; display: none;">ğŸ—‘ï¸ é¸æŠå‰Šé™¤ (<span id="selectedCount">0</span>)</button>
                        <button class="btn btn-sm" onclick="app.openAIAnalysisModal()" style="padding: 6px 14px; font-size: 12px; background: #27ae60; color: white; border: none; border-radius: 3px; font-weight: 600;">ğŸ¤– AIè§£æ</button>
                        <div class="dropdown" style="position: relative;">
                            <button class="btn btn-sm" id="exportMenuBtn" onclick="app.toggleExportMenu(event)" style="padding: 6px 14px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 3px; font-weight: 600; cursor: pointer;">
                                ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                            <div id="exportMenu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); margin-top: 5px; min-width: 180px; z-index: 1000;">
                                <button onclick="app.exportPDF()" style="width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">ğŸ“„ PDF</button>
                                <button onclick="app.exportWord()" style="width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">ğŸ“ Word</button>
                                <button onclick="app.exportExcel()" style="width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">ğŸ“Š Excel</button>
                                <button onclick="app.exportCSV()" style="width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">ğŸ“‹ CSV</button>
                                <button onclick="app.exportTXT()" style="width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">ğŸ“ƒ TXT</button>
                            </div>
                        </div>
                        <button class="btn btn-sm" onclick="app.addNewDetailRow()" style="padding: 6px 14px; font-size: 12px; background: ${borderColor}; color: white; border: none; border-radius: 3px; font-weight: 600;">+ è¡Œã‚’è¿½åŠ </button>
                        <button class="btn btn-sm" onclick="app.saveDetailTable('${minute.id}')" id="saveButton" style="padding: 6px 14px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-weight: 600; transition: all 0.3s ease;">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>`;
                
                // ä¼šè­°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰+ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ—§4ã¤ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
                const minuteStatusMap = {
                    'pending': 'æœªç€æ‰‹',
                    'progress': 'é€²è¡Œä¸­',
                    'completed': 'å®Œäº†',
                    'overdue': 'æœŸé™è¶…é',
                    // æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®äº’æ›æ€§
                    'not-held': 'æœªç€æ‰‹',
                    'completed-with-tasks': 'é€²è¡Œä¸­',
                    'completed-no-tasks': 'å®Œäº†'
                };
                const displayStatus = minuteStatusMap[minute.status] || 'æœªç€æ‰‹';
                
                html += `<div style="background: #ecf0f1; padding: 10px 15px; margin-bottom: 12px; border-left: 4px solid ${borderColor}; font-size: 13px;">
                    <strong>ä¼šè­°åï¼š</strong><span style="color: #2c3e50;">${minute.meetingName || ''}</span> &nbsp;&nbsp;
                    <strong>é–‹å‚¬æ—¥ï¼š</strong><span style="color: #2c3e50;">${minute.meetingDate || ''}</span> &nbsp;&nbsp;
                    <strong>ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼š</strong><span style="color: #2c3e50;">${minute.subtitle || ''}</span> &nbsp;&nbsp;
                    <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š</strong><span style="color: #2c3e50;">${displayStatus}</span>
                </div>`;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰
                html += `<div style="background: white; padding: 12px 15px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 3px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="font-size: 13px; color: #2c3e50;">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</strong>
                        <label for="fileUpload-${minute.id}" class="btn btn-sm" style="padding: 5px 12px; font-size: 12px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer; margin: 0; font-weight: 600;">
                            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ 
                        </label>
                        <input type="file" id="fileUpload-${minute.id}" multiple style="display: none;" onchange="app.handleFileUpload(event, '${minute.id}')">
                    </div>
                    <div id="attachedFiles-${minute.id}" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${this.renderAttachedFiles(minute)}
                    </div>
                </div>`;
                
                // Google Sheetsé¢¨ã®ç·¨é›†å¯èƒ½ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è‰²ã‚’çµ±ä¸€ï¼‰
                html += '<div style="overflow-x: auto;">';
                html += '<table class="editable-table" style="width: 100%; border-collapse: collapse; background: white;">';
                html += `
                    <thead>
                        <tr style="background-color: ${headerColor}; color: white;">
                            <th style="padding: 10px; border: 1px solid #ccc; width: 40px; text-align: center; font-weight: 600; font-size: 13px;">
                                <input type="checkbox" id="selectAllRows" onchange="app.toggleSelectAll()" style="cursor: pointer; width: 16px; height: 16px;">
                            </th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 3%; text-align: center; font-weight: 600; font-size: 13px;">#</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 15%; font-weight: 600; font-size: 13px;">è­°é¡Œãƒ»ã‚¢ã‚¸ã‚§ãƒ³ãƒ€</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 15%; font-weight: 600; font-size: 13px;">å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%; font-weight: 600; font-size: 13px;">æ‹…å½“è€…</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 8%; font-weight: 600; font-size: 13px;">æœŸé™</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 15%; font-weight: 600; font-size: 13px;">ç›®çš„ãƒ»æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%; font-weight: 600; font-size: 13px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%; font-weight: 600; font-size: 13px;">å‚™è€ƒ1</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%; font-weight: 600; font-size: 13px;">å‚™è€ƒ2</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 4%; font-weight: 600; font-size: 13px; text-align: center;">å‰Šé™¤</th>
                        </tr>
                    </thead>
                    <tbody id="editableTableBody">
                `;
                
                // Initialize detail rows if not exists
                if (!minute.detailRows || minute.detailRows.length === 0) {
                    minute.detailRows = [{
                        agenda: '',
                        action: '',
                        assignee: minute.facilitator || '',
                        deadline: minute.meetingDate || '',
                        purpose: '',
                        status: 'pending',  // æ—§4ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æœªç€æ‰‹
                        notes1: '',
                        notes2: ''
                    }];
                }
                
                // Render rows with ORIGINAL 4-status system
                minute.detailRows.forEach((row, index) => {
                    // ORIGINAL: 4 Status System (æœªç€æ‰‹ãƒ»é€²è¡Œä¸­ãƒ»å®Œäº†ãƒ»æœŸé™è¶…é)
                    const statusOptions = ['pending', 'progress', 'completed', 'overdue'];
                    const statusConfig = {
                        'pending': { 
                            text: 'æœªç€æ‰‹', 
                            color: '#999',  // Gray
                            bg: '#f5f5f5'
                        },
                        'progress': { 
                            text: 'é€²è¡Œä¸­', 
                            color: '#999',  // Gray
                            bg: '#f5f5f5'
                        },
                        'completed': { 
                            text: 'å®Œäº†', 
                            color: '#999',  // Gray
                            bg: '#f5f5f5'
                        },
                        'overdue': { 
                            text: 'æœŸé™è¶…é', 
                            color: '#999',  // Gray
                            bg: '#f5f5f5'
                        }
                    };
                    
                    // æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ—§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«è‡ªå‹•å¤‰æ›ï¼ˆé€†å¤‰æ›ï¼‰
                    if (row.status === 'not-held') row.status = 'pending';
                    if (row.status === 'completed-with-tasks') row.status = 'progress';
                    if (row.status === 'completed-no-tasks') row.status = 'completed';
                    
                    // Get current status color
                    const currentStatus = row.status || 'pending';
                    const statusStyle = statusConfig[currentStatus] || statusConfig['pending'];
                    
                    html += `
                        <tr id="detail-row-${index}" class="editable-row" style="background: ${index % 2 === 0 ? '#ffffff' : '#f9f9f9'};">
                            <td data-label="é¸æŠ" style="padding: 8px; border: 1px solid #d0d0d0; text-align: center;">
                                <input type="checkbox" class="row-checkbox" data-row="${index}" onchange="app.updateDeleteButtonState()" style="cursor: pointer; width: 16px; height: 16px;">
                            </td>
                            <td data-label="#" style="padding: 8px; border: 1px solid #d0d0d0; text-align: center; color: #666; font-weight: 500; font-size: 12px;">${index + 1}</td>
                            <td data-label="è­°é¡Œãƒ»ã‚¢ã‚¸ã‚§ãƒ³ãƒ€" style="padding: 8px; border: 1px solid #d0d0d0; font-size: 13px;" contenteditable="true" class="editable-cell" data-field="agenda" data-row="${index}">${row.agenda || ''}</td>
                            <td data-label="å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³" style="padding: 8px; border: 1px solid #d0d0d0; font-size: 13px;" contenteditable="true" class="editable-cell" data-field="action" data-row="${index}">${row.action || ''}</td>
                            <td data-label="æ‹…å½“è€…" style="padding: 8px; border: 1px solid #d0d0d0; font-size: 13px;" contenteditable="true" class="editable-cell" data-field="assignee" data-row="${index}">${row.assignee || ''}</td>
                            <td data-label="æœŸé™" style="padding: 8px; border: 1px solid #d0d0d0; font-size: 13px; position: relative;">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="font-size: 14px; cursor: pointer; user-select: none;" onclick="app.showDeadlinePicker(${index})" title="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠ">ğŸ“…</span>
                                    <div contenteditable="true" class="editable-cell" data-field="deadline" data-row="${index}" style="flex: 1;">${row.deadline || ''}</div>
                                    <input type="date" id="deadlinePicker-${index}" style="position: absolute; left: 0; top: 0; opacity: 0; width: 1px; height: 1px; pointer-events: none;" onchange="app.updateDeadline(${index}, this.value)">
                                </div>
                            </td>
                            <td data-label="ç›®çš„ãƒ»æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ" style="padding: 8px; border: 1px solid #d0d0d0; font-size: 13px;" contenteditable="true" class="editable-cell" data-field="purpose" data-row="${index}">${row.purpose || ''}</td>
                            <td data-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" style="padding: 8px; border: 1px solid #d0d0d0; font-size: 12px;">
                                <select class="status-select" data-row="${index}" 
                                    style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; cursor: pointer;">
                                    ${statusOptions.map(opt => {
                                        const config = statusConfig[opt];
                                        return `<option value="${opt}" ${row.status === opt ? 'selected' : ''}>
                                            ${config.text}
                                        </option>`;
                                    }).join('')}
                                </select>
                            </td>
                            <td data-label="å‚™è€ƒ1" style="padding: 8px; border: 1px solid #d0d0d0; font-size: 13px;" contenteditable="true" class="editable-cell" data-field="notes1" data-row="${index}">${row.notes1 || ''}</td>
                            <td data-label="å‚™è€ƒ2" style="padding: 8px; border: 1px solid #d0d0d0; font-size: 13px;" contenteditable="true" class="editable-cell" data-field="notes2" data-row="${index}">${row.notes2 || ''}</td>
                            <td data-label="å‰Šé™¤" style="padding: 8px; border: 1px solid #d0d0d0; text-align: center;">
                                <button class="btn btn-danger btn-sm" onclick="app.deleteDetailRow(${index})" style="padding: 4px 8px; font-size: 11px;">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                    </tbody>
                </table>
                </div>`;
                
                content.innerHTML = html;
                
                // Add cell focus styling
                setTimeout(() => {
                    document.querySelectorAll('.editable-cell').forEach(cell => {
                        cell.addEventListener('focus', function() {
                            this.style.outline = '2px solid #4285f4';
                            this.style.backgroundColor = '#e8f0fe';
                        });
                        cell.addEventListener('blur', function() {
                            this.style.outline = 'none';
                            this.style.backgroundColor = '';
                        });
                    });
                }, 100);
            },
            
            getStatusText(status) {
                const statusMap = {
                    'not-held': 'ä¼šè­°æœªå®Ÿæ–½',
                    'completed-with-tasks': 'ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼‰',
                    'completed-no-tasks': 'ä¼šè­°çµ‚äº†ï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ãªã—ï¼‰',
                    // æ—§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã®äº’æ›æ€§
                    'pending': 'æœªç€æ‰‹',
                    'progress': 'é€²è¡Œä¸­',
                    'completed': 'å®Œäº†',
                    'overdue': 'æœŸé™è¶…é'
                };
                return statusMap[status] || 'ä¼šè­°æœªå®Ÿæ–½';
            },
            
            addNewRow() {
                const tbody = document.getElementById('editableTableBody');
                const rowCount = tbody.querySelectorAll('.editable-row').length;
                
                const newRow = document.createElement('tr');
                newRow.id = `row-${rowCount}`;
                newRow.className = 'editable-row';
                newRow.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd;" contenteditable="true" class="editable-cell" data-field="topic">æ–°ã—ã„è­°é¡Œ</td>
                    <td style="padding: 8px; border: 1px solid #ddd;" contenteditable="true" class="editable-cell" data-field="assignee">æ‹…å½“è€…å</td>
                    <td style="padding: 8px; border: 1px solid #ddd;" contenteditable="true" class="editable-cell" data-field="deadline">${new Date().toISOString().split('T')[0]}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;" contenteditable="true" class="editable-cell" data-field="purpose">ç›®çš„ãƒ»åŠ¹æœ</td>
                    <td style="padding: 8px; border: 1px solid #ddd;" contenteditable="true" class="editable-cell" data-field="status">æœªç€æ‰‹</td>
                    <td style="padding: 8px; border: 1px solid #ddd;" contenteditable="true" class="editable-cell" data-field="source">1</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <button class="btn btn-danger btn-sm" onclick="app.deleteRow(${rowCount})" style="padding: 4px 8px; font-size: 12px;">å‰Šé™¤</button>
                    </td>
                `;
                
                tbody.appendChild(newRow);
            },
            
            deleteRow(rowIndex) {
                if (confirm('ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    const row = document.getElementById(`row-${rowIndex}`);
                    if (row) {
                        row.remove();
                    }
                }
            },
            
            // ========== File Attachment Functions ==========
            renderAttachedFiles(minute) {
                console.log('ğŸ”„ renderAttachedFiles called');
                console.log('   minute.attachedFiles:', minute.attachedFiles);
                
                if (!minute.attachedFiles || minute.attachedFiles.length === 0) {
                    return '<div style="color: #999; font-size: 13px;">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
                
                const iconMap = {
                    'pdf': 'ğŸ“„',
                    'doc': 'ğŸ“', 'docx': 'ğŸ“',
                    'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š',
                    'ppt': 'ğŸ“½ï¸', 'pptx': 'ğŸ“½ï¸',
                    'csv': 'ğŸ“‹',
                    'txt': 'ğŸ“ƒ',
                    'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
                    'zip': 'ğŸ—œï¸', 'rar': 'ğŸ—œï¸',
                    'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬'
                };
                
                let html = '';
                minute.attachedFiles.forEach((file, index) => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const icon = iconMap[ext] || 'ğŸ“';
                    
                    console.log(`   File ${index}: ${file.name}, uploading=${file.uploading}, hasUrl=${!!file.url}`);
                    
                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã®è¡¨ç¤º
                    if (file.uploading) {
                        console.log(`   â†’ Rendering as UPLOADING`);
                        html += `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 13px;">
                                <span class="spinner-small" style="width: 16px; height: 16px; border: 2px solid #ffc107; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>
                                <span style="color: #856404; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">
                                    ${file.name}
                                </span>
                                <span style="color: #856404; font-size: 11px;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
                            </div>
                        `;
                    } else {
                        console.log(`   â†’ Rendering as COMPLETED`);
                        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã®è¡¨ç¤º
                        html += `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; transition: all 0.3s;">
                                <span style="font-size: 18px;">${icon}</span>
                                <a href="#" onclick="app.openAttachedFile('${minute.id}', ${index}); return false;" style="text-decoration: none; color: #007bff; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">
                                    ${file.name}
                                </a>
                                <span style="color: #6c757d; font-size: 11px;">${this.formatFileSize(file.size)}</span>
                                <button onclick="app.deleteAttachedFile('${minute.id}', ${index})" style="padding: 2px 6px; font-size: 11px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                                    âœ•
                                </button>
                            </div>
                        `;
                    }
                });
                
                console.log('ğŸ”„ renderAttachedFiles complete, HTML length:', html.length);
                return html;
            },
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            },
            
            handleFileUpload(event, minuteId) {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                
                // Find minute
                let minute = null;
                for (const meetingId in this.minutesData) {
                    minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) break;
                }
                
                if (!minute) {
                    alert('è­°äº‹éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // Initialize attachedFiles array if not exists
                if (!minute.attachedFiles) {
                    minute.attachedFiles = [];
                }
                
                // å³åº§ã«ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã€ã®è¡¨ç¤ºã‚’è¿½åŠ 
                const filesContainer = document.getElementById(`attachedFiles-${minuteId}`);
                let processedCount = 0;
                const totalFiles = files.length;
                
                // Process each file
                Array.from(files).forEach((file, index) => {
                    // ã™ãã«ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ 
                    const tempId = `temp-${Date.now()}-${index}`;
                    minute.attachedFiles.push({
                        id: tempId,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: null, // ã¾ã èª­ã¿è¾¼ã¿ä¸­
                        uploadDate: new Date().toISOString(),
                        uploading: true // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ãƒ•ãƒ©ã‚°
                    });
                    
                    // ã™ãã«è¡¨ç¤ºã‚’æ›´æ–°
                    if (filesContainer) {
                        filesContainer.innerHTML = this.renderAttachedFiles(minute);
                    }
                    
                    // Create FileReader to read file as Data URL
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        console.log(`âœ… File loaded: ${file.name}, tempId: ${tempId}`);
                        
                        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆ
                        const fileObj = minute.attachedFiles.find(f => f.id === tempId);
                        console.log('Found fileObj:', fileObj);
                        
                        if (fileObj) {
                            fileObj.url = e.target.result; // Data URL
                            fileObj.uploading = false; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†
                            delete fileObj.id; // ä¸€æ™‚IDã‚’å‰Šé™¤
                            console.log('Updated fileObj:', fileObj);
                        } else {
                            console.error('âš ï¸ fileObj not found for tempId:', tempId);
                        }
                        
                        processedCount++;
                        console.log(`Processed ${processedCount}/${totalFiles} files`);
                        
                        // Save to localStorage
                        this.saveToLocalStorage();
                        
                        // å†åº¦è¡¨ç¤ºã‚’æ›´æ–°
                        if (filesContainer) {
                            console.log('Re-rendering attached files...');
                            filesContainer.innerHTML = this.renderAttachedFiles(minute);
                        }
                        
                        // å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                        if (processedCount === totalFiles) {
                            this.showSaveSuccessMessage(`âœ… ${totalFiles}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
                        }
                    };
                    
                    reader.onerror = () => {
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å‰Šé™¤
                        const fileIndex = minute.attachedFiles.findIndex(f => f.id === tempId);
                        if (fileIndex !== -1) {
                            minute.attachedFiles.splice(fileIndex, 1);
                        }
                        
                        // è¡¨ç¤ºã‚’æ›´æ–°
                        if (filesContainer) {
                            filesContainer.innerHTML = this.renderAttachedFiles(minute);
                        }
                        
                        alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ`);
                    };
                    
                    reader.readAsDataURL(file);
                });
                
                // Reset input
                event.target.value = '';
            },
            
            deleteAttachedFile(minuteId, fileIndex) {
                if (!confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                
                // Find minute
                let minute = null;
                for (const meetingId in this.minutesData) {
                    minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) break;
                }
                
                if (!minute || !minute.attachedFiles) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // Remove file
                minute.attachedFiles.splice(fileIndex, 1);
                
                // Save to localStorage
                this.saveToLocalStorage();
                
                // Re-render
                const filesContainer = document.getElementById(`attachedFiles-${minuteId}`);
                if (filesContainer) {
                    filesContainer.innerHTML = this.renderAttachedFiles(minute);
                }
                
                alert('âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            },
            
            openAttachedFile(minuteId, fileIndex) {
                console.log('openAttachedFile called:', minuteId, fileIndex);
                
                // Find minute
                let minute = null;
                for (const meetingId in this.minutesData) {
                    minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) break;
                }
                
                if (!minute || !minute.attachedFiles || !minute.attachedFiles[fileIndex]) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    console.error('Minute or file not found:', { minute, fileIndex });
                    return;
                }
                
                const file = minute.attachedFiles[fileIndex];
                console.log('Opening file:', file);
                
                // For PDFs, create a blob URL and open in new tab
                if (file.type === 'application/pdf') {
                    try {
                        // Convert Data URL to Blob
                        const byteString = atob(file.url.split(',')[1]);
                        const mimeString = file.url.split(',')[0].split(':')[1].split(';')[0];
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        const blob = new Blob([ab], { type: mimeString });
                        const blobUrl = URL.createObjectURL(blob);
                        
                        // Open in new tab
                        window.open(blobUrl, '_blank');
                    } catch (error) {
                        console.error('Error opening PDF:', error);
                        alert('PDFã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                        // Fallback to download
                        const link = document.createElement('a');
                        link.href = file.url;
                        link.download = file.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                }
                // For images, open in new window with img tag
                else if (file.type && file.type.startsWith('image/')) {
                    const newWindow = window.open();
                    if (newWindow) {
                        newWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <title>${file.name}</title>
                                <style>
                                    body { margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f0f0f0; }
                                    img { max-width: 100%; height: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                                </style>
                            </head>
                            <body>
                                <img src="${file.url}" alt="${file.name}">
                            </body>
                            </html>
                        `);
                        newWindow.document.close();
                    } else {
                        alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                }
                // For other files, trigger download
                else {
                    const link = document.createElement('a');
                    link.href = file.url;
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            },
            
            addNewDetailRow() {
                if (!this.currentMinute.detailRows) {
                    this.currentMinute.detailRows = [];
                }
                
                this.currentMinute.detailRows.push({
                    agenda: '',
                    action: '',
                    assignee: '',
                    deadline: new Date().toISOString().split('T')[0],
                    purpose: '',
                    status: 'pending',  // æœªç€æ‰‹
                    notes1: '',
                    notes2: ''
                });
                
                this.showMinuteDetailTable(this.currentMinute.id);
            },
            
            // Toggle select all checkboxes
            toggleSelectAll() {
                const selectAllCheckbox = document.getElementById('selectAllRows');
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                
                this.updateDeleteButtonState();
            },
            
            // Update delete button state based on selection
            updateDeleteButtonState() {
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                const selectedCheckboxes = Array.from(rowCheckboxes).filter(cb => cb.checked);
                const selectedCount = selectedCheckboxes.length;
                
                const deleteButton = document.getElementById('deleteSelectedBtn');
                const selectedCountSpan = document.getElementById('selectedCount');
                
                if (selectedCount > 0) {
                    deleteButton.style.display = 'inline-block';
                    selectedCountSpan.textContent = selectedCount;
                } else {
                    deleteButton.style.display = 'none';
                }
                
                // Update "select all" checkbox state
                const selectAllCheckbox = document.getElementById('selectAllRows');
                if (selectAllCheckbox) {
                    if (selectedCount === 0) {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = false;
                    } else if (selectedCount === rowCheckboxes.length) {
                        selectAllCheckbox.checked = true;
                        selectAllCheckbox.indeterminate = false;
                    } else {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = true;
                    }
                }
            },
            
            // Delete selected rows
            deleteSelectedRows() {
                const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                const selectedIndices = Array.from(rowCheckboxes).map(cb => parseInt(cb.getAttribute('data-row'))).sort((a, b) => b - a);
                
                if (selectedIndices.length === 0) {
                    alert('å‰Šé™¤ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                
                // Check if all rows are being deleted
                if (selectedIndices.length >= this.currentMinute.detailRows.length) {
                    alert('æœ€ä½1è¡Œã¯å¿…è¦ã§ã™ã€‚ã™ã¹ã¦ã®è¡Œã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚');
                    return;
                }
                
                if (confirm(`é¸æŠã—ãŸ${selectedIndices.length}ä»¶ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    // Delete from highest index to lowest to avoid index shift issues
                    selectedIndices.forEach(index => {
                        this.currentMinute.detailRows.splice(index, 1);
                    });
                    
                    // Save and refresh
                    this.saveToLocalStorage();
                    this.showMinuteDetailTable(this.currentMinute.id);
                    
                    // Show success message
                    this.showSaveSuccessMessage();
                }
            },
            
            deleteDetailRow(rowIndex) {
                if (confirm('ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    if (this.currentMinute.detailRows && this.currentMinute.detailRows.length > 1) {
                        this.currentMinute.detailRows.splice(rowIndex, 1);
                        this.showMinuteDetailTable(this.currentMinute.id);
                    } else {
                        alert('æœ€ä½1è¡Œã¯å¿…è¦ã§ã™ã€‚');
                    }
                }
            },
            
            saveDetailTable(minuteId) {
                // Show saving indicator with animation
                const saveButton = document.getElementById('saveButton');
                if (saveButton) {
                    const originalHTML = saveButton.innerHTML;
                    saveButton.innerHTML = 'â³ ä¿å­˜ä¸­...';
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.6';
                    saveButton.style.transform = 'scale(0.95)';
                }
                
                // Collect data from all cells
                const cells = document.querySelectorAll('.editable-cell');
                const statusSelects = document.querySelectorAll('.status-select');
                
                // Group by row
                const rowData = {};
                cells.forEach(cell => {
                    const row = cell.getAttribute('data-row');
                    const field = cell.getAttribute('data-field');
                    const value = cell.textContent.trim();
                    
                    if (!rowData[row]) {
                        rowData[row] = {};
                    }
                    rowData[row][field] = value;
                });
                
                // Add status values
                statusSelects.forEach(select => {
                    const row = select.getAttribute('data-row');
                    if (rowData[row]) {
                        rowData[row].status = select.value;
                    }
                });
                
                // Convert to array
                const updatedRows = Object.keys(rowData).sort().map(key => rowData[key]);
                
                // Find and update minute
                for (const meetingId in this.minutesData) {
                    const minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) {
                        minute.detailRows = updatedRows;
                        
                        // Ensure attachedFiles is preserved
                        if (!minute.attachedFiles) {
                            minute.attachedFiles = [];
                        }
                        
                        console.log('Saving minute with files:', minute.attachedFiles);
                        
                        this.saveToLocalStorage();
                        
                        // Show SUCCESS animation on save button
                        if (saveButton) {
                            saveButton.innerHTML = 'âœ… ä¿å­˜å®Œäº†ï¼';
                            saveButton.style.background = '#27ae60';
                            saveButton.style.transform = 'scale(1.05)';
                            saveButton.style.opacity = '1';
                            
                            setTimeout(() => {
                                saveButton.innerHTML = 'ğŸ’¾ ä¿å­˜';
                                saveButton.style.background = '#e74c3c';
                                saveButton.style.transform = 'scale(1)';
                                saveButton.disabled = false;
                            }, 2000);
                        }
                        
                        // Show BIG success toast message
                        this.showSaveSuccessMessage();
                        
                        // Re-render current page to reflect changes (after a small delay to show success message)
                        setTimeout(() => {
                            this.showMinuteDetailTable(minuteId);
                        }, 500);
                        return;
                    }
                }
            },
            
            showSaveSuccessMessage() {
                // Create BIG success notification element with animation
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); z-index: 9999; background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; padding: 30px 50px; border-radius: 20px; box-shadow: 0 10px 40px rgba(39, 174, 96, 0.4); font-size: 24px; font-weight: 700; text-align: center; animation: successPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;">
                        <div style="font-size: 48px; margin-bottom: 10px;">âœ…</div>
                        <div>ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼</div>
                    </div>
                `;
                
                // Add animation keyframes if not exists
                if (!document.getElementById('successPopStyle')) {
                    const style = document.createElement('style');
                    style.id = 'successPopStyle';
                    style.textContent = `
                        @keyframes successPop {
                            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
                            50% { transform: translate(-50%, -50%) scale(1.1); }
                            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                        }
                        @keyframes fadeOut {
                            from { opacity: 1; }
                            to { opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(notification);
                
                // Fade out and remove after 2 seconds
                setTimeout(() => {
                    notification.firstElementChild.style.animation = 'fadeOut 0.5s forwards';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 2000);
            },
            
            // OLD VERSION BELOW (keeping for reference)
            showSaveSuccessMessageOLD() {
                // Create success notification element
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #27ae60 0%, #219a52 100%);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
                        z-index: 10000;
                        font-size: 15px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        animation: slideInRight 0.3s ease-out;
                    ">
                        <span style="font-size: 24px;">âœ…</span>
                        <span>ä¿å­˜ã—ã¾ã—ãŸï¼</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove after 3 seconds with fade out animation
                setTimeout(() => {
                    notification.firstElementChild.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            },
            
            saveMinuteTable(minuteId) {
                const rows = document.querySelectorAll('.editable-row');
                const data = [];
                
                rows.forEach((row) => {
                    const cells = row.querySelectorAll('.editable-cell');
                    const rowData = {};
                    
                    cells.forEach(cell => {
                        const field = cell.getAttribute('data-field');
                        rowData[field] = cell.textContent.trim();
                    });
                    
                    data.push(rowData);
                });
                
                console.log('Saving minute table data:', data);
                
                // Find and update minute
                for (const meetingId in this.minutesData) {
                    const minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) {
                        // Update minute with first row data
                        if (data.length > 0) {
                            minute.topic = data[0].topic;
                            minute.assignee = data[0].assignee;
                            minute.dueDate = data[0].deadline;
                            minute.issue = data[0].purpose;
                            minute.decision = data[0].topic;
                            minute.action = data.length > 1 ? data[1].topic : data[0].topic;
                            minute.reason = data.length > 1 ? data[1].purpose : data[0].purpose;
                        }
                        break;
                    }
                }
                
                alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
                this.showMeetingView(this.currentMeeting.id);
            },
            
            openAddMinuteModal(meetingId) {
                this.editingMinuteId = null;
                document.getElementById('modalTitle').textContent = 'è­°äº‹éŒ²ã‚’è¿½åŠ ';
                document.getElementById('minuteForm').reset();
                
                // Set default meeting name (from current meeting)
                if (this.currentMeeting) {
                    document.getElementById('minuteMeetingName').value = this.currentMeeting.name || '';
                }
                
                // Set default meeting date (today)
                const today = new Date();
                document.getElementById('minuteMeetingDate').value = today.toISOString().split('T')[0];
                
                document.getElementById('minuteModal').classList.add('active');
            },
            
            openEditMinuteModal(minuteId) {
                // Find minute
                let minute = null;
                for (const meetingId in this.minutesData) {
                    minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) break;
                }
                
                if (!minute) return;
                
                this.editingMinuteId = minuteId;
                document.getElementById('modalTitle').textContent = 'è­°äº‹éŒ²ã‚’ç·¨é›†';
                
                // Fill form with current data
                document.getElementById('minuteMeetingName').value = minute.meetingName || '';
                document.getElementById('minuteSubtitle').value = minute.subtitle || '';
                document.getElementById('minuteMeetingDate').value = minute.meetingDate || '';
                document.getElementById('minuteParticipants').value = minute.participants || '';
                document.getElementById('minuteFacilitator').value = minute.facilitator || '';
                document.getElementById('minuteNotes').value = minute.notes || '';
                document.getElementById('minuteStatus').value = minute.status;
                
                document.getElementById('minuteModal').classList.add('active');
            },
            
            closeModal() {
                document.getElementById('minuteModal').classList.remove('active');
                document.getElementById('minuteForm').reset();
                this.editingMinuteId = null;
            },
            
            saveMinute() {
                const formData = {
                    meetingName: document.getElementById('minuteMeetingName').value,
                    subtitle: document.getElementById('minuteSubtitle').value,
                    meetingDate: document.getElementById('minuteMeetingDate').value,
                    participants: document.getElementById('minuteParticipants').value,
                    facilitator: document.getElementById('minuteFacilitator').value,
                    notes: document.getElementById('minuteNotes').value,
                    status: document.getElementById('minuteStatus').value
                };
                
                if (this.editingMinuteId) {
                    // Edit existing minute
                    for (const meetingId in this.minutesData) {
                        const index = this.minutesData[meetingId].findIndex(m => m.id === this.editingMinuteId);
                        if (index !== -1) {
                            this.minutesData[meetingId][index] = {
                                ...this.minutesData[meetingId][index],
                                ...formData
                            };
                            break;
                        }
                    }
                    this.saveToLocalStorage(); // Save to localStorage
                    this.closeModal();
                    this.showMeetingView(this.currentMeeting.id);
                } else {
                    // Add new minute - é…åˆ—ã®å…ˆé ­ã«è¿½åŠ ï¼ˆæ–°ã—ã„ã‚‚ã®ãŒä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
                    const meetingId = this.currentMeeting.id;
                    if (!this.minutesData[meetingId]) {
                        this.minutesData[meetingId] = [];
                    }
                    
                    const newMinute = {
                        id: `minute-${meetingId}-${Date.now()}`,
                        meetingId: meetingId,
                        ...formData,
                        archived: false,
                        created: new Date().toISOString(), // ä½œæˆæ—¥æ™‚ã‚’è¿½åŠ 
                        // Supabaseç”¨ã®è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        date: formData.meetingDate,
                        location: '', // å ´æ‰€ã¯å¾Œã§è¿½åŠ å¯èƒ½
                        agendaItems: [], // è­°é¡Œï¼ˆå¾Œã§è¿½åŠ ï¼‰
                        tasks: [] // ã‚¿ã‚¹ã‚¯ï¼ˆå¾Œã§è¿½åŠ ï¼‰
                    };
                    
                    // Supabaseã«ä¿å­˜ï¼ˆéåŒæœŸï¼‰
                    (async () => {
                        try {
                            // å‚åŠ è€…ã‚’ãƒ‘ãƒ¼ã‚¹
                            const participantsList = formData.participants ? 
                                formData.participants.split('\n').filter(p => p.trim()).map(p => ({
                                    name: p.trim(),
                                    role: ''
                                })) : [];
                            
                            const savedMinute = await this.saveMinuteToSupabase({
                                meetingId: meetingId,
                                date: formData.meetingDate,
                                location: '',
                                status: formData.status,
                                participants: participantsList,
                                agendaItems: [],
                                tasks: []
                            });
                            
                            console.log('âœ… è­°äº‹éŒ²ã‚’Supabaseã«ä¿å­˜ã—ã¾ã—ãŸ:', savedMinute);
                            
                            // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                            newMinute.id = savedMinute.id;
                            newMinute.createdBy = savedMinute.created_by;
                            newMinute.createdAt = savedMinute.created_at;
                            
                            // unshift()ã§é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
                            this.minutesData[meetingId].unshift(newMinute);
                            this.saveToLocalStorage(); // Save to localStorage
                            
                            this.closeModal();
                            this.showMeetingView(this.currentMeeting.id);
                            
                        } catch (error) {
                            console.error('âŒ è­°äº‹éŒ²ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                            alert(`âŒ è­°äº‹éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\n\nãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                            
                            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚localStorageã«ã¯ä¿å­˜
                            this.minutesData[meetingId].unshift(newMinute);
                            this.saveToLocalStorage();
                            
                            this.closeModal();
                            this.showMeetingView(this.currentMeeting.id);
                        }
                    })();
                }
            },
            
            submitMinuteForm() {
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
                const form = document.getElementById('minuteForm');
                if (form.checkValidity()) {
                    this.saveMinute();
                } else {
                    // HTML5ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    form.reportValidity();
                }
            },
            
            // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ã®ä¿å­˜
            saveInlineEdit(minuteId, field, value) {
                // è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                for (const meetingId in this.minutesData) {
                    const minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) {
                        minute[field] = value;
                        this.saveToLocalStorage();
                        this.showSaveIndicator();
                        console.log(`âœ… Saved ${field}: ${value}`);
                        return true;
                    }
                }
                return false;
            },
            
            // ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
            showSaveIndicator() {
                // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
                const existing = document.getElementById('saveIndicator');
                if (existing) {
                    existing.remove();
                }
                
                // æ–°ã—ã„ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆ
                const indicator = document.createElement('div');
                indicator.id = 'saveIndicator';
                indicator.className = 'save-indicator';
                indicator.innerHTML = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸ';
                indicator.style.opacity = '1';
                document.body.appendChild(indicator);
                
                // 3ç§’å¾Œã«å‰Šé™¤
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.remove();
                    }
                }, 3000);
            },
            
            // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupInlineEditListeners() {
                // contenteditableè¦ç´ ã®blurã‚¤ãƒ™ãƒ³ãƒˆ
                document.addEventListener('blur', (e) => {
                    if (e.target.classList.contains('inline-edit')) {
                        const row = e.target.closest('.inline-editable-row');
                        if (row) {
                            const minuteId = row.dataset.minuteId;
                            const field = e.target.dataset.field;
                            const value = e.target.textContent.trim();
                            
                            if (value && value !== '-') {
                                this.saveInlineEdit(minuteId, field, value);
                            }
                        }
                    }
                }, true);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å¤‰æ›´
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('status-dropdown')) {
                        const row = e.target.closest('.inline-editable-row');
                        if (row) {
                            const minuteId = row.dataset.minuteId;
                            const field = e.target.dataset.field;
                            const value = e.target.value;
                            
                            this.saveInlineEdit(minuteId, field, value);
                            
                            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è‰²ã‚’æ›´æ–°
                            const statusColors = {
                                'not-held': '#f39c12',  // ã‚ªãƒ¬ãƒ³ã‚¸
                                'completed-with-tasks': '#e74c3c',  // èµ¤
                                'completed-no-tasks': '#3498db'  // é’
                            };
                            e.target.style.background = statusColors[value] || '#999';
                        }
                    }
                }, true);
            },
            
            // ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã‚’è¡¨ç¤º
            showDatePicker(minuteId) {
                const datePicker = document.getElementById(`datePicker-${minuteId}`);
                if (datePicker) {
                    datePicker.showPicker();
                }
            },
            
            // ğŸ“… ä¼šè­°æ—¥ã‚’æ›´æ–°
            updateMeetingDate(minuteId, newDate) {
                if (!newDate) return;
                
                // Find and update minute
                for (const meetingId in this.minutesData) {
                    const minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) {
                        minute.meetingDate = newDate;
                        this.saveToLocalStorage();
                        
                        // ä¿å­˜æˆåŠŸã‚’è¡¨ç¤º
                        this.showSaveIndicator();
                        
                        // å†æç”»
                        this.showMeetingView(this.currentMeeting.id);
                        break;
                    }
                }
            },
            
            // ğŸ“… æœŸé™ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã‚’è¡¨ç¤º
            showDeadlinePicker(rowIndex) {
                const deadlinePicker = document.getElementById(`deadlinePicker-${rowIndex}`);
                if (deadlinePicker) {
                    deadlinePicker.showPicker();
                }
            },
            
            // ğŸ“… æœŸé™ã‚’æ›´æ–°
            updateDeadline(rowIndex, newDate) {
                if (!newDate || !this.currentMinute) return;
                
                // Update the deadline in detailRows
                if (this.currentMinute.detailRows && this.currentMinute.detailRows[rowIndex]) {
                    this.currentMinute.detailRows[rowIndex].deadline = newDate;
                    
                    // Save to localStorage
                    this.saveToLocalStorage();
                    
                    // Show success message
                    this.showSaveSuccessMessage();
                    
                    // Re-render the table
                    setTimeout(() => {
                        this.showMinuteDetailTable(this.currentMinute.id);
                    }, 500);
                }
            },
            
            // ğŸ¨ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠæ™‚ã«å³åº§ã«è‰²ã‚’å¤‰æ›´
            updateStatusColors(selectElement) {
                const selectedOption = selectElement.selectedOptions[0];
                const color = selectedOption.dataset.color;
                const bg = selectedOption.dataset.bg;
                
                // Update border, text color, and background
                selectElement.style.borderColor = color;
                selectElement.style.color = color;
                selectElement.style.background = bg;
                
                // Update SVG arrow color
                const svgArrow = `data:image/svg+xml;utf8,<svg fill="${encodeURIComponent(color)}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>`;
                selectElement.style.backgroundImage = `url('${svgArrow}')`;
            },
            
            archiveMinute(minuteId) {
                if (!confirm('ã“ã®è­°äº‹éŒ²ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ãŸè­°äº‹éŒ²ã¯ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚')) {
                    return;
                }
                
                // Find and archive minute
                for (const meetingId in this.minutesData) {
                    const minute = this.minutesData[meetingId].find(m => m.id === minuteId);
                    if (minute) {
                        minute.archived = true;
                        this.archivedMinutes.push(minute);
                        break;
                    }
                }
                
                // Refresh view
                if (this.currentView === 'meeting') {
                    this.showMeetingView(this.currentMeeting.id);
                } else if (this.currentView === 'minute') {
                    this.showMeetingView(this.currentMeeting.id);
                }
            },
            
            // ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã‚’è¡¨ç¤º
            async showUserManagement() {
                console.log('ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã‚’è¡¨ç¤º');
                
                // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
                if (!this.canManageUsers()) {
                    alert('âŒ ã“ã®æ©Ÿèƒ½ã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨ã§ãã¾ã™');
                    return;
                }
                
                this.currentView = 'user-management';
                this.updateBreadcrumb();
                
                const content = document.getElementById('contentArea');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
                try {
                    const { data: users, error } = await supabase
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ:', users);
                    
                    let html = `
                        <button class="btn btn-secondary back-btn" onclick="app.showOrganizationView()" style="margin-bottom: 15px; padding: 8px 16px; font-size: 13px; background: #95a5a6; color: white; border: none; border-radius: 3px;">â† æˆ»ã‚‹</button>
                        
                        <div style="background: #9c27b0; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #7b1fa2;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 18px;">ğŸ‘¥</span>
                                <span style="color: white; font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</span>
                                <span style="color: rgba(255,255,255,0.7); font-size: 12px; margin-left: 8px;">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${users.length}</span>
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #ddd; border-top: none; padding: 20px;">
                    `;
                    
                    if (users.length === 0) {
                        html += '<div style="padding: 40px 20px; text-align: center; color: #7f8c8d; font-size: 14px;">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</div>';
                    } else {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
                        html += `
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #34495e; color: white;">
                                            <th style="padding: 12px; text-align: left; border: 1px solid #2c3e50;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #2c3e50;">åå‰</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #2c3e50; width: 150px;">æ¨©é™</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #2c3e50;">éƒ¨ç½²</th>
                                            <th style="padding: 12px; text-align: left; border: 1px solid #2c3e50;">ãƒãƒ¼ãƒ </th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #2c3e50;">ç™»éŒ²æ—¥</th>
                                            <th style="padding: 12px; text-align: center; border: 1px solid #2c3e50; width: 100px;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        users.forEach((user, index) => {
                            const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                            const roleColor = {
                                'admin': '#d32f2f',
                                'editor_a': '#1976d2',
                                'editor_b': '#388e3c',
                                'viewer': '#757575'
                            }[user.role] || '#757575';
                            
                            const roleName = {
                                'admin': 'ç®¡ç†è€…',
                                'editor_a': 'ä¸€èˆ¬A',
                                'editor_b': 'ä¸€èˆ¬B',
                                'viewer': 'é–²è¦§ã®ã¿'
                            }[user.role] || user.role;
                            
                            html += `
                                <tr style="background: ${bgColor};" id="user-row-${user.id}">
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${user.email}</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                                        <div 
                                            class="editable-field" 
                                            data-user-id="${user.id}" 
                                            data-field="name"
                                            contenteditable="true"
                                            style="min-width: 100px; padding: 4px; border-radius: 3px; cursor: text; transition: all 0.2s;"
                                            onblur="app.saveUserField('${user.id}', 'name', this.textContent)"
                                            onfocus="this.style.background='#fff3cd'; this.style.border='2px solid #ffc107';"
                                        >${user.name || '-'}</div>
                                    </td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                        <select 
                                            id="role-${user.id}" 
                                            onchange="app.updateUserRole('${user.id}', this.value)"
                                            style="padding: 6px 10px; border: 2px solid ${roleColor}; border-radius: 4px; background: white; color: ${roleColor}; font-weight: 600; cursor: pointer; font-size: 12px;"
                                        >
                                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ç®¡ç†è€…</option>
                                            <option value="editor_a" ${user.role === 'editor_a' ? 'selected' : ''}>ä¸€èˆ¬A</option>
                                            <option value="editor_b" ${user.role === 'editor_b' ? 'selected' : ''}>ä¸€èˆ¬B</option>
                                            <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>é–²è¦§ã®ã¿</option>
                                        </select>
                                    </td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                                        <div 
                                            class="editable-field" 
                                            data-user-id="${user.id}" 
                                            data-field="user_department"
                                            contenteditable="true"
                                            style="min-width: 80px; padding: 4px; border-radius: 3px; cursor: text; transition: all 0.2s;"
                                            onblur="app.saveUserField('${user.id}', 'user_department', this.textContent)"
                                            onfocus="this.style.background='#fff3cd'; this.style.border='2px solid #ffc107';"
                                        >${user.user_department || '-'}</div>
                                    </td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                                        <div 
                                            class="editable-field" 
                                            data-user-id="${user.id}" 
                                            data-field="user_team"
                                            contenteditable="true"
                                            style="min-width: 80px; padding: 4px; border-radius: 3px; cursor: text; transition: all 0.2s;"
                                            onblur="app.saveUserField('${user.id}', 'user_team', this.textContent)"
                                            onfocus="this.style.background='#fff3cd'; this.style.border='2px solid #ffc107';"
                                        >${user.user_team || '-'}</div>
                                    </td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">${new Date(user.created_at).toLocaleDateString('ja-JP')}</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                        <button 
                                            onclick="app.deleteUserFromSupabase('${user.id}', '${user.email}')"
                                            style="padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;"
                                            onmouseover="this.style.background='#c0392b'"
                                            onmouseout="this.style.background='#e74c3c'"
                                        >
                                            ğŸ—‘ï¸ å‰Šé™¤
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        // æ¨©é™èª¬æ˜
                        html += `
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-left: 4px solid #9c27b0; border-radius: 4px;">
                                <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #9c27b0;">ğŸ“‹ æ¨©é™ã®èª¬æ˜</h3>
                                <table style="width: 100%; font-size: 13px;">
                                    <tr>
                                        <td style="padding: 8px; font-weight: 600; color: #d32f2f; width: 100px;">ç®¡ç†è€…</td>
                                        <td style="padding: 8px;">ã™ã¹ã¦ã®æ“ä½œãŒå¯èƒ½ï¼ˆé–²è¦§ãƒ»è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼‰</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; font-weight: 600; color: #1976d2;">ä¸€èˆ¬A</td>
                                        <td style="padding: 8px;">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆä»¥å¤–ã®ã™ã¹ã¦ã®æ“ä½œãŒå¯èƒ½ï¼ˆé–²è¦§ãƒ»è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; font-weight: 600; color: #388e3c;">ä¸€èˆ¬B</td>
                                        <td style="padding: 8px;">å‰Šé™¤ã¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã¯ä¸å¯ï¼ˆé–²è¦§ãƒ»è¿½åŠ ãƒ»ç·¨é›†ã®ã¿ï¼‰</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; font-weight: 600; color: #757575;">é–²è¦§ã®ã¿</td>
                                        <td style="padding: 8px;">é–²è¦§ã®ã¿å¯èƒ½ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã¯ä¸å¯ï¼‰</td>
                                    </tr>
                                </table>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    
                    content.innerHTML = html;
                    
                } catch (error) {
                    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    content.innerHTML = `
                        <div style="padding: 40px 20px; text-align: center; color: #e74c3c;">
                            <h3>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            },
            
            // ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’æ›´æ–°
            async updateUserRole(userId, newRole) {
                console.log(`ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’æ›´æ–°: ${userId} â†’ ${newRole}`);
                
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .update({ role: newRole })
                        .eq('id', userId)
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('âœ… æ¨©é™æ›´æ–°æˆåŠŸ:', data);
                    
                    const roleName = {
                        'admin': 'ç®¡ç†è€…',
                        'editor_a': 'ä¸€èˆ¬A',
                        'editor_b': 'ä¸€èˆ¬B',
                        'viewer': 'é–²è¦§ã®ã¿'
                    }[newRole] || newRole;
                    
                    alert(`âœ… æ¨©é™ã‚’ã€Œ${roleName}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
                    
                    // ã‚¹ã‚­ãƒ¼ãƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                    await supabase.rpc('reload_schema');
                    
                } catch (error) {
                    console.error('âŒ æ¨©é™æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`âŒ æ¨©é™ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                    
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                    this.showUserManagement();
                }
            },
            
            // ğŸ’¾ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜
            async saveUserField(userId, fieldName, newValue) {
                console.log(`ğŸ’¾ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜: ${userId}, ${fieldName} = ${newValue}`);
                
                // å€¤ãŒ '-' ã®å ´åˆã¯ null ã«å¤‰æ›
                const valueToSave = (newValue === '-' || newValue.trim() === '') ? null : newValue.trim();
                
                // ä¿å­˜ä¸­ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                const element = document.querySelector(`.editable-field[data-user-id="${userId}"][data-field="${fieldName}"]`);
                if (element) {
                    element.style.background = '#e3f2fd';
                    element.style.border = '2px solid #2196f3';
                    element.textContent = 'ä¿å­˜ä¸­...';
                }
                
                try {
                    const updateData = {};
                    updateData[fieldName] = valueToSave;
                    
                    const { data, error } = await supabase
                        .from('users')
                        .update(updateData)
                        .eq('id', userId)
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('âœ… ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¿å­˜æˆåŠŸ:', data);
                    
                    // ä¿å­˜æˆåŠŸã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    if (element) {
                        element.style.background = '#d1f2eb';
                        element.style.border = '2px solid #27ae60';
                        element.textContent = valueToSave || '-';
                        
                        // ä¸€æ™‚çš„ã«ã€Œâœ… ä¿å­˜ã—ã¾ã—ãŸã€ã‚’è¡¨ç¤º
                        const originalContent = element.textContent;
                        element.textContent = 'âœ… ä¿å­˜å®Œäº†';
                        
                        setTimeout(() => {
                            element.style.background = '';
                            element.style.border = '';
                            element.textContent = originalContent;
                        }, 1500);
                    }
                    
                } catch (error) {
                    console.error('âŒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    
                    // ã‚¨ãƒ©ãƒ¼ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    if (element) {
                        element.style.background = '#f8d7da';
                        element.style.border = '2px solid #e74c3c';
                        element.textContent = 'âŒ ä¿å­˜å¤±æ•—';
                        
                        setTimeout(() => {
                            element.style.background = '';
                            element.style.border = '';
                            element.textContent = newValue || '-';
                        }, 2000);
                    }
                    
                    alert(`âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            },
            
            // ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
            async deleteUserFromSupabase(userId, userEmail) {
                console.log(`ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤: ${userId} (${userEmail})`);
                
                // è‡ªåˆ†è‡ªèº«ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å ´åˆã¯è­¦å‘Š
                if (userId === this.currentUser?.id) {
                    alert('âŒ è‡ªåˆ†è‡ªèº«ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“');
                    return;
                }
                
                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                const confirmMessage = `æœ¬å½“ã«ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${userEmail}\n\nâš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\nâš ï¸ èªè¨¼æƒ…å ±ã‚‚å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nâš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å†åº¦æ–°è¦ç™»éŒ²ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚`;
                
                if (!confirm(confirmMessage)) {
                    console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                    return;
                }
                
                // å‰Šé™¤ä¸­ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                const row = document.getElementById(`user-row-${userId}`);
                if (row) {
                    row.style.background = '#fff3cd';
                    row.style.opacity = '0.6';
                }
                
                try {
                    // Step 1: public.users ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å‰Šé™¤
                    const { error: deletePublicError } = await supabase
                        .from('users')
                        .delete()
                        .eq('id', userId);
                    
                    if (deletePublicError) throw deletePublicError;
                    
                    console.log('âœ… public.users ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    
                    // Step 2: auth.users ã‹ã‚‰ã‚‚å‰Šé™¤ (RPCé–¢æ•°ã‚’ä½¿ç”¨)
                    try {
                        const { error: deleteAuthError } = await supabase.rpc('delete_user', {
                            user_id: userId
                        });
                        
                        if (deleteAuthError) {
                            console.warn('âš ï¸ auth.users ã‹ã‚‰ã®å‰Šé™¤ã«å¤±æ•—:', deleteAuthError);
                            // auth.users ã®å‰Šé™¤ã«å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ
                        } else {
                            console.log('âœ… auth.users ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                        }
                    } catch (authError) {
                        console.warn('âš ï¸ auth.users ã‹ã‚‰ã®å‰Šé™¤ã‚¹ã‚­ãƒƒãƒ—:', authError);
                        // auth.users ã®å‰Šé™¤ã«å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ
                    }
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    alert(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${userEmail}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    
                    // ç”»é¢ã‹ã‚‰å³åº§ã«å‰Šé™¤
                    if (row) {
                        row.style.transition = 'all 0.3s ease-out';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            row.remove();
                            
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’æ›´æ–°
                            const userCount = document.querySelectorAll('[id^="user-row-"]').length;
                            const countSpan = document.querySelector('[style*="ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°"]');
                            if (countSpan) {
                                countSpan.textContent = `ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${userCount}`;
                            }
                        }, 300);
                    }
                    
                } catch (error) {
                    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                    
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
                    if (row) {
                        row.style.background = '';
                        row.style.opacity = '1';
                    }
                }
            },
            
            async logout() {
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¨˜éŒ²
                if (this.currentUser) {
                    this.logAccess(this.currentUser.email, 'logout', 'success');
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®ã¿ã‚¯ãƒªã‚¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã¯ä¿æŒï¼‰
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('userInfo');
                // ğŸ’¡ rememberedEmail ã¨ rememberedPassword ã¯ä¿æŒã—ã¦æ¬¡å›è‡ªå‹•å…¥åŠ›
                
                this.currentUser = null;
                this.showLoginPage();
            }
        };
        
        // Login form handler
        // ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
            
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
                const user = app.users.find(u => u.email === email);
                
                if (!user) {
                    app.logAccess(email, 'login', 'failed', 'User not found');
                    app.showAlert('âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
                if (user.password !== password) {
                    app.logAccess(email, 'login', 'failed', 'Wrong password');
                    app.showAlert('âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
                if (user.status === app.USER_STATUS.PENDING) {
                    app.logAccess(email, 'login', 'blocked', 'Pending approval');
                    app.showAlert('â³ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ‰¿èªå¾…ã¡ã§ã™ã€‚\nç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                if (user.status === app.USER_STATUS.SUSPENDED) {
                    app.logAccess(email, 'login', 'blocked', 'Account suspended');
                    app.showAlert('â›” ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒåœæ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚\nç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                if (user.status === app.USER_STATUS.REJECTED) {
                    app.logAccess(email, 'login', 'blocked', 'Account rejected');
                    app.showAlert('âŒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\nè©³ç´°ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚', 'error');
                    return;
                }
                
                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                app.logAccess(email, 'login', 'success');
                const token = 'token-' + Date.now();
                localStorage.setItem('accessToken', token);
                localStorage.setItem('userInfo', JSON.stringify(user));
                
                // ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è¨˜æ†¶
                localStorage.setItem('rememberedEmail', email);
                localStorage.setItem('rememberedPassword', password);
                
                app.currentUser = user;
                app.showAlert('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼', 'success');
                setTimeout(() => app.showMainApp(), 500);
            } catch (error) {
                console.error('Login error:', error);
                app.showAlert(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
            }
        });
        
        // ğŸ” åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('setupEmail').value.trim();
            const name = document.getElementById('setupName').value.trim();
            const password = document.getElementById('setupPassword').value;
            const passwordConfirm = document.getElementById('setupPasswordConfirm').value;
            const setupBtn = document.getElementById('setupBtn');
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const emailValidation = app.validateEmail(email);
            if (!emailValidation.valid) {
                app.showSetupAlert('âŒ ' + emailValidation.message, 'error');
                return;
            }
            
            if (!name) {
                app.showSetupAlert('âŒ ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const passwordValidation = app.validatePassword(password);
            if (!passwordValidation.valid) {
                app.showSetupAlert('âŒ ' + passwordValidation.message, 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                app.showSetupAlert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            setupBtn.disabled = true;
            setupBtn.textContent = 'é€ä¿¡ä¸­...';
            
            try {
                // ç¢ºèªã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                app.verificationCode = app.generateVerificationCode();
                app.pendingVerification = {
                    email: email,
                    name: name,
                    password: password,
                    role: app.USER_ROLE.ADMIN,
                    type: 'setup' // åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                };
                
                // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                app.sendVerificationEmail(email, app.verificationCode);
                
                // ç¢ºèªç”»é¢ã¸
                app.showVerificationPage(email);
                app.showSetupAlert('âœ… ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('Setup error:', error);
                app.showSetupAlert(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                setupBtn.disabled = false;
                setupBtn.textContent = 'ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡';
            }
        });
        
        // ğŸ” ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('verificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const code = document.getElementById('verificationCode').value.trim();
            const verifyBtn = document.getElementById('verifyBtn');
            
            if (!code || code.length !== 6) {
                app.showVerificationAlert('âŒ 6æ¡ã®ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'ç¢ºèªä¸­...';
            
            try {
                if (code !== app.verificationCode) {
                    app.showVerificationAlert('âŒ ç¢ºèªã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ç¢ºèªæˆåŠŸ
                const pendingUser = app.pendingVerification;
                
                // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
                const newUser = {
                    id: 'user-' + Date.now(),
                    email: pendingUser.email,
                    name: pendingUser.name,
                    password: pendingUser.password,
                    role: pendingUser.role,
                    status: app.USER_STATUS.ACTIVE, // åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¾ãŸã¯ç®¡ç†è€…æ‰¿èªæ¸ˆã¿
                    createdAt: new Date().toISOString(),
                    approvedAt: new Date().toISOString(),
                    approvedBy: pendingUser.type === 'setup' ? 'system' : 'admin',
                    department: { name: 'çµŒå–¶ä¼ç”»éƒ¨' }, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                    team: { name: 'çµŒå–¶ãƒãƒ¼ãƒ ' } // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                };
                
                app.users.push(newUser);
                app.saveAuthData();
                app.logAccess(newUser.email, 'register', 'success', pendingUser.type === 'setup' ? 'Initial setup' : 'Registration');
                
                // ã‚¯ãƒªã‚¢
                app.verificationCode = null;
                app.pendingVerification = null;
                
                if (pendingUser.type === 'setup') {
                    // åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®å ´åˆã¯è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
                    const token = 'token-' + Date.now();
                    localStorage.setItem('accessToken', token);
                    localStorage.setItem('userInfo', JSON.stringify(newUser));
                    app.currentUser = newUser;
                    
                    app.showVerificationAlert('âœ… ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼', 'success');
                    setTimeout(() => app.showMainApp(), 1000);
                } else {
                    // ä¸€èˆ¬ç™»éŒ²ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                    app.showVerificationAlert('âœ… æ‰¿èªå¾…ã¡ã§ã™ã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', 'success');
                    setTimeout(() => app.showLoginPage(), 2000);
                }
            } catch (error) {
                console.error('Verification error:', error);
                app.showVerificationAlert(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'ç¢ºèª';
            }
        });
        
        // ğŸ” ç¢ºèªã‚³ãƒ¼ãƒ‰å†é€ä¿¡
        app.resendVerificationCode = function() {
            if (!app.pendingVerification) {
                app.showVerificationAlert('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            // æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            app.verificationCode = app.generateVerificationCode();
            app.sendVerificationEmail(app.pendingVerification.email, app.verificationCode);
            app.showVerificationAlert('âœ… ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã—ãŸ', 'success');
        };
        
        // ğŸ” æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('regEmail').value.trim();
            const name = document.getElementById('regName').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const regBtn = document.getElementById('regBtn');
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const emailValidation = app.validateEmail(email);
            if (!emailValidation.valid) {
                app.showRegistrationAlert('âŒ ' + emailValidation.message, 'error');
                return;
            }
            
            if (!name) {
                app.showRegistrationAlert('âŒ ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const passwordValidation = app.validatePassword(password);
            if (!passwordValidation.valid) {
                app.showRegistrationAlert('âŒ ' + passwordValidation.message, 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                app.showRegistrationAlert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            regBtn.disabled = true;
            regBtn.textContent = 'é€ä¿¡ä¸­...';
            
            try {
                // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èªå¾…ã¡ã§ä½œæˆ
                const newUser = {
                    id: 'user-' + Date.now(),
                    email: email,
                    name: name,
                    password: password,
                    role: app.USER_ROLE.USER, // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
                    status: app.USER_STATUS.PENDING, // æ‰¿èªå¾…ã¡
                    createdAt: new Date().toISOString(),
                    approvedAt: null,
                    approvedBy: null,
                    department: { name: 'æœªæ‰€å±' },
                    team: { name: 'æœªæ‰€å±' }
                };
                
                app.users.push(newUser);
                app.saveAuthData();
                app.logAccess(email, 'register', 'success', 'Pending approval');
                
                app.showRegistrationAlert('âœ… ç™»éŒ²ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\nç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', 'success');
                setTimeout(() => app.showLoginPage(), 2000);
            } catch (error) {
                console.error('Registration error:', error);
                app.showRegistrationAlert(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                regBtn.disabled = false;
                regBtn.textContent = 'ç™»éŒ²ç”³è«‹';
            }
        });
        
        // ========== Export Functions ==========
        app.toggleExportMenu = function(event) {
            if (event) {
                event.stopPropagation();
            }
            const menu = document.getElementById('exportMenu');
            if (menu) {
                const isVisible = menu.style.display === 'block';
                menu.style.display = isVisible ? 'none' : 'block';
                console.log('Export menu toggled:', menu.style.display);
            } else {
                console.error('Export menu not found');
            }
        };
        
        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('exportMenu');
            const exportButton = event.target.closest('[onclick*="toggleExportMenu"]');
            
            if (menu && !exportButton && menu.style.display === 'block') {
                menu.style.display = 'none';
            }
        });
        
        app.exportCSV = function() {
            console.log('Exporting CSV...');
            const minute = this.currentMinute;
            if (!minute || !minute.detailRows) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let csv = '\uFEFF'; // UTF-8 BOM for Excel
            csv += 'ä¼šè­°å,ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«,ä¼šè­°é–‹å‚¬æ—¥\n';
            csv += `"${minute.meetingName || ''}","${minute.subtitle || ''}","${minute.meetingDate || ''}"\n\n`;
            csv += '#,è­°é¡Œãƒ»ã‚¢ã‚¸ã‚§ãƒ³ãƒ€,å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³,æ‹…å½“è€…,æœŸé™,ç›®çš„ãƒ»æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,å‚™è€ƒ1,å‚™è€ƒ2\n';
            
            minute.detailRows.forEach((row, index) => {
                const statusMap = { pending: 'æœªç€æ‰‹', progress: 'é€²è¡Œä¸­', completed: 'å®Œäº†', overdue: 'æœŸé™è¶…é' };
                csv += `${index + 1},"${(row.agenda || '').replace(/"/g, '""')}","${(row.action || '').replace(/"/g, '""')}","${(row.assignee || '').replace(/"/g, '""')}","${row.deadline || ''}","${(row.purpose || '').replace(/"/g, '""')}","${statusMap[row.status] || ''}","${(row.notes1 || '').replace(/"/g, '""')}","${(row.notes2 || '').replace(/"/g, '""')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è­°äº‹éŒ²_${minute.meetingName || 'minutes'}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            this.toggleExportMenu();
        };
        
        app.exportTXT = function() {
            console.log('Exporting TXT...');
            const minute = this.currentMinute;
            if (!minute || !minute.detailRows) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let txt = `è­°äº‹éŒ²è©³ç´°\n`;
            txt += `${'='.repeat(50)}\n\n`;
            txt += `ä¼šè­°å: ${minute.meetingName || ''}\n`;
            txt += `ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«: ${minute.subtitle || ''}\n`;
            txt += `ä¼šè­°é–‹å‚¬æ—¥: ${minute.meetingDate || ''}\n\n`;
            txt += `${'='.repeat(50)}\n\n`;
            
            minute.detailRows.forEach((row, index) => {
                const statusMap = { pending: 'æœªç€æ‰‹', progress: 'é€²è¡Œä¸­', completed: 'å®Œäº†', overdue: 'æœŸé™è¶…é' };
                txt += `ã€${index + 1}ã€‘\n`;
                txt += `è­°é¡Œãƒ»ã‚¢ã‚¸ã‚§ãƒ³ãƒ€: ${row.agenda || ''}\n`;
                txt += `å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${row.action || ''}\n`;
                txt += `æ‹…å½“è€…: ${row.assignee || ''}\n`;
                txt += `æœŸé™: ${row.deadline || ''}\n`;
                txt += `ç›®çš„ãƒ»æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ: ${row.purpose || ''}\n`;
                txt += `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusMap[row.status] || ''}\n`;
                txt += `å‚™è€ƒ1: ${row.notes1 || ''}\n`;
                txt += `å‚™è€ƒ2: ${row.notes2 || ''}\n`;
                txt += `${'-'.repeat(50)}\n\n`;
            });
            
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è­°äº‹éŒ²_${minute.meetingName || 'minutes'}_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            this.toggleExportMenu();
        };
        
        app.exportPDF = function() {
            console.log('Exporting PDF...');
            alert('ğŸ“„ PDFå½¢å¼ã§ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ã€‚\n\nä»£ã‚ã‚Šã«ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·æ©Ÿèƒ½ï¼ˆCtrl+Pï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€ŒPDFã¨ã—ã¦ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            this.toggleExportMenu();
        };
        
        app.exportWord = function() {
            console.log('Exporting Word...');
            const minute = this.currentMinute;
            if (!minute || !minute.detailRows) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>è­°äº‹éŒ²</title></head><body>`;
            html += `<h1>è­°äº‹éŒ²è©³ç´°</h1>`;
            html += `<p><strong>ä¼šè­°å:</strong> ${minute.meetingName || ''}</p>`;
            html += `<p><strong>ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${minute.subtitle || ''}</p>`;
            html += `<p><strong>ä¼šè­°é–‹å‚¬æ—¥:</strong> ${minute.meetingDate || ''}</p><hr>`;
            html += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;width:100%;">`;
            html += `<thead><tr style="background-color:#4a86e8;color:white;">`;
            html += `<th>#</th><th>è­°é¡Œãƒ»ã‚¢ã‚¸ã‚§ãƒ³ãƒ€</th><th>å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th><th>æ‹…å½“è€…</th><th>æœŸé™</th><th>ç›®çš„ãƒ»æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å‚™è€ƒ1</th><th>å‚™è€ƒ2</th>`;
            html += `</tr></thead><tbody>`;
            
            minute.detailRows.forEach((row, index) => {
                const statusMap = { pending: 'æœªç€æ‰‹', progress: 'é€²è¡Œä¸­', completed: 'å®Œäº†', overdue: 'æœŸé™è¶…é' };
                html += `<tr>`;
                html += `<td>${index + 1}</td>`;
                html += `<td>${row.agenda || ''}</td>`;
                html += `<td>${row.action || ''}</td>`;
                html += `<td>${row.assignee || ''}</td>`;
                html += `<td>${row.deadline || ''}</td>`;
                html += `<td>${row.purpose || ''}</td>`;
                html += `<td>${statusMap[row.status] || ''}</td>`;
                html += `<td>${row.notes1 || ''}</td>`;
                html += `<td>${row.notes2 || ''}</td>`;
                html += `</tr>`;
            });
            
            html += `</tbody></table></body></html>`;
            
            const blob = new Blob(['\ufeff' + html], { type: 'application/msword;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è­°äº‹éŒ²_${minute.meetingName || 'minutes'}_${new Date().toISOString().split('T')[0]}.doc`;
            link.click();
            this.toggleExportMenu();
        };
        
        app.exportExcel = function() {
            console.log('Exporting Excel...');
            alert('ğŸ“Š Excelå½¢å¼ã§ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯å°‚ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ã€‚\n\nä»£ã‚ã‚Šã«CSVå½¢å¼ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼ˆExcelã§CSVã‚’é–‹ãã“ã¨ãŒã§ãã¾ã™ï¼‰ã€‚');
            this.toggleExportMenu();
        };
        
        app.exportPowerPoint = function(minuteId) {
            alert('ğŸ“½ï¸ PowerPointå½¢å¼ã§ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯å°‚ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ã€‚\n\nç¾åœ¨ã®æ©Ÿèƒ½ã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            this.toggleExportMenu();
        };
        
        app.exportImage = function(minuteId, format) {
            alert(`ğŸ–¼ï¸ ${format.toUpperCase()}å½¢å¼ã§ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯å°‚ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚`);
            this.toggleExportMenu();
        };
        
        app.exportZIP = function(minuteId) {
            alert('ğŸ—œï¸ ZIPå½¢å¼ã§ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯å°‚ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ã€‚\n\nè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€æ‰‹å‹•ã§ZIPåœ§ç¸®ã—ã¦ãã ã•ã„ã€‚');
            this.toggleExportMenu();
        };
        
        // AI Analysis Functions
        app.openAIAnalysisModal = function() {
            document.getElementById('aiAnalysisModal').classList.add('active');
            document.getElementById('aiAnalysisText').value = '';
            document.getElementById('aiAnalysisFileName').textContent = '';
            document.getElementById('aiAnalysisProgress').style.display = 'none';
        };
        
        app.closeAIAnalysisModal = function() {
            document.getElementById('aiAnalysisModal').classList.remove('active');
        };
        
        app.handleAIAnalysisFile = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name;
            document.getElementById('aiAnalysisFileName').textContent = fileName;
            
            // Check file type
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            try {
                let text = '';
                
                if (fileExtension === 'docx') {
                    // Handle Word document with mammoth.js
                    console.log('Reading .docx file with mammoth.js...');
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    text = result.value;
                    console.log('âœ… .docx file read successfully');
                } else {
                    // Handle plain text files
                    console.log('Reading text file...');
                    text = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsText(file, 'UTF-8');
                    });
                    console.log('âœ… Text file read successfully');
                }
                
                document.getElementById('aiAnalysisText').value = text;
            } catch (error) {
                console.error('âŒ File reading error:', error);
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§è©¦ã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        };
        
        app.startAIAnalysis = async function() {
            const text = document.getElementById('aiAnalysisText').value.trim();
            
            if (!text) {
                alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // Show progress
            const progressDiv = document.getElementById('aiAnalysisProgress');
            const progressText = document.getElementById('aiAnalysisProgressText');
            progressDiv.style.display = 'block';
            progressText.textContent = 'AIè§£æä¸­...';
            
            try {
                // Try OpenAI API first
                let analysisResult;
                try {
                    analysisResult = await this.analyzeMinutesWithAI(text);
                } catch (apiError) {
                    console.warn('OpenAI API failed, using fallback parser:', apiError);
                    progressText.textContent = 'AI APIåˆ©ç”¨ä¸å¯ã€‚ç°¡æ˜“è§£æã‚’ä½¿ç”¨ä¸­...';
                    // Use fallback simple parser
                    analysisResult = this.parseMinutesText(text);
                }
                
                progressText.textContent = 'è§£æå®Œäº†ï¼ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ä¸­...';
                
                // Add analyzed rows to the current minute
                if (analysisResult && analysisResult.length > 0) {
                    if (!this.currentMinute.detailRows) {
                        this.currentMinute.detailRows = [];
                    }
                    
                    // Append all analyzed rows
                    this.currentMinute.detailRows.push(...analysisResult);
                    
                    // Save to localStorage
                    this.saveToLocalStorage();
                    
                    // Close modal and refresh view
                    this.closeAIAnalysisModal();
                    this.showMinuteDetailTable(this.currentMinute.id);
                    
                    alert(`âœ… AIè§£æå®Œäº†ï¼${analysisResult.length}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
                } else {
                    alert('âš ï¸ è§£æçµæœãŒç©ºã§ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (error) {
                console.error('AI Analysis error:', error);
                alert(`âŒ AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                progressDiv.style.display = 'none';
            }
        };
        
        app.analyzeMinutesWithAI = async function(text) {
            console.log('=== Starting AI analysis with Cloudflare Worker ===');
            console.log('Text length:', text.length);
            
            // Cloudflare Worker URL
            const WORKER_URL = 'https://gijiroku-ai-worker.tashiro.workers.dev';
            
            try {
                console.log('Sending request to Cloudflare Worker...');
                
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Worker API Error: ${errorData.error || 'Unknown error'}`);
                }
                
                const result = await response.json();
                
                if (result.success && Array.isArray(result.data)) {
                    console.log('âœ… AI analysis completed:', result.data.length, 'items');
                    return result.data;
                } else {
                    throw new Error('Invalid response format from Worker');
                }
            } catch (error) {
                console.error('âŒ Cloudflare Worker request failed:', error);
                console.log('Falling back to local parser...');
                
                // Fallback to local parser
                try {
                    return this.parseMinutesText(text);
                } catch (fallbackError) {
                    console.error('âŒ Local parser also failed:', fallbackError);
                    throw new Error('Both AI analysis and local parser failed');
                }
            }
        };
        
        // OLD CODE - Remove loadOpenAIConfig logic
        app._oldAnalyzeMinutesWithAI = async function(text) {
            console.log('=== OLD: Starting AI analysis ===');
            console.log('Text length:', text.length);
            
            try {
                console.log('Loading OpenAI config...');
                const config = await this.loadOpenAIConfig();
                console.log('Config loaded:', config ? 'YES' : 'NO');
                
                if (config && config.api_key) {
                    console.log('=== API Key found, proceeding with AI analysis ===');
                    const prompt = `ã‚ãªãŸã¯å„ªç§€ãªè­°äº‹éŒ²è§£æAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚éŸ³å£°èªè­˜ã•ã‚ŒãŸè­°äº‹éŒ²ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ãƒ“ã‚¸ãƒã‚¹ã§å®Ÿç”¨çš„ãªæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¾ã™ã€‚

# è§£æå¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ
${text}

# ã‚ãªãŸã®ã‚¿ã‚¹ã‚¯
ä»¥ä¸‹ã®3ã‚¹ãƒ†ãƒƒãƒ—ã§è­°äº‹éŒ²ã‚’è§£æã—ã¦ãã ã•ã„ï¼š

## ã‚¹ãƒ†ãƒƒãƒ—1: è­°äº‹éŒ²ã®å…¨ä½“ç†è§£
- ä¼šè­°ã®ä¸»è¦ãƒ†ãƒ¼ãƒã¨ç›®çš„ã‚’æŠŠæ¡ã™ã‚‹
- è­°è«–ã®æµã‚Œã¨é‡è¦ãªæ±ºå®šäº‹é …ã‚’ç‰¹å®šã™ã‚‹
- ç™ºè¨€è€…ã®å½¹å‰²ã¨è²¬ä»»ç¯„å›²ã‚’ç†è§£ã™ã‚‹

## ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã®æŠ½å‡º
è­°äº‹éŒ²ã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè¡Œå¯èƒ½ãªé …ç›®ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š
- æ˜ç¢ºãªæ±ºå®šäº‹é …ï¼ˆã€Œã€œã™ã‚‹ã“ã¨ã«ãªã£ãŸã€ã€Œã€œã§åˆæ„ã—ãŸã€ãªã©ï¼‰
- ã‚¿ã‚¹ã‚¯ã‚„ä½œæ¥­é …ç›®ï¼ˆã€Œã€œã‚’èª¿æŸ»ã™ã‚‹ã€ã€Œã€œã«é€£çµ¡ã™ã‚‹ã€ãªã©ï¼‰
- æœŸé™ä»˜ãã®ç´„æŸäº‹é …ï¼ˆã€Œã€œã¾ã§ã«æå‡ºã€ã€Œã€œæœˆã¾ã§ã«å®Œäº†ã€ãªã©ï¼‰
- æ¤œè¨ãƒ»æ¤œè¨¼ãŒå¿…è¦ãªèª²é¡Œï¼ˆã€Œã€œã‚’æ¤œè¨ã™ã‚‹ã€ã€Œã€œã‚’ç¢ºèªã™ã‚‹ã€ãªã©ï¼‰
- ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãŒå¿…è¦ãªäº‹é …

## ã‚¹ãƒ†ãƒƒãƒ—3: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¸ã®å¤‰æ›
å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®8é …ç›®ã‚’æ…é‡ã«åˆ†æã—ã¦æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š

### 1. è­°é¡Œãƒ»ã‚¢ã‚¸ã‚§ãƒ³ãƒ€ (agenda)
- **ä½•ã«ã¤ã„ã¦è­°è«–ã•ã‚ŒãŸã®ã‹**ã®è¦ç´„ï¼ˆ1-2æ–‡ï¼‰
- èƒŒæ™¯ã‚„çµŒç·¯ã‚’å«ã‚ãŸè­°é¡Œã®æœ¬è³ªã‚’è¨˜è¿°
- ä¾‹: ã€Œãƒ­ã‚¸ã‚¯ãƒ¼ãƒ«å€‰åº«ã®å®Œæˆã«ä¼´ã†æ’¤å»æ¥­è€…ã®é¸å®šã«ã¤ã„ã¦ã€

### 2. å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (action)
- **èª°ãŒä½•ã‚’ã™ã‚‹ã®ã‹**ã‚’æ˜ç¢ºã«è¨˜è¿°
- å‹•è©ã‚’ä½¿ã£ãŸå…·ä½“çš„ãªè¡Œå‹•ï¼ˆã€Œã€œã‚’èª¿æŸ»ã€ã€Œã€œã«é€£çµ¡ã€ã€Œã€œã‚’ç¢ºèªã€ï¼‰
- ä¾‹: ã€Œãƒˆãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã®ææºæ¥­è€…3ç¤¾ã¨åˆåŒå¯¾å¿œã®å¯èƒ½æ€§ã‚’ç¢ºèªã™ã‚‹ã€

### 3. æ‹…å½“è€… (assignee)
- å®Ÿæ–½è²¬ä»»è€…ã®åå‰ï¼ˆç™ºè¨€è€…ã‚„æŒ‡åã•ã‚ŒãŸäººç‰©ï¼‰
- åå‰ãŒä¸æ˜ãªå ´åˆã¯å½¹è·ã‚„éƒ¨é–€åï¼ˆã€Œå–¶æ¥­éƒ¨ã€ã€Œæ‹…å½“è€…ã€ãªã©ï¼‰
- è¤‡æ•°ã„ã‚‹å ´åˆã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š
- ä¾‹: ã€Œå±±ç”°å¤ªéƒã€ã€Œå–¶æ¥­éƒ¨æ‹…å½“ã€

### 4. æœŸé™ (deadline)
- YYYY-MM-DDå½¢å¼ã§è¨˜è¿°ï¼ˆä¾‹: 2025-03-15ï¼‰
- ã€Œæ¥å¹´3æœˆã€â†’ã€Œ2026-03-31ã€ã®ã‚ˆã†ã«å…·ä½“çš„ãªæ—¥ä»˜ã«å¤‰æ›
- ã€Œ1ãƒ¶æœˆå¾Œã€â†’ç¾åœ¨æ—¥ã‚’åŸºæº–ã«è¨ˆç®—
- æœŸé™ã®è¨˜è¼‰ãŒãªã„å ´åˆã¯ç©ºæ–‡å­— ""

### 5. ç›®çš„ãƒ»æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ (purpose)
- **ãªãœã“ã‚Œã‚’å®Ÿæ–½ã™ã‚‹ã®ã‹**ã®ç†ç”±
- æœŸå¾…ã•ã‚Œã‚‹çµæœã‚„ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
- ã‚³ã‚¹ãƒˆå‰Šæ¸›ã€åŠ¹ç‡åŒ–ã€å“è³ªå‘ä¸Šãªã©ã®åŠ¹æœ
- ä¾‹: ã€Œæ’¤å»è²»ç”¨ã‚’ç¾çŠ¶ã®1.5ã€œ2å€ã‹ã‚‰å‰Šæ¸›ã—ã€ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã‚’å›³ã‚‹ã€

### 6. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (status)
- ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ–‡è„ˆã‚’åˆ¤æ–­ã—ã¦ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’é¸æŠï¼š
  - **pending**: æœªç€æ‰‹ã€ã“ã‚Œã‹ã‚‰å®Ÿæ–½äºˆå®š
  - **progress**: ç¾åœ¨é€²è¡Œä¸­ã€æ¤œè¨ä¸­ã€èª¿æŸ»ä¸­
  - **completed**: æ—¢ã«å®Œäº†ã€æ±ºå®šæ¸ˆã¿
  - **overdue**: æœŸé™ã‚’éãã¦ã„ã‚‹ï¼ˆæ˜ç¤ºçš„ãªè¨˜è¼‰ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ "pending"

### 7. å‚™è€ƒ1 (notes1)
- è£œè¶³æƒ…å ±ã‚„åˆ¶ç´„æ¡ä»¶
- é–¢é€£ã™ã‚‹è¿½åŠ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- ä¾‹: ã€Œç¾åœ¨ãƒˆãƒ¼ãƒˆã‚¯ãƒªã‚¨ã‚¤ãƒˆã«ä¾é ¼ä¸­ã€ç›´æ¥ä¾é ¼ã®å ´åˆã¯å˜ä¾¡1.5ã€œ2å€ã€

### 8. å‚™è€ƒ2 (notes2)
- ãã®ä»–ã®å‚è€ƒæƒ…å ±
- é–¢ä¿‚è€…ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚„æ‡¸å¿µäº‹é …
- ä¾‹: ã€Œãƒ­ã‚¸ã‚¯ãƒ¼ãƒ«å€‰åº«å®Œæˆå¾Œã¯è‡ªç¤¾å¯¾å¿œå¯èƒ½ã€

# å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
å¿…ãšä»¥ä¸‹ã®æœ‰åŠ¹ãªJSONé…åˆ—å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

[
  {
    "agenda": "è­°é¡Œã®è¦ç´„ï¼ˆå…·ä½“çš„ã«ï¼‰",
    "action": "å®Ÿè¡Œã™ã¹ãå…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³",
    "assignee": "æ‹…å½“è€…åã¾ãŸã¯å½¹è·",
    "deadline": "YYYY-MM-DD ã¾ãŸã¯ç©ºæ–‡å­—",
    "purpose": "å®Ÿæ–½ã™ã‚‹ç†ç”±ã¨æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ",
    "status": "pending | progress | completed | overdue",
    "notes1": "è£œè¶³æƒ…å ±ã‚„åˆ¶ç´„æ¡ä»¶",
    "notes2": "ãã®ä»–ã®å‚è€ƒæƒ…å ±"
  }
]

# é‡è¦ãªæ³¨æ„äº‹é …
- **å“è³ªé‡è¦–**: éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾å…¥ã‚Œã‚‹ã®ã§ã¯ãªãã€ãƒ“ã‚¸ãƒã‚¹æ–‡æ›¸ã¨ã—ã¦æ•´ç†ã•ã‚ŒãŸæ–‡ç« ã«ã™ã‚‹
- **æ–‡è„ˆç†è§£**: ä¼šè©±ã®æµã‚Œã‹ã‚‰æš—é»™çš„ãªæƒ…å ±ã‚‚èª­ã¿å–ã‚‹
- **é‡è¤‡æ’é™¤**: åŒã˜å†…å®¹ãŒç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯1ã¤ã«ã¾ã¨ã‚ã‚‹
- **å„ªå…ˆé †ä½**: é‡è¦åº¦ãŒé«˜ã„é …ç›®ã‹ã‚‰é †ã«ä¸¦ã¹ã‚‹
- **å…·ä½“æ€§**: æ›–æ˜§ãªè¡¨ç¾ã‚’é¿ã‘ã€5W1Hï¼ˆèª°ãŒã€ä½•ã‚’ã€ã„ã¤ã€ã©ã“ã§ã€ãªãœã€ã©ã®ã‚ˆã†ã«ï¼‰ã‚’æ˜ç¢ºã«ã™ã‚‹
- **JSONå½¢å¼**: å¿…ãšæœ‰åŠ¹ãªJSONã¨ã—ã¦å‡ºåŠ›ï¼ˆæ”¹è¡Œã‚„ç‰¹æ®Šæ–‡å­—ã¯é©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰

ãã‚Œã§ã¯è§£æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚å¿…ãšJSONé…åˆ—ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ï¼‰ã€‚`;

                    const response = await fetch('/api/openai/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gpt-5',
                            messages: [
                                {
                                    role: 'system',
                                    content: `ã‚ãªãŸã¯æ—¥æœ¬ã®ãƒ“ã‚¸ãƒã‚¹ä¼šè­°ã®è­°äº‹éŒ²è§£æã«ç‰¹åŒ–ã—ãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

å°‚é–€çŸ¥è­˜:
- æ—¥æœ¬ã®ãƒ“ã‚¸ãƒã‚¹æ–‡åŒ–ã¨ä¼šè­°æ…£ç¿’ã®ç†è§£
- éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè©±ã—è¨€è‘‰ï¼‰ã‹ã‚‰æ›¸ãè¨€è‘‰ã¸ã®å¤‰æ›
- æ›–æ˜§ãªç™ºè¨€ã‹ã‚‰å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã®æŠ½å‡º
- ãƒ“ã‚¸ãƒã‚¹ä¸Šã®å„ªå…ˆé †ä½ã¨é‡è¦åº¦ã®åˆ¤æ–­

è§£ææ–¹é‡:
1. ä¼šè­°ã®æ–‡è„ˆã‚’æ·±ãç†è§£ã—ã€æš—é»™çš„ãªæƒ…å ±ã‚‚èª­ã¿å–ã‚‹
2. å£èªè¡¨ç¾ã‚’æ•´ç†ã—ã€ãƒ“ã‚¸ãƒã‚¹æ–‡æ›¸ã¨ã—ã¦é©åˆ‡ãªè¡¨ç¾ã«å¤‰æ›
3. é‡è¤‡ã‚„å†—é•·ãªå†…å®¹ã‚’çµ±åˆã—ã€ç°¡æ½”ã§æ˜ç¢ºãªé …ç›®ã«ã¾ã¨ã‚ã‚‹
4. å®Ÿè¡Œå¯èƒ½æ€§ãŒé«˜ã„å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å„ªå…ˆçš„ã«æŠ½å‡º
5. å¿…ãšæœ‰åŠ¹ãªJSONé…åˆ—å½¢å¼ã§è¿”ã™ï¼ˆèª¬æ˜æ–‡ã‚„å‰ç½®ãã¯ä¸è¦ï¼‰

å“è³ªåŸºæº–:
- å„é …ç›®ã¯ç‹¬ç«‹ã—ã¦ç†è§£ã§ãã‚‹å®Œçµã—ãŸå†…å®¹ã§ã‚ã‚‹ã“ã¨
- æ‹…å½“è€…ã¨æœŸé™ãŒæ˜ç¢ºãªé …ç›®ã‚’å„ªå…ˆã™ã‚‹ã“ã¨
- æ›–æ˜§ã•ã‚’æ’é™¤ã—ã€5W1HãŒæ˜ç¢ºã§ã‚ã‚‹ã“ã¨`
                                },
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            temperature: 0.2,
                            max_tokens: 6000
                        })
                    });
                    
                    console.log('Sending request to OpenAI API...');
                    console.log('Request URL:', '/api/openai/chat/completions');
                    
                    if (response.ok) {
                        console.log('=== API Response received successfully ===');
                        const data = await response.json();
                        console.log('ğŸ“¦ Full API Response:', data);
                        
                        const content = data.choices[0].message.content;
                        console.log('ğŸ“ Content type:', typeof content);
                        console.log('ğŸ“ Is array:', Array.isArray(content));
                        
                        let parsedData;
                        
                        // âœ… Check if content is already an array (new server format)
                        if (Array.isArray(content)) {
                            console.log('âœ… Content is already an array! Using directly.');
                            console.log('ğŸ“Š Array length:', content.length);
                            console.log('ğŸ“Š First item:', content[0]);
                            parsedData = content;
                        } 
                        // ğŸ”„ If content is a string, parse it (legacy format)
                        else if (typeof content === 'string') {
                            console.log('ğŸ”„ Content is a string, parsing...');
                            console.log('ğŸ“ Content length:', content.length);
                            console.log('ğŸ“ Content preview:', content.substring(0, 500));
                            
                            // Parse JSON from response
                            let jsonText = content.trim();
                            console.log('ğŸ” Raw JSON text (first 300 chars):', jsonText.substring(0, 300));
                            
                            if (jsonText.startsWith('```json')) {
                                jsonText = jsonText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                                console.log('âœ‚ï¸ Removed ```json markers');
                            } else if (jsonText.startsWith('```')) {
                                jsonText = jsonText.replace(/^```\s*/, '').replace(/\s*```$/, '');
                                console.log('âœ‚ï¸ Removed ``` markers');
                            }
                            
                            console.log('ğŸ”„ Parsing JSON response...');
                            parsedData = JSON.parse(jsonText);
                            console.log('âœ… Parsed successfully!');
                        } else {
                            console.error('âŒ Unexpected content type:', typeof content);
                            throw new Error('Unexpected content type: ' + typeof content);
                        }
                        
                        console.log('ğŸ“Š Final data type:', typeof parsedData, 'isArray:', Array.isArray(parsedData));
                        console.log('ğŸ“Š Data items:', Array.isArray(parsedData) ? parsedData.length : 'NOT AN ARRAY');
                        console.log('ğŸ“Š First item:', parsedData[0]);
                        
                        if (Array.isArray(parsedData)) {
                            console.log('âœ… Data is array, mapping to result format...');
                            const result = parsedData.map((item, idx) => {
                                console.log(`ğŸ“„ Item ${idx + 1}:`, item);
                                return {
                                    agenda: item.agenda || '',
                                    action: item.action || '',
                                    assignee: item.assignee || '',
                                    deadline: item.deadline || '',
                                    purpose: item.purpose || '',
                                    status: item.status || 'pending',
                                    notes1: item.notes1 || '',
                                    notes2: item.notes2 || ''
                                };
                            });
                            console.log('ğŸ‰ AI analysis completed successfully!');
                            console.log('ğŸ“¦ Returning', result.length, 'structured items');
                            console.log('ğŸ“¦ Result sample:', result[0]);
                            return result;
                        } else {
                            console.error('Parsed data is not an array:', typeof parsedData);
                        }
                    } else {
                        console.error('API response not OK:', response.status, response.statusText);
                        const errorText = await response.text();
                        console.error('Error details:', errorText);
                    }
                } else {
                    console.warn('No API key found in config');
                }
            } catch (error) {
                console.error('=== AI Analysis Error ===');
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.warn('Falling back to simple parser');
            }
            
            // Fallback: Simple text parser
            console.log('=== Using simple text parser (fallback) ===');
            return this.parseMinutesText(text);
        };
        
        app.parseMinutesText = function(text) {
            const results = [];
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            // Pattern matching for Japanese meeting minutes
            const patterns = {
                // Match: â€¢ **Text**: description, æ‹…å½“: person, æœŸé™: date
                withDetails: /[â€¢ãƒ»]\s*\*?\*?([^:ï¼š]+?)\*?\*?[:ï¼š]\s*(.+?)(?:æ‹…å½“[:ï¼š]\s*([^ã€,]+?))?(?:æœŸé™[:ï¼š]\s*([0-9]{4}[-å¹´/][0-9]{1,2}[-æœˆ/][0-9]{1,2}æ—¥?))?\s*$/,
                // Match: â€¢ Text
                simple: /[â€¢ãƒ»]\s*(.+)$/,
                // Date pattern
                date: /([0-9]{4})[-å¹´/]([0-9]{1,2})[-æœˆ/]([0-9]{1,2})/
            };
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Try detailed pattern first
                let match = line.match(patterns.withDetails);
                if (match) {
                    const agenda = match[1].trim();
                    const action = match[2].trim();
                    const assignee = match[3] ? match[3].trim() : '';
                    const deadlineStr = match[4] || '';
                    
                    // Parse deadline
                    let deadline = '';
                    if (deadlineStr) {
                        const dateMatch = deadlineStr.match(patterns.date);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            const month = dateMatch[2].padStart(2, '0');
                            const day = dateMatch[3].padStart(2, '0');
                            deadline = `${year}-${month}-${day}`;
                        }
                    }
                    
                    results.push({
                        agenda: agenda,
                        action: action,
                        assignee: assignee,
                        deadline: deadline,
                        purpose: '',
                        status: 'pending',
                        notes1: '',
                        notes2: ''
                    });
                    continue;
                }
                
                // Try simple pattern
                match = line.match(patterns.simple);
                if (match) {
                    const text = match[1].trim();
                    
                    // Extract assignee if present
                    let assignee = '';
                    let cleanText = text;
                    const assigneeMatch = text.match(/æ‹…å½“[:ï¼š]\s*([^ã€,]+)/);
                    if (assigneeMatch) {
                        assignee = assigneeMatch[1].trim();
                        cleanText = text.replace(/æ‹…å½“[:ï¼š]\s*[^ã€,]+/, '').trim();
                    }
                    
                    // Extract deadline if present
                    let deadline = '';
                    const deadlineMatch = cleanText.match(/æœŸé™[:ï¼š]\s*([0-9]{4}[-å¹´/][0-9]{1,2}[-æœˆ/][0-9]{1,2}æ—¥?)/);
                    if (deadlineMatch) {
                        const dateMatch = deadlineMatch[1].match(patterns.date);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            const month = dateMatch[2].padStart(2, '0');
                            const day = dateMatch[3].padStart(2, '0');
                            deadline = `${year}-${month}-${day}`;
                        }
                        cleanText = cleanText.replace(/æœŸé™[:ï¼š]\s*[0-9]{4}[-å¹´/][0-9]{1,2}[-æœˆ/][0-9]{1,2}æ—¥?/, '').trim();
                    }
                    
                    results.push({
                        agenda: cleanText,
                        action: cleanText,
                        assignee: assignee,
                        deadline: deadline,
                        purpose: '',
                        status: 'pending',
                        notes1: '',
                        notes2: ''
                    });
                }
            }
            
            // If no items found, create a default one
            if (results.length === 0) {
                results.push({
                    agenda: text.substring(0, 100),
                    action: text.substring(0, 100),
                    assignee: '',
                    deadline: '',
                    purpose: '',
                    status: 'pending',
                    notes1: '',
                    notes2: ''
                });
            }
            
            return results;
        };
        
        // loadOpenAIConfig is no longer needed - using Cloudflare Worker instead
        
        console.log('=== Setting window.app ===');
        // Make app globally accessible for onclick handlers
        window.app = app;
        console.log('window.app is now:', window.app);
        console.log('window.app.showMeetingView:', typeof window.app.showMeetingView);
        
        // Auth0ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        app.logout = async function() {
            try {
                console.log('ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†é–‹å§‹');
                
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    return;
                }
                
                console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
                window.location.href = 'supabase-login.html';
                
            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        };
        
        // Initialize app
        console.log('=== Initializing app ===');
        window.addEventListener('load', () => {
            console.log('DOM loaded, calling app.init()');
            app.init();
        });
        
        // Immediate check
        console.log('=== Script Loading Completed ===');
        console.log('You can now use window.app from console');
    </script>

    <!-- ============================================ -->
    <!-- Google Cloud éŸ³å£°æ–‡å­—èµ·ã“ã—æ©Ÿèƒ½ -->
    <!-- ============================================ -->
    <script>
        // =============================================
        // Google Cloud Speech-to-Text + Gemini
        // éŸ³å£°æ–‡å­—èµ·ã“ã— & AIè¦ç´„ã‚·ã‚¹ãƒ†ãƒ 
        // =============================================
        
        class GoogleTranscriptionSystem {
            constructor() {
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.isRecording = false;
                this.audioContext = null;
                // APIã‚­ãƒ¼ã¯å¾Œã§è¨­å®šç”»é¢ã‹ã‚‰å…¥åŠ›
                this.GOOGLE_CLOUD_API_KEY = localStorage.getItem('google_cloud_api_key') || '';
                this.GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
            }
            
            // ğŸ”‘ APIã‚­ãƒ¼ã‚’è¨­å®š
            setApiKey(cloudApiKey, geminiApiKey) {
                this.GOOGLE_CLOUD_API_KEY = cloudApiKey;
                this.GEMINI_API_KEY = geminiApiKey || cloudApiKey; // Geminiã‚­ãƒ¼ãŒç©ºãªã‚‰å…±é€šã‚­ãƒ¼ã‚’ä½¿ç”¨
                localStorage.setItem('google_cloud_api_key', cloudApiKey);
                localStorage.setItem('gemini_api_key', geminiApiKey || cloudApiKey);
                console.log('âœ… Google API ã‚­ãƒ¼è¨­å®šå®Œäº†');
            }
            
            // ğŸ”‘ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            checkApiKey() {
                if (!this.GOOGLE_CLOUD_API_KEY) {
                    alert('âŒ Google API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nè¨­å®šæ‰‹é †ï¼š\n1. ç”»é¢å³ä¸Šã®ã€Œè¨­å®šã€ã‚’ã‚¯ãƒªãƒƒã‚¯\n2. Google API ã‚­ãƒ¼ã‚’å…¥åŠ›\n3. ä¿å­˜');
                    return false;
                }
                return true;
            }
            
            // ğŸ™ï¸ éŒ²éŸ³é–‹å§‹
            async startRecording() {
                if (!this.checkApiKey()) return;
                
                try {
                    console.log('ğŸ™ï¸ ãƒã‚¤ã‚¯è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...');
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            channelCount: 1,
                            sampleRate: 48000,
                            echoCancellation: true,
                            noiseSuppression: true
                        } 
                    });
                    
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    this.audioChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            this.audioChunks.push(e.data);
                        }
                    };
                    
                    this.mediaRecorder.start(1000); // 1ç§’ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿å–å¾—
                    this.isRecording = true;
                    
                    this.updateRecordingUI('recording');
                    console.log('ğŸ™ï¸ éŒ²éŸ³é–‹å§‹');
                    
                } catch (error) {
                    console.error('âŒ ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            }
            
            // â¹ï¸ éŒ²éŸ³åœæ­¢
            async stopRecording(meetingId) {
                if (!this.mediaRecorder || !this.isRecording) {
                    alert('éŒ²éŸ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                return new Promise((resolve) => {
                    this.mediaRecorder.onstop = async () => {
                        try {
                            const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                            console.log(`â¹ï¸ éŒ²éŸ³åœæ­¢ã€‚ã‚µã‚¤ã‚º: ${(audioBlob.size / 1024 / 1024).toFixed(2)}MB`);
                            
                            this.isRecording = false;
                            this.updateRecordingUI('processing');
                            
                            // éŸ³å£°å‡¦ç†ã‚’é–‹å§‹
                            await this.processAudio(audioBlob, meetingId);
                            
                            resolve();
                        } catch (error) {
                            console.error('âŒ éŒ²éŸ³åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
                            alert('éŒ²éŸ³ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                            this.updateRecordingUI('error');
                            resolve();
                        }
                    };
                    
                    this.mediaRecorder.stop();
                    
                    // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                });
            }
            
            // ğŸ¯ éŸ³å£°å‡¦ç†ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼
            async processAudio(audioBlob, meetingId) {
                try {
                    console.log('ğŸ“¤ éŸ³å£°å‡¦ç†é–‹å§‹...');
                    console.log('ğŸ“Š éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', (audioBlob.size / 1024 / 1024).toFixed(2), 'MB');
                    
                    // 1. Supabase ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    this.updateRecordingUI('uploading');
                    const audioUrl = await this.uploadToSupabase(audioBlob, meetingId);
                    console.log('âœ… Supabase ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†:', audioUrl);
                    
                    // 2. WAVå½¢å¼ã«å¤‰æ›
                    this.updateRecordingUI('converting');
                    const wavBlob = await this.convertToWav(audioBlob);
                    console.log('âœ… WAVå¤‰æ›å®Œäº†ã€‚ã‚µã‚¤ã‚º:', (wavBlob.size / 1024 / 1024).toFixed(2), 'MB');
                    
                    // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
                    if (wavBlob.size > 10 * 1024 * 1024) {
                        throw new Error('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§10MBã€ç´„10åˆ†ï¼‰ã€‚éŒ²éŸ³æ™‚é–“ã‚’çŸ­ãã—ã¦ãã ã•ã„ã€‚');
                    }
                    
                    // 3. Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                    const audioBase64 = await this.blobToBase64(wavBlob);
                    console.log('âœ… Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å®Œäº†ã€‚é•·ã•:', audioBase64.length, 'æ–‡å­—');
                    
                    // 4. Google Speech-to-Text Long Running API ã§æ–‡å­—èµ·ã“ã—
                    this.updateRecordingUI('transcribing');
                    const transcript = await this.transcribeWithGoogleLongRunning(audioBase64);
                    console.log('âœ… æ–‡å­—èµ·ã“ã—å®Œäº†');
                    
                    // 5. Gemini ã§è¦ç´„
                    this.updateRecordingUI('summarizing');
                    let summary = '';
                    try {
                        summary = await this.summarizeWithGPT4o(transcript.fullText);
                        console.log('âœ… Gemini è¦ç´„å®Œäº†');
                    } catch (error) {
                        console.error('âš ï¸ è¦ç´„ã‚¨ãƒ©ãƒ¼:', error);
                        console.log('âš ï¸ è¦ç´„ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™');
                        summary = 'â€» AIè¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\næ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š\n\n' + transcript.fullText;
                    }
                    
                    // 6. Supabase ã«ä¿å­˜
                    this.updateRecordingUI('saving');
                    await this.saveTranscript(meetingId, transcript, summary, audioUrl);
                    console.log('âœ… ä¿å­˜å®Œäº†');
                    
                    // 7. å®Œäº†
                    this.updateRecordingUI('completed');
                    alert('âœ… æ–‡å­—èµ·ã“ã—ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nè­°äº‹éŒ²ã«åæ˜ ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                    
                    // 8. ç”»é¢ã‚’æ›´æ–°
                    if (window.app && window.app.showMeetingView) {
                        window.app.showMeetingView(meetingId);
                    }
                    
                } catch (error) {
                    console.error('âŒ éŸ³å£°å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateRecordingUI('error');
                    alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n' + error.message);
                }
            }
            
            // ğŸ“¤ Supabase ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            async uploadToSupabase(audioBlob, meetingId) {
                const fileName = `${meetingId}_${Date.now()}.webm`;
                
                const { data, error } = await supabase.storage
                    .from('meeting-recordings')
                    .upload(fileName, audioBlob, {
                        contentType: 'audio/webm',
                        upsert: false
                    });
                
                if (error) {
                    console.error('Supabase ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    throw new Error('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
                
                const { data: { publicUrl } } = supabase.storage
                    .from('meeting-recordings')
                    .getPublicUrl(fileName);
                
                return publicUrl;
            }
            
            // ğŸ”„ WAVå½¢å¼ã«å¤‰æ›
            async convertToWav(webmBlob) {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const arrayBuffer = await webmBlob.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    
                    const wavBuffer = await this.audioBufferToWav(audioBuffer);
                    return new Blob([wavBuffer], { type: 'audio/wav' });
                } catch (error) {
                    console.error('WAVå¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                    throw new Error('éŸ³å£°å½¢å¼ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
            
            // ğŸµ AudioBuffer â†’ WAVå¤‰æ›
            async audioBufferToWav(buffer) {
                const numChannels = 1; // ãƒ¢ãƒãƒ©ãƒ«
                const sampleRate = 16000; // Googleæ¨å¥¨
                const format = 1; // PCM
                const bitDepth = 16;
                
                // ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆawaitãŒå¿…è¦ï¼‰
                const samples = await this.resampleAudio(buffer, sampleRate);
                
                const bytesPerSample = bitDepth / 8;
                const blockAlign = numChannels * bytesPerSample;
                const dataLength = samples.length * bytesPerSample;
                const bufferLength = 44 + dataLength;
                
                const arrayBuffer = new ArrayBuffer(bufferLength);
                const view = new DataView(arrayBuffer);
                
                // WAVãƒ˜ãƒƒãƒ€ãƒ¼
                this.writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataLength, true);
                this.writeString(view, 8, 'WAVE');
                this.writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, format, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * blockAlign, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitDepth, true);
                this.writeString(view, 36, 'data');
                view.setUint32(40, dataLength, true);
                
                // éŸ³å£°ãƒ‡ãƒ¼ã‚¿
                let offset = 44;
                for (let i = 0; i < samples.length; i++) {
                    const sample = Math.max(-1, Math.min(1, samples[i]));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
                
                return arrayBuffer;
            }
            
            // ğŸ” ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
            resampleAudio(buffer, targetSampleRate) {
                const channels = buffer.numberOfChannels;
                const sourceSampleRate = buffer.sampleRate;
                const sourceLength = buffer.length;
                const targetLength = Math.round(sourceLength * targetSampleRate / sourceSampleRate);
                
                const offlineContext = new OfflineAudioContext(1, targetLength, targetSampleRate);
                const source = offlineContext.createBufferSource();
                source.buffer = buffer;
                source.connect(offlineContext.destination);
                source.start(0);
                
                return offlineContext.startRendering().then(renderedBuffer => {
                    return renderedBuffer.getChannelData(0);
                });
            }
            
            writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            
            // ğŸ“¦ Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            async blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }
            
            // ğŸ—£ï¸ Google Speech-to-Text Long Running API ã§æ–‡å­—èµ·ã“ã—ï¼ˆæœ€å¤§10åˆ†å¯¾å¿œï¼‰
            async transcribeWithGoogleLongRunning(audioBase64) {
                const url = `https://speech.googleapis.com/v1/speech:longrunningrecognize?key=${this.GOOGLE_CLOUD_API_KEY}`;
                
                const requestBody = {
                    config: {
                        encoding: 'LINEAR16',
                        sampleRateHertz: 16000,
                        languageCode: 'ja-JP',
                        enableAutomaticPunctuation: true,
                        enableWordTimeOffsets: true,
                        diarizationConfig: {
                            enableSpeakerDiarization: true,
                            minSpeakerCount: 2,
                            maxSpeakerCount: 10
                        },
                        model: 'default',
                        useEnhanced: true
                    },
                    audio: {
                        content: audioBase64
                    }
                };
                
                console.log('ğŸ—£ï¸ Google Speech-to-Text Long Running API ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
                console.log('ğŸ“Š ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚µã‚¤ã‚º:', JSON.stringify(requestBody).length, 'æ–‡å­—');
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Google Speech API ã‚¨ãƒ©ãƒ¼è©³ç´°:');
                    console.error('  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status, response.statusText);
                    console.error('  ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorText);
                    
                    let errorMessage = `æ–‡å­—èµ·ã“ã—APIã‚¨ãƒ©ãƒ¼: ${response.status}`;
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        if (errorJson.error && errorJson.error.message) {
                            errorMessage += `\n${errorJson.error.message}`;
                        }
                    } catch (e) {
                        // JSON ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const operation = await response.json();
                console.log('âœ… Long Running Operation é–‹å§‹:', operation);
                
                // ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Œäº†ã‚’å¾…ã¤
                const result = await this.pollLongRunningOperation(operation.name);
                
                if (!result.results || result.results.length === 0) {
                    throw new Error('éŸ³å£°ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦éŒ²éŸ³ã—ã¦ãã ã•ã„ã€‚');
                }
                
                // è©±è€…ã”ã¨ã«æ•´ç†
                const speakers = [];
                const words = result.results[0]?.alternatives[0]?.words || [];
                
                let currentSpeaker = null;
                let currentText = '';
                
                for (const word of words) {
                    const speakerTag = word.speakerTag || 1;
                    
                    if (speakerTag !== currentSpeaker && currentText) {
                        speakers.push({
                            speaker: `è©±è€…${currentSpeaker}`,
                            text: currentText.trim()
                        });
                        currentText = '';
                    }
                    
                    currentSpeaker = speakerTag;
                    currentText += (word.word || '') + ' ';
                }
                
                if (currentText) {
                    speakers.push({
                        speaker: `è©±è€…${currentSpeaker}`,
                        text: currentText.trim()
                    });
                }
                
                const fullText = result.results
                    .map(r => r.alternatives[0].transcript)
                    .join('\n');
                
                return { fullText, speakers };
            }
            
            // ğŸ”„ Long Running Operation ã®ãƒãƒ¼ãƒªãƒ³ã‚°
            async pollLongRunningOperation(operationName) {
                const url = `https://speech.googleapis.com/v1/operations/${operationName.split('/').pop()}?key=${this.GOOGLE_CLOUD_API_KEY}`;
                
                let attempt = 0;
                const maxAttempts = 360; // æœ€å¤§30åˆ†ï¼ˆ5ç§’ Ã— 360å›ï¼‰
                
                while (attempt < maxAttempts) {
                    attempt++;
                    
                    console.log(`ğŸ“Š æ–‡å­—èµ·ã“ã—é€²è¡ŒçŠ¶æ³ã‚’ç¢ºèªä¸­... (${attempt}/${maxAttempts})`);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('âŒ Operation ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', errorText);
                        throw new Error('æ–‡å­—èµ·ã“ã—çŠ¶æ³ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    const operation = await response.json();
                    
                    if (operation.done) {
                        console.log('âœ… æ–‡å­—èµ·ã“ã—å®Œäº†ï¼');
                        
                        if (operation.error) {
                            throw new Error('æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: ' + operation.error.message);
                        }
                        
                        return operation.response;
                    }
                    
                    // 5ç§’å¾…æ©Ÿ
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
                
                throw new Error('æ–‡å­—èµ·ã“ã—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ30åˆ†ä»¥ä¸Šï¼‰');
            }
            
            // ğŸ“ è¦ç´„æ©Ÿèƒ½ã‚’ä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ–‡å­—èµ·ã“ã—ã®ã¿ï¼‰
            async summarizeWithGPT4o(transcript) {
                console.log('âš ï¸ è¦ç´„æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™');
                // æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾è¿”ã™
                return `â€» AIè¦ç´„æ©Ÿèƒ½ã¯ç¾åœ¨èª¿æ•´ä¸­ã§ã™ã€‚

æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

${transcript}`;
            }
            
            // ğŸ’¾ Supabase ã«ä¿å­˜
            async saveTranscript(meetingId, transcript, summary, audioUrl) {
                const user = await supabase.auth.getUser();
                
                const { data, error } = await supabase
                    .from('meeting_transcripts')
                    .insert({
                        meeting_id: meetingId,
                        audio_url: audioUrl,
                        full_text: transcript.fullText,
                        speakers: transcript.speakers,
                        summary: summary,
                        created_by: user.data.user?.id,
                        created_at: new Date().toISOString()
                    })
                    .select();
                
                if (error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    throw new Error('è­°äº‹éŒ²ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
                
                console.log('ğŸ’¾ è­°äº‹éŒ²ä¿å­˜å®Œäº†:', data);
                return data;
            }
            
            // ğŸ¨ UIã®æ›´æ–°
            updateRecordingUI(status) {
                const statusMessages = {
                    recording: 'ğŸ™ï¸ éŒ²éŸ³ä¸­...',
                    processing: 'âš™ï¸ å‡¦ç†ä¸­...',
                    uploading: 'ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...',
                    converting: 'ğŸ”„ å¤‰æ›ä¸­...',
                    transcribing: 'ğŸ¤– AIæ–‡å­—èµ·ã“ã—ä¸­ï¼ˆ1-2åˆ†ï¼‰...',
                    summarizing: 'ğŸ“ AIè¦ç´„ä¸­...',
                    saving: 'ğŸ’¾ ä¿å­˜ä¸­...',
                    completed: 'âœ… å®Œäº†ï¼',
                    error: 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
                };
                
                const statusEl = document.getElementById('transcription-status');
                if (statusEl) {
                    statusEl.textContent = statusMessages[status] || '';
                    statusEl.style.display = status ? 'block' : 'none';
                }
                
                const recordBtn = document.getElementById('btn-start-recording');
                const stopBtn = document.getElementById('btn-stop-recording');
                
                if (status === 'recording') {
                    if (recordBtn) recordBtn.style.display = 'none';
                    if (stopBtn) stopBtn.style.display = 'inline-block';
                } else if (status === 'completed' || status === 'error' || !status) {
                    if (recordBtn) recordBtn.style.display = 'inline-block';
                    if (stopBtn) stopBtn.style.display = 'none';
                }
            }
            
            // ğŸ“ æ–‡å­—èµ·ã“ã—ä¸€è¦§ã‚’è¡¨ç¤º
            async showTranscriptions(meetingId) {
                try {
                    const { data: transcriptions, error } = await supabase
                        .from('meeting_transcripts')
                        .select('*')
                        .eq('meeting_id', meetingId)
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        return;
                    }
                    
                    if (!transcriptions || transcriptions.length === 0) {
                        alert('ğŸ“ ã“ã®ä¼šè­°ã®æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚\n\nã€ŒğŸ™ï¸ éŒ²éŸ³é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰éŒ²éŸ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    this.displayTranscriptionModal(transcriptions);
                    
                } catch (error) {
                    console.error('æ–‡å­—èµ·ã“ã—ä¸€è¦§è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // ğŸ“‹ æ–‡å­—èµ·ã“ã—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            displayTranscriptionModal(transcriptions) {
                const modal = document.createElement('div');
                modal.id = 'transcriptionModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex;
                    justify-content: center; align-items: center;
                    z-index: 10000; overflow-y: auto;
                `;
                
                let transcriptionsHtml = '';
                transcriptions.forEach((transcript, index) => {
                    const date = new Date(transcript.created_at).toLocaleString('ja-JP');
                    const duration = transcript.duration ? transcript.duration + 'ç§’' : '-';
                    const confidence = transcript.confidence ? (transcript.confidence * 100).toFixed(1) + '%' : '-';
                    
                    transcriptionsHtml += `
                        <div id="transcript-${transcript.id}" style="background: ${index % 2 === 0 ? '#f8f9fa' : '#ffffff'}; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; font-size: 16px; color: #2c3e50;">ğŸ“ æ–‡å­—èµ·ã“ã— ${index + 1}</h4>
                                    <p style="margin: 0; font-size: 13px; color: #7f8c8d;">ä½œæˆæ—¥æ™‚: ${date} | éŒ²éŸ³æ™‚é–“: ${duration} | èªè­˜ç²¾åº¦: ${confidence}</p>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${transcript.audio_url ? '<a href="' + transcript.audio_url + '" target="_blank" style="padding: 6px 12px; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: 600;">ğŸ”Š éŸ³å£°ã‚’èã</a>' : ''}
                                    <button onclick="window.transcriptionSystem.saveAsTextFile('${transcript.id}', '${transcript.meeting_id}')" style="padding: 6px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">ğŸ’¾ ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜</button>
                                    <button onclick="window.transcriptionSystem.editTranscription('${transcript.id}')" style="padding: 6px 12px; background: #f39c12; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">âœï¸ ç·¨é›†</button>
                                    <button onclick="window.transcriptionSystem.deleteTranscription('${transcript.id}')" style="padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">ğŸ—‘ï¸ å‰Šé™¤</button>
                                </div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #3498db; margin-bottom: 15px;">
                                <h5 style="margin: 0 0 10px 0; font-size: 14px; color: #34495e; font-weight: 600;">ğŸ“„ æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆ</h5>
                                <div id="text-view-${transcript.id}" style="margin: 0; font-size: 14px; line-height: 1.8; color: #2c3e50; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${transcript.full_text || 'ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãªã—ï¼‰'}</div>
                                <textarea id="text-edit-${transcript.id}" style="display: none; width: 100%; min-height: 150px; font-size: 14px; line-height: 1.8; color: #2c3e50; border: 2px solid #3498db; border-radius: 4px; padding: 10px; font-family: inherit;">${transcript.full_text || ''}</textarea>
                            </div>
                            <div id="edit-actions-${transcript.id}" style="display: none; margin-top: 15px; text-align: right;">
                                <button onclick="window.transcriptionSystem.cancelEdit('${transcript.id}')" style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; margin-right: 8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <button onclick="window.transcriptionSystem.saveEdit('${transcript.id}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ’¾ ä¿å­˜</button>
                            </div>
                        </div>
                    `;
                });
                
                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #3498db; padding-bottom: 15px;">
                            <h2 style="margin: 0; font-size: 24px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 28px;">ğŸ“</span>æ–‡å­—èµ·ã“ã—ä¸€è¦§
                            </h2>
                            <button onclick="document.getElementById('transcriptionModal').remove()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700;">âœ•</button>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 13px; color: #856404;">
                                <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã¯ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚ç·¨é›†å¾Œã¯å¿…ãšã€ŒğŸ’¾ ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
                            </p>
                        </div>
                        ${transcriptionsHtml}
                        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                            <button onclick="document.getElementById('transcriptionModal').remove()" style="padding: 10px 24px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
            editTranscription(transcriptId) {
                const textView = document.getElementById(`text-view-${transcriptId}`);
                const textEdit = document.getElementById(`text-edit-${transcriptId}`);
                const editActions = document.getElementById(`edit-actions-${transcriptId}`);
                
                if (textView) textView.style.display = 'none';
                if (textEdit) textEdit.style.display = 'block';
                if (editActions) editActions.style.display = 'block';
            }
            
            // âŒ ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            cancelEdit(transcriptId) {
                const textView = document.getElementById(`text-view-${transcriptId}`);
                const textEdit = document.getElementById(`text-edit-${transcriptId}`);
                const editActions = document.getElementById(`edit-actions-${transcriptId}`);
                
                if (textView) textView.style.display = 'block';
                if (textEdit) textEdit.style.display = 'none';
                if (editActions) editActions.style.display = 'none';
            }
            
            // ğŸ’¾ ç·¨é›†ã‚’ä¿å­˜
            async saveEdit(transcriptId) {
                const textEdit = document.getElementById(`text-edit-${transcriptId}`);
                
                const updatedText = textEdit ? textEdit.value : null;
                
                try {
                    const updateData = {};
                    if (updatedText !== null) updateData.full_text = updatedText;
                    
                    const { error } = await supabase
                        .from('meeting_transcripts')
                        .update(updateData)
                        .eq('id', transcriptId);
                    
                    if (error) {
                        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                        return;
                    }
                    
                    // è¡¨ç¤ºã‚’æ›´æ–°
                    const textView = document.getElementById(`text-view-${transcriptId}`);
                    
                    if (textView && updatedText !== null) textView.textContent = updatedText;
                    
                    this.cancelEdit(transcriptId);
                    alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
                    
                } catch (error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // ğŸ—‘ï¸ å‰Šé™¤
            async deleteTranscription(transcriptId) {
                if (!confirm('â“ ã“ã®æ–‡å­—èµ·ã“ã—ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nâ€» ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from('meeting_transcripts')
                        .delete()
                        .eq('id', transcriptId);
                    
                    if (error) {
                        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                        return;
                    }
                    
                    // DOM ã‹ã‚‰å‰Šé™¤
                    const element = document.getElementById(`transcript-${transcriptId}`);
                    if (element) {
                        element.style.transition = 'opacity 0.3s, transform 0.3s';
                        element.style.opacity = '0';
                        element.style.transform = 'translateX(-20px)';
                        setTimeout(() => element.remove(), 300);
                    }
                    
                    alert('âœ… å‰Šé™¤ã—ã¾ã—ãŸï¼');
                    
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // ğŸ’¾ ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ï¼ˆè­°äº‹éŒ²ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ï¼‰
            async saveAsTextFile(transcriptId, meetingId) {
                try {
                    // æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const { data: transcript, error } = await supabase
                        .from('meeting_transcripts')
                        .select('*')
                        .eq('id', transcriptId)
                        .single();
                    
                    if (error || !transcript) {
                        alert('âŒ æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        return;
                    }
                    
                    // ã“ã®ä¼šè­°ã®è­°äº‹éŒ²ã‚’å–å¾—
                    const minutes = window.app.minutesData[meetingId] || [];
                    
                    // è­°äº‹éŒ²ãŒ0ä»¶ã®å ´åˆã¯ã€ç›´æ¥æ–°è¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    if (minutes.length === 0) {
                        this.showCreateNewMinuteForm(transcript, meetingId);
                        return;
                    }
                    
                    // é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                    this.showMinuteSelectionDialog(transcript, meetingId, minutes);
                    
                } catch (error) {
                    console.error('ãƒ†ã‚­ã‚¹ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // ğŸ“‹ è­°äº‹éŒ²é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            showMinuteSelectionDialog(transcript, meetingId, minutes) {
                // æ—¢å­˜ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‰Šé™¤
                const existingDialog = document.getElementById('minuteSelectionDialog');
                if (existingDialog) existingDialog.remove();
                
                // æœ€æ–°é †ã«ã‚½ãƒ¼ãƒˆ
                const sortedMinutes = [...minutes].sort((a, b) => {
                    const dateA = new Date(a.meetingDate || a.created || 0);
                    const dateB = new Date(b.meetingDate || b.created || 0);
                    return dateB - dateA;
                });
                
                // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
                const dialog = document.createElement('div');
                dialog.id = 'minuteSelectionDialog';
                dialog.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex;
                    justify-content: center; align-items: center;
                    z-index: 10001;
                `;
                
                // è­°äº‹éŒ²ãƒªã‚¹ãƒˆã®HTML
                let minutesListHtml = '';
                sortedMinutes.forEach((minute, index) => {
                    const date = minute.meetingDate || '-';
                    const subtitle = minute.subtitle || 'ï¼ˆã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰';
                    const facilitator = minute.facilitator || 'ï¼ˆæœªè¨­å®šï¼‰';
                    const isLatest = index === 0;
                    
                    minutesListHtml += `
                        <label style="display: block; padding: 15px; margin-bottom: 10px; background: white; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#3498db'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#ddd'; this.style.boxShadow='none'">
                            <input type="radio" name="minuteSelection" value="${minute.id}" ${isLatest ? 'checked' : ''} style="margin-right: 10px;">
                            <strong style="font-size: 15px; color: #2c3e50;">ğŸ“‹ ${subtitle}</strong>
                            ${isLatest ? '<span style="color: #27ae60; font-weight: 600; margin-left: 8px;">â† æœ€æ–°ï¼ˆæ¨å¥¨ï¼‰</span>' : ''}
                            <div style="margin-top: 8px; font-size: 13px; color: #7f8c8d; line-height: 1.6;">
                                <div>ğŸ“… ä¼šè­°æ—¥: ${date}</div>
                                <div>ğŸ‘¤ ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼: ${facilitator}</div>
                            </div>
                        </label>
                    `;
                });
                
                dialog.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 15px;">
                            <h2 style="margin: 0; font-size: 20px; color: #2c3e50;">ğŸ’¾ æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã®ä¿å­˜å…ˆã‚’é¸æŠ</h2>
                            <button onclick="document.getElementById('minuteSelectionDialog').remove()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 18px; cursor: pointer; font-weight: 700;">âœ•</button>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 13px; color: #1565c0;">
                                ğŸ“Š ã“ã®ä¼šè­°ã«ã¯ <strong>${minutes.length}ä»¶ã®è­°äº‹éŒ²</strong>ãŒã‚ã‚Šã¾ã™
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; padding: 15px; margin-bottom: 15px; background: #e8f5e9; border: 2px solid #27ae60; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="minuteSelection" value="new" style="margin-right: 10px;">
                                <strong style="font-size: 15px; color: #27ae60;">ğŸ“ æ–°è¦è­°äº‹éŒ²ã‚’ä½œæˆã—ã¦ä¿å­˜</strong>
                                <div style="margin-top: 5px; font-size: 12px; color: #2e7d32;">æ–°ã—ã„è­°äº‹éŒ²ã‚’ä½œæˆã—ã€ãã“ã«ä¿å­˜ã—ã¾ã™</div>
                            </label>
                            
                            <div style="margin-bottom: 10px; font-size: 14px; font-weight: 600; color: #34495e;">ğŸ“‹ æ—¢å­˜ã®è­°äº‹éŒ²ã‹ã‚‰é¸æŠ:</div>
                            <div style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
                                ${minutesListHtml}
                            </div>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 12px; color: #856404;">
                                ğŸ’¡ æœ€æ–°ã®è­°äº‹éŒ²ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦æ–°è¦ä½œæˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                            </p>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button onclick="document.getElementById('minuteSelectionDialog').remove()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="window.transcriptionSystem.saveToSelectedMinute('${transcript.id}', '${meetingId}')" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ğŸ’¾ ä¿å­˜</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
            }
            
            // ğŸ’¾ é¸æŠã—ãŸè­°äº‹éŒ²ã«ä¿å­˜
            async saveToSelectedMinute(transcriptId, meetingId) {
                const selected = document.querySelector('input[name="minuteSelection"]:checked');
                if (!selected) {
                    alert('âŒ ä¿å­˜å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                
                // æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const { data: transcript, error } = await supabase
                    .from('meeting_transcripts')
                    .select('*')
                    .eq('id', transcriptId)
                    .single();
                
                if (error || !transcript) {
                    alert('âŒ æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                if (selected.value === 'new') {
                    // æ–°è¦ä½œæˆ
                    document.getElementById('minuteSelectionDialog').remove();
                    this.showCreateNewMinuteForm(transcript, meetingId);
                } else {
                    // æ—¢å­˜ã®è­°äº‹éŒ²ã«ä¿å­˜
                    const minuteId = selected.value;
                    const minutes = window.app.minutesData[meetingId] || [];
                    const targetMinute = minutes.find(m => m.id === minuteId);
                    
                    if (!targetMinute) {
                        alert('âŒ è­°äº‹éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return;
                    }
                    
                    await this.saveTextFileToMinute(transcript, targetMinute);
                    document.getElementById('minuteSelectionDialog').remove();
                }
            }
            
            // ğŸ“ æ–°è¦è­°äº‹éŒ²ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            showCreateNewMinuteForm(transcript, meetingId) {
                // æ—¢å­˜ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‰Šé™¤
                const existingDialog = document.getElementById('createMinuteDialog');
                if (existingDialog) existingDialog.remove();
                
                const dialog = document.createElement('div');
                dialog.id = 'createMinuteDialog';
                dialog.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex;
                    justify-content: center; align-items: center;
                    z-index: 10001;
                `;
                
                const today = new Date().toISOString().split('T')[0];
                
                dialog.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #27ae60; padding-bottom: 15px;">
                            <h2 style="margin: 0; font-size: 20px; color: #2c3e50;">ğŸ“ æ–°è¦è­°äº‹éŒ²ã‚’ä½œæˆ</h2>
                            <button onclick="document.getElementById('createMinuteDialog').remove()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 18px; cursor: pointer; font-weight: 700;">âœ•</button>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 13px; color: #2e7d32;">
                                ğŸ’¡ è­°äº‹éŒ²ã‚’ä½œæˆã—ã€æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’æ·»ä»˜ã—ã¾ã™
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #2c3e50;">
                                ğŸ“… ä¼šè­°æ—¥ <span style="color: #e74c3c;">*</span>
                            </label>
                            <input type="date" id="newMinuteMeetingDate" value="${today}" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                            <button onclick="document.getElementById('createMinuteDialog').remove()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="window.transcriptionSystem.createMinuteAndSave('${transcript.id}', '${meetingId}')" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ä½œæˆã—ã¦ä¿å­˜</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
            }
            
            // ğŸ“ è­°äº‹éŒ²ã‚’ä½œæˆã—ã¦ä¿å­˜
            async createMinuteAndSave(transcriptId, meetingId) {
                const meetingDate = document.getElementById('newMinuteMeetingDate').value;
                
                if (!meetingDate) {
                    alert('âŒ ä¼šè­°æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                // æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const { data: transcript, error } = await supabase
                    .from('meeting_transcripts')
                    .select('*')
                    .eq('id', transcriptId)
                    .single();
                
                if (error || !transcript) {
                    alert('âŒ æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                // æ–°è¦è­°äº‹éŒ²ã‚’ä½œæˆ
                const newMinute = {
                    id: 'minute-' + Date.now(),
                    meetingDate: meetingDate,
                    subtitle: 'æ–‡å­—èµ·ã“ã—ã‹ã‚‰ä½œæˆ',
                    facilitator: '',
                    participants: '',
                    remarks: '',
                    status: 'pending',
                    detailRows: [],
                    attachedFiles: [],
                    created: new Date().toISOString()
                };
                
                // minutesData ã«è¿½åŠ 
                if (!window.app.minutesData[meetingId]) {
                    window.app.minutesData[meetingId] = [];
                }
                window.app.minutesData[meetingId].push(newMinute);
                
                // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
                await this.saveTextFileToMinute(transcript, newMinute);
                
                // localStorage ã«ä¿å­˜
                window.app.saveToLocalStorage();
                
                // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
                document.getElementById('createMinuteDialog').remove();
                
                // ç”»é¢ã‚’æ›´æ–°
                if (window.app.showMeetingView) {
                    window.app.showMeetingView(meetingId);
                }
            }
            
            // ğŸ’¾ ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è­°äº‹éŒ²ã«ä¿å­˜ï¼ˆå…±é€šå‡¦ç†ï¼‰
            async saveTextFileToMinute(transcript, targetMinute) {
                // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
                const fileName = `æ–‡å­—èµ·ã“ã—_${new Date(transcript.created_at).toLocaleString('ja-JP').replace(/[/:]/g, '-')}.txt`;
                const textContent = `æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆ
ä½œæˆæ—¥æ™‚: ${new Date(transcript.created_at).toLocaleString('ja-JP')}
éŒ²éŸ³æ™‚é–“: ${transcript.duration || '-'}ç§’
èªè­˜ç²¾åº¦: ${transcript.confidence ? (transcript.confidence * 100).toFixed(1) + '%' : '-'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${transcript.full_text || 'ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãªã—ï¼‰'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

`;
                
                // Blob ã‚’ä½œæˆ
                const blob = new Blob([textContent], { type: 'text/plain; charset=utf-8' });
                
                // FileReader ã§ Data URL ã«å¤‰æ›
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // attachedFiles ã«è¿½åŠ 
                        if (!targetMinute.attachedFiles) {
                            targetMinute.attachedFiles = [];
                        }
                        
                        targetMinute.attachedFiles.push({
                            name: fileName,
                            size: blob.size,
                            type: 'text/plain',
                            url: e.target.result,
                            uploadDate: new Date().toISOString()
                        });
                        
                        // localStorage ã«ä¿å­˜
                        window.app.saveToLocalStorage();
                        
                        // ç”»é¢ã‚’æ›´æ–°
                        if (window.app.currentMinute && window.app.currentMinute.id === targetMinute.id) {
                            const filesContainer = document.getElementById(`attachedFiles-${targetMinute.id}`);
                            if (filesContainer) {
                                filesContainer.innerHTML = window.app.renderAttachedFiles(targetMinute);
                            }
                        }
                        
                        alert(`âœ… ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è­°äº‹éŒ²ã«ä¿å­˜ã—ã¾ã—ãŸï¼

ğŸ“‹ ä¿å­˜å…ˆè­°äº‹éŒ²:
  è­°äº‹éŒ²å: ${targetMinute.subtitle || 'ï¼ˆã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰'}
  ä¼šè­°æ—¥: ${targetMinute.meetingDate || '-'}

ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileName}

ğŸ’¡ è­°äº‹éŒ²è©³ç´°ç”»é¢ã®ã€ŒğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã€æ¬„ã§ç¢ºèªã§ãã¾ã™ã€‚`);
                        
                        resolve();
                    };
                    
                    reader.onerror = () => {
                        alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                        reject();
                    };
                    
                    reader.readAsDataURL(blob);
                });
            }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        window.transcriptionSystem = new GoogleTranscriptionSystem();
        console.log('âœ… Google Transcription System åˆæœŸåŒ–å®Œäº†');
        
        // App ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« showTranscriptions ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
        if (window.app) {
            window.app.showTranscriptions = function(meetingId) {
                return window.transcriptionSystem.showTranscriptions(meetingId);
            };
        }
        
        // =============================================
        // APIã‚­ãƒ¼è¨­å®šæ©Ÿèƒ½
        // =============================================
        
        function showApiKeySettings() {
            const cloudKey = localStorage.getItem('google_cloud_api_key') || '';
            const geminiKey = localStorage.getItem('gemini_api_key') || '';
            const maskedCloudKey = cloudKey ? cloudKey.substring(0, 10) + '...' : 'æœªè¨­å®š';
            const maskedGeminiKey = geminiKey ? geminiKey.substring(0, 10) + '...' : 'æœªè¨­å®š';
            
            const modal = document.createElement('div');
            modal.id = 'apiKeyModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #2c3e50;">âš™ï¸ Google Cloud API è¨­å®š</h2>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 13px; color: #856404;">
                            <strong>âš ï¸ é‡è¦:</strong> Speech-to-Text API ã¨ Gemini API ã«ã¯<strong>ç•°ãªã‚‹APIã‚­ãƒ¼</strong>ãŒå¿…è¦ã§ã™ã€‚
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <p style="margin: 0 0 5px 0; font-size: 14px; color: #7f8c8d;">
                            ç¾åœ¨ã®è¨­å®š:
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            ğŸ”¹ Google Cloud APIã‚­ãƒ¼: <strong>${maskedCloudKey}</strong>
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            ğŸ”¹ Gemini APIã‚­ãƒ¼: <strong>${maskedGeminiKey}</strong>
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">
                            1ï¸âƒ£ Google Cloud APIã‚­ãƒ¼ (Speech-to-Text ç”¨)
                        </label>
                        <input 
                            type="password" 
                            id="cloudApiKeyInput" 
                            placeholder="AIzaSy... (Google Cloud Console ã§ä½œæˆ)" 
                            value="${cloudKey}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                        >
                        <small style="display: block; margin-top: 8px; color: #7f8c8d;">
                            Google Cloud Console ã§ä½œæˆã—ãŸAPIã‚­ãƒ¼ (gijiroku-transcription ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">
                            2ï¸âƒ£ Gemini APIã‚­ãƒ¼ (AIè¦ç´„ç”¨)
                        </label>
                        <input 
                            type="password" 
                            id="geminiApiKeyInput" 
                            placeholder="AIzaSy... (AI Studio ã§ä½œæˆ)" 
                            value="${geminiKey}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                        >
                        <small style="display: block; margin-top: 8px; color: #7f8c8d;">
                            AI Studio ã§ä½œæˆã—ãŸAPIã‚­ãƒ¼ (https://aistudio.google.com/app/apikey)
                        </small>
                    </div>
                    
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; border-left: 4px solid #27ae60; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #27ae60;">ğŸ“˜ APIã‚­ãƒ¼å–å¾—æ–¹æ³•</h4>
                        <div style="font-size: 13px; color: #555;">
                            <p style="margin: 0 0 10px 0; font-weight: 600;">Google Cloud APIã‚­ãƒ¼:</p>
                            <ol style="margin: 0 0 15px 0; padding-left: 20px;">
                                <li>Google Cloud Console ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                                <li>ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œèªè¨¼æƒ…å ±ã€</li>
                                <li>æ—¢å­˜ã®APIã‚­ãƒ¼ã‚’ä½¿ç”¨</li>
                            </ol>
                            <p style="margin: 0 0 10px 0; font-weight: 600;">Gemini APIã‚­ãƒ¼:</p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>https://aistudio.google.com/app/apikey ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                                <li>ã€ŒGet API keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                                <li>ä½œæˆã—ãŸAPIã‚­ãƒ¼ (ä¾‹: ...jLu0) ã‚’ã‚³ãƒ”ãƒ¼</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button 
                            onclick="closeApiKeyModal()" 
                            style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
                        >
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button 
                            onclick="saveApiKey()" 
                            style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;"
                        >
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function saveApiKey() {
            const cloudInput = document.getElementById('cloudApiKeyInput');
            const geminiInput = document.getElementById('geminiApiKeyInput');
            const cloudKey = cloudInput.value.trim();
            const geminiKey = geminiInput.value.trim();
            
            if (!cloudKey) {
                alert('âŒ Google Cloud APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!geminiKey) {
                alert('âŒ Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!cloudKey.startsWith('AIza') || !geminiKey.startsWith('AIza')) {
                if (!confirm('âš ï¸ Google APIã‚­ãƒ¼ã¯é€šå¸¸ã€ŒAIzaã€ã§å§‹ã¾ã‚Šã¾ã™ã€‚\n\nã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }
            
            window.transcriptionSystem.setApiKey(cloudKey, geminiKey);
            alert('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\néŸ³å£°æ–‡å­—èµ·ã“ã—æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚');
            closeApiKeyModal();
        }
        
        function closeApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.showApiKeySettings = showApiKeySettings;
        window.saveApiKey = saveApiKey;
        window.closeApiKeyModal = closeApiKeyModal;
    </script>
</body>
</html>
